<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡ç‰‡è³‡æ–™æŒä¹…åŒ–æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #00ffff;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .warning { background: #ff9800; color: white; }
        .info { background: #2196F3; color: white; }
        button {
            background: #00ffff;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #00cccc;
        }
        .data-display {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .log {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å¡ç‰‡è³‡æ–™æŒä¹…åŒ–æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h2>
        <div id="systemStatus"></div>
        <button onclick="checkSystemStatus()">ğŸ”„ é‡æ–°æª¢æŸ¥ç³»çµ±ç‹€æ…‹</button>
    </div>

    <div class="test-section">
        <h2>ğŸ’¾ è³‡æ–™æ“ä½œæ¸¬è©¦</h2>
        <button onclick="testAddCard()">â• æ–°å¢æ¸¬è©¦å¡ç‰‡</button>
        <button onclick="testAddShard()">ğŸ’ æ–°å¢æ¸¬è©¦ç¢ç‰‡</button>
        <button onclick="testRemoveShard()">â™»ï¸ ç§»é™¤æ¸¬è©¦ç¢ç‰‡</button>
        <button onclick="testUnlockCard()">ğŸ”“ è§£é–æ¸¬è©¦å¡ç‰‡</button>
        <button onclick="clearTestData()">ğŸ—‘ï¸ æ¸…é™¤æ¸¬è©¦è³‡æ–™</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ ç•¶å‰è³‡æ–™ç‹€æ…‹</h2>
        <button onclick="refreshDataDisplay()">ğŸ”„ é‡æ–°æ•´ç†è³‡æ–™</button>
        <div id="dataDisplay"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ” é™¤éŒ¯æ—¥èªŒ</h2>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
        <div id="debugLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ é é¢é‡æ–°è¼‰å…¥æ¸¬è©¦</h2>
        <button onclick="reloadPage()">ğŸ”„ é‡æ–°è¼‰å…¥é é¢</button>
        <p>é»æ“ŠæŒ‰éˆ•é‡æ–°è¼‰å…¥é é¢ï¼Œæª¢æŸ¥è³‡æ–™æ˜¯å¦æ­£ç¢ºä¿å­˜ã€‚</p>
    </div>

    <script>
        // è¼‰å…¥å¿…è¦çš„è…³æœ¬
        const scripts = [
            'js/userData.js',
            'js/cardStorage.js',
            'js/cardUtils.js'
        ];

        let loadedScripts = 0;
        scripts.forEach(src => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = () => {
                loadedScripts++;
                if (loadedScripts === scripts.length) {
                    initializeTest();
                }
            };
            script.onerror = () => {
                log(`âŒ è¼‰å…¥å¤±æ•—: ${src}`, 'error');
                loadedScripts++;
                if (loadedScripts === scripts.length) {
                    initializeTest();
                }
            };
            document.head.appendChild(script);
        });

        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = '';
        }

        function initializeTest() {
            log('ğŸš€ æ¸¬è©¦ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
            checkSystemStatus();
            refreshDataDisplay();
        }

        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            let status = '';

            // æª¢æŸ¥ LinkageSystem
            if (typeof LinkageSystem !== 'undefined') {
                status += '<div class="status success">âœ… LinkageSystem å·²è¼‰å…¥</div>';
                if (LinkageSystem.cards) {
                    status += '<div class="status success">âœ… LinkageSystem.cards å¯ç”¨</div>';
                } else {
                    status += '<div class="status error">âŒ LinkageSystem.cards ä¸å¯ç”¨</div>';
                }
            } else {
                status += '<div class="status error">âŒ LinkageSystem æœªè¼‰å…¥</div>';
            }

            // æª¢æŸ¥ CardStorage
            if (typeof CardStorage !== 'undefined') {
                status += '<div class="status success">âœ… CardStorage å·²è¼‰å…¥</div>';
            } else {
                status += '<div class="status error">âŒ CardStorage æœªè¼‰å…¥</div>';
            }

            // æª¢æŸ¥ CardSystem
            if (typeof CardSystem !== 'undefined') {
                status += '<div class="status success">âœ… CardSystem å·²è¼‰å…¥</div>';
            } else {
                status += '<div class="status error">âŒ CardSystem æœªè¼‰å…¥</div>';
            }

            // æª¢æŸ¥ localStorage
            try {
                const ownedCards = localStorage.getItem('ownedCards');
                const cardShards = localStorage.getItem('cardShards');
                status += `<div class="status info">ğŸ“Š localStorage ç‹€æ…‹: ownedCards=${ownedCards ? 'å·²å­˜åœ¨' : 'ä¸å­˜åœ¨'}, cardShards=${cardShards ? 'å·²å­˜åœ¨' : 'ä¸å­˜åœ¨'}</div>`;
            } catch (error) {
                status += '<div class="status error">âŒ localStorage å­˜å–å¤±æ•—</div>';
            }

            statusDiv.innerHTML = status;
        }

        function refreshDataDisplay() {
            const displayDiv = document.getElementById('dataDisplay');
            let display = '';

            try {
                // ä½¿ç”¨ LinkageSystem
                if (typeof LinkageSystem !== 'undefined' && LinkageSystem.cards) {
                    const ownedCards = LinkageSystem.cards.getOwnedCards();
                    const shards = LinkageSystem.cards.getShards();
                    
                    display += '=== LinkageSystem è³‡æ–™ ===\n';
                    display += `å·²æ“æœ‰å¡ç‰‡: ${Object.keys(ownedCards).length} å¼µ\n`;
                    display += `ç¢ç‰‡ç¨®é¡: ${Object.keys(shards).length} ç¨®\n`;
                    display += `ç¸½ç¢ç‰‡æ•¸: ${Object.values(shards).reduce((sum, count) => sum + count, 0)} å€‹\n\n`;
                }

                // ä½¿ç”¨ CardStorage
                if (typeof CardStorage !== 'undefined') {
                    const ownedCards = CardStorage.getOwnedCards();
                    const shards = CardStorage.getShards();
                    
                    display += '=== CardStorage è³‡æ–™ ===\n';
                    display += `å·²æ“æœ‰å¡ç‰‡: ${Object.keys(ownedCards).length} å¼µ\n`;
                    display += `ç¢ç‰‡ç¨®é¡: ${Object.keys(shards).length} ç¨®\n`;
                    display += `ç¸½ç¢ç‰‡æ•¸: ${Object.values(shards).reduce((sum, count) => sum + count, 0)} å€‹\n\n`;
                }

                // ç›´æ¥è®€å– localStorage
                const ownedCardsStr = localStorage.getItem('ownedCards');
                const cardShardsStr = localStorage.getItem('cardShards');
                
                display += '=== localStorage åŸå§‹è³‡æ–™ ===\n';
                display += `ownedCards: ${ownedCardsStr || 'null'}\n`;
                display += `cardShards: ${cardShardsStr || 'null'}\n`;

            } catch (error) {
                display += `âŒ è®€å–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}\n`;
            }

            displayDiv.textContent = display;
        }

        function testAddCard() {
            const testCard = 'test_card_' + Date.now();
            log(`ğŸ”„ æ¸¬è©¦æ–°å¢å¡ç‰‡: ${testCard}`);

            // ä½¿ç”¨ LinkageSystem
            if (typeof LinkageSystem !== 'undefined' && LinkageSystem.cards) {
                LinkageSystem.cards.addCard(testCard);
                log(`âœ… LinkageSystem æ–°å¢å¡ç‰‡: ${testCard}`);
            }

            // ä½¿ç”¨ CardStorage
            if (typeof CardStorage !== 'undefined') {
                CardStorage.addCard(testCard);
                log(`âœ… CardStorage æ–°å¢å¡ç‰‡: ${testCard}`);
            }

            // ä½¿ç”¨ CardSystem
            if (typeof CardSystem !== 'undefined') {
                CardSystem.unlockCard(testCard);
                log(`âœ… CardSystem è§£é–å¡ç‰‡: ${testCard}`);
            }

            setTimeout(refreshDataDisplay, 100);
        }

        function testAddShard() {
            const testCard = 'test_shard_' + Date.now();
            log(`ğŸ”„ æ¸¬è©¦æ–°å¢ç¢ç‰‡: ${testCard}`);

            // ä½¿ç”¨ LinkageSystem
            if (typeof LinkageSystem !== 'undefined' && LinkageSystem.cards) {
                LinkageSystem.cards.addShard(testCard, 3);
                log(`âœ… LinkageSystem æ–°å¢ç¢ç‰‡: ${testCard} +3`);
            }

            // ä½¿ç”¨ CardStorage
            if (typeof CardStorage !== 'undefined') {
                CardStorage.addShard(testCard, 3);
                log(`âœ… CardStorage æ–°å¢ç¢ç‰‡: ${testCard} +3`);
            }

            // ä½¿ç”¨ CardSystem
            if (typeof CardSystem !== 'undefined') {
                CardSystem.addShards(testCard, 3);
                log(`âœ… CardSystem æ–°å¢ç¢ç‰‡: ${testCard} +3`);
            }

            setTimeout(refreshDataDisplay, 100);
        }

        function testRemoveShard() {
            const testCard = 'test_shard_remove';
            log(`ğŸ”„ æ¸¬è©¦ç§»é™¤ç¢ç‰‡: ${testCard}`);

            // å…ˆæ·»åŠ ä¸€äº›ç¢ç‰‡
            if (typeof LinkageSystem !== 'undefined' && LinkageSystem.cards) {
                LinkageSystem.cards.addShard(testCard, 5);
                log(`â• å…ˆæ·»åŠ  5 å€‹ç¢ç‰‡`);
                
                // ç„¶å¾Œç§»é™¤ 2 å€‹
                const shards = LinkageSystem.cards.getShards();
                shards[testCard] = Math.max(0, (shards[testCard] || 0) - 2);
                LinkageSystem.cards.setShards(shards);
                log(`âœ… LinkageSystem ç§»é™¤ç¢ç‰‡: ${testCard} -2`);
            }

            setTimeout(refreshDataDisplay, 100);
        }

        function testUnlockCard() {
            const testCard = 'test_unlock_' + Date.now();
            log(`ğŸ”„ æ¸¬è©¦è§£é–å¡ç‰‡: ${testCard}`);

            // ä½¿ç”¨ CardSystem
            if (typeof CardSystem !== 'undefined') {
                CardSystem.unlockCard(testCard);
                log(`âœ… CardSystem è§£é–å¡ç‰‡: ${testCard}`);
            }

            setTimeout(refreshDataDisplay, 100);
        }

        function clearTestData() {
            log('ğŸ”„ æ¸…é™¤æ¸¬è©¦è³‡æ–™');
            
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¸¬è©¦è³‡æ–™å—ï¼Ÿ')) {
                // æ¸…é™¤ localStorage ä¸­çš„æ¸¬è©¦è³‡æ–™
                const ownedCards = JSON.parse(localStorage.getItem('ownedCards') || '{}');
                const cardShards = JSON.parse(localStorage.getItem('cardShards') || '{}');
                
                // ç§»é™¤æ‰€æœ‰ä»¥ 'test_' é–‹é ­çš„è³‡æ–™
                Object.keys(ownedCards).forEach(key => {
                    if (key.startsWith('test_')) {
                        delete ownedCards[key];
                    }
                });
                
                Object.keys(cardShards).forEach(key => {
                    if (key.startsWith('test_')) {
                        delete cardShards[key];
                    }
                });
                
                localStorage.setItem('ownedCards', JSON.stringify(ownedCards));
                localStorage.setItem('cardShards', JSON.stringify(cardShards));
                
                log('âœ… æ¸¬è©¦è³‡æ–™å·²æ¸…é™¤');
                setTimeout(refreshDataDisplay, 100);
            }
        }

        function reloadPage() {
            log('ğŸ”„ é‡æ–°è¼‰å…¥é é¢...');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // ç›£è½ localStorage è®ŠåŒ–
        window.addEventListener('storage', (e) => {
            log(`ğŸ”„ localStorage è®ŠåŒ–: ${e.key} = ${e.newValue}`, 'info');
        });

        // å®šæœŸæª¢æŸ¥è³‡æ–™ä¸€è‡´æ€§
        setInterval(() => {
            if (typeof LinkageSystem !== 'undefined' && typeof CardStorage !== 'undefined') {
                const linkageCards = LinkageSystem.cards.getOwnedCards();
                const storageCards = CardStorage.getOwnedCards();
                const linkageShards = LinkageSystem.cards.getShards();
                const storageShards = CardStorage.getShards();
                
                const cardsMatch = JSON.stringify(linkageCards) === JSON.stringify(storageCards);
                const shardsMatch = JSON.stringify(linkageShards) === JSON.stringify(storageShards);
                
                if (!cardsMatch || !shardsMatch) {
                    log('âš ï¸ è³‡æ–™ä¸ä¸€è‡´æª¢æ¸¬åˆ°ï¼', 'warning');
                    log(`å¡ç‰‡è³‡æ–™åŒ¹é…: ${cardsMatch}`, 'warning');
                    log(`ç¢ç‰‡è³‡æ–™åŒ¹é…: ${shardsMatch}`, 'warning');
                }
            }
        }, 5000);
    </script>
</body>
</html> 