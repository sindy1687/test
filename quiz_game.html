<!-- quiz_game.html âˆ’ å–®å­—é¸æ“‡é¡Œé é¢ -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Cosmic Quiz: Chapter of Choice</title>
  <!-- æ–°å­—é«”ï¼šNoto Sans TC -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="responsive_enhanced.css">
  <style>
    /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
    html {
      overflow-x: hidden;
    }
    
    /* ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½åœ¨è¦–çª—ç¯„åœå…§ */
    * {
      box-sizing: border-box;
      max-width: 100%;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Orbitron', Arial, sans-serif;
      background: linear-gradient(to bottom, #020111 0%, #000010 100%);
      color: #fff;
      min-height: 100vh;
      width: 100%;
      overflow-x: hidden;
    }

    /*-------------------------
      å…¨åŸŸé‡è¨­ & å­—é«”
    -------------------------*/
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Noto Sans TC', 'Inter', 'Source Sans Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
      background: linear-gradient(to bottom, #020111 0%, #000010 100%);
      color: #fff;
      overflow: hidden;
      font-size: 16px; /* è¨­å®šåŸºç¤å­—é«”å¤§å° */
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /*-------------------------
      å·¦ä¸Šè§’ TopBarï¼ˆé¡¯ç¤ºæ˜Ÿæ˜Ÿæ•¸ + è¿”å›ç·¨è¼¯é ï¼‰
    -------------------------*/
    #topBar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(10, 20, 40, 0.85);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 3;
      border-bottom: 2px solid #00ffff;
      box-shadow: 0 0 16px #00ffff;
    }
    #topBar #starsDisplay {
      font-size: 1.3rem;
      color: #ffd700;
      font-weight: bold;
      text-shadow: 0 0 8px #ffd700;
    }
    #topBar .back-btn {
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      border: none;
      color: #000;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 1rem;
      text-decoration: none;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 16px #00ffff;
    }
    #topBar .back-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 24px #00ffff;
    }

    /*-------------------------
      æ˜Ÿç©º Canvas èƒŒæ™¯
    -------------------------*/
    canvas#stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    /*-------------------------
      ä¸»å®¹å™¨
    -------------------------*/
    .container {
      position: relative;
      z-index: 1;
      max-width: 800px;
      margin: 80px auto 40px;
      background: rgba(10, 20, 40, 0.7);
      padding: 24px;
      border-radius: 20px;
      box-shadow: 0 0 32px #00ffff44, 0 0 80px #a259ff22 inset;
      border: 2px solid #00ffff;
      backdrop-filter: blur(8px);
      overflow-y: auto;
      max-height: calc(100vh - 140px);
      line-height: 1.6; /* å¢åŠ å®¹å™¨çš„åŸºç¤è¡Œé«˜ */
    }
    .container h1 {
      color: #00ffff;
      text-align: center;
      text-shadow: 0 0 12px #00ffff, 0 0 32px #a259ff;
      margin-bottom: 20px;
      font-size: 2.2rem;
      font-family: 'Orbitron', sans-serif;
    }
    .container .progress {
      text-align: center;
      font-size: 1.1rem;
      color: #99ccff;
      margin-bottom: 12px;
    }
    
    /*-------------------------
      è¨ˆæ™‚å™¨æ¨£å¼
    -------------------------*/
    .timer-container {
      text-align: center;
      margin-bottom: 20px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      border: 1px solid #00ffff;
      position: relative;
    }
    .timer-container.shake {
      animation: shake 0.5s infinite;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }
    .timer-display {
      font-size: 1.5rem;
      font-weight: bold;
      font-family: 'Orbitron', sans-serif;
      color: #00ffff;
      text-shadow: 0 0 8px #00ffff;
      margin-bottom: 5px;
    }
    .timer-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .timer-progress {
      height: 100%;
      background: linear-gradient(90deg, #00ffff, #a259ff);
      border-radius: 4px;
      transition: width 0.3s ease;
      box-shadow: 0 0 8px #00ffff;
    }
    .timer-warning {
      background: linear-gradient(90deg, #ff6b6b, #ff8e53);
      animation: pulse 1s infinite;
    }
    .timer-danger {
      background: linear-gradient(90deg, #ff4757, #ff3838);
      animation: pulse 0.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    @keyframes flash {
      0%, 100% { background: rgba(0, 0, 0, 0.3); }
      50% { background: rgba(255, 107, 107, 0.3); }
    }
    
    /* è·³éæŒ‰éˆ•æ¨£å¼ */
    .skip-btn {
      display: none;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: linear-gradient(90deg, #ff6b6b, #ff8e53);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 0 8px #ff6b6b;
    }
    .skip-btn:hover {
      background: linear-gradient(90deg, #ff4757, #ff3838);
      box-shadow: 0 0 12px #ff4757;
      transform: translateY(-50%) scale(1.05);
    }
    .skip-btn:active {
      transform: translateY(-50%) scale(0.95);
    }
    
    .container .question-area {
      margin-top: 24px;
    }
    .container .question-area #questionText {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: #cceeff;
      line-height: 1.7;
      text-align: center; /* è®“é¡Œç›®å’Œä¸­æ–‡éƒ½ç½®ä¸­ */
    }
    .container .choices {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap; /* å¼·åˆ¶ä¸æ›è¡Œ */
      justify-content: center;
      gap: 10px; /* ç¸®å°é–“è·ä»¥é©æ‡‰è¢å¹• */
    }
    .container .choices button.choice-btn {
      flex: 1; /* è®“æŒ‰éˆ•å¹³å‡åˆ†é…å¯¬åº¦ */
      /* ç§»é™¤ min-width å’Œ max-width ä»¥å…è¨±è‡ªç”±æ”¶ç¸® */
      background: rgba(10, 30, 50, 0.8);
      color: #cceeff;
      border: 2px solid #00ffff;
      border-radius: 8px;
      padding: 14px 8px; /* èª¿æ•´ padding ä»¥å…æ–‡å­—æº¢å‡º */
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 0 12px #00ffff80;
      transition: all 0.2s ease;
    }
    .container .choices button.choice-btn:hover {
      background: rgba(0, 255, 255, 0.2);
      box-shadow: 0 0 20px #00ffff;
    }
    .container .choices button:disabled {
        background: #555 !important;
        color: #aaa !important;
        border-color: #555 !important;
        cursor: not-allowed;
        box-shadow: none !important;
    }
    .container .choices button.correct {
        background: rgba(46, 204, 113, 0.2);
        color: #2ecc71;
        border-color: #2ecc71;
        box-shadow: 0 0 16px #2ecc71;
    }
    .container .choices button.incorrect {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
        border-color: #e74c3c;
        box-shadow: 0 0 16px #e74c3c;
    }
    .container .feedback {
      margin-top: 20px;
      font-size: 1.1rem;
      min-height: 1.6rem; /* æ”¹ç‚º min-height ä»¥é©æ‡‰å¤šè¡Œå…§å®¹ */
      text-align: center;
      line-height: 1.5; /* å¢åŠ è¡Œé«˜ä»¥æ”¹å–„å¯è®€æ€§ */
    }
    .container .next-btn {
      display: none;
      margin: 20px auto 0;
      background: #f1c40f;
      color: #0b0c10;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      transition: background 0.2s;
    }
    .container .next-btn:hover {
      background: #f39c12;
    }

    /*-------------------------
      Scrollbar for .container
    -------------------------*/
    .container::-webkit-scrollbar {
      width: 10px;
    }
    .container::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
      border-radius: 5px;
    }
    .container::-webkit-scrollbar-thumb {
      background: rgba(69,162,158,0.6);
      border-radius: 5px;
    }
    .container::-webkit-scrollbar-thumb:hover {
      background: rgba(69,162,158,0.8);
    }
    .container {
      scrollbar-width: thin;
      scrollbar-color: rgba(69,162,158,0.6) rgba(0,0,0,0.2);
    }

    /*-------------------------
      Review Modal
    -------------------------*/
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: rgba(10, 20, 40, 0.95);
      margin: 5% auto; /* èª¿æ•´ margin */
      padding: 30px;
      border: 2px solid #00ffff;
      width: 90%;
      max-width: 1000px;
      border-radius: 10px;
      box-shadow: 0 0 32px #00ffff44, 0 0 80px #a259ff22 inset;
      position: relative;
      backdrop-filter: blur(8px);
    }
    .modal-content h2 {
      text-align: center;
      color: #00ffff;
      font-size: 2rem;
      margin-bottom: 25px;
      text-shadow: 0 0 8px #00ffff;
    }
    
    #reviewWordsContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        max-height: 60vh;
        overflow-y: auto;
        padding: 15px;
        margin-bottom: 25px;
        background: #0a192f;
        border-radius: 8px;
    }
    #reviewWordsContainer::-webkit-scrollbar {
        width: 8px;
    }
    #reviewWordsContainer::-webkit-scrollbar-track {
        background: #0a192f;
    }
    #reviewWordsContainer::-webkit-scrollbar-thumb {
        background-color: #00ffff;
        border-radius: 4px;
    }

    .word-item {
        background: #112240;
        padding: 15px 20px;
        border-radius: 6px;
        border-left: 4px solid #00ffff;
      color: #8892b0;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .word-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    .word-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .word-header h3 {
      color: #ccd6f6;
        font-size: 1.3rem;
        margin-right: 10px;
      font-weight: 500;
    }
    .pronounce-btn {
      background: none;
      border: none;
      cursor: pointer;
        font-size: 1.4rem;
      color: #00ffff;
        transition: color 0.2s;
        padding: 5px;
    }
    .pronounce-btn:hover {
        color: #fff;
    }
    .word-item p {
        font-size: 1rem;
        line-height: 1.5;
    }

    #continueQuizBtn {
      display: block;
      width: fit-content;
      margin: 25px auto 0;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #0a192f;
      padding: 12px 35px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 500;
      box-shadow: 0 0 16px #00ffff;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #continueQuizBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 24px #00ffff;
    }
    
    .close-btn {
      position: absolute;
      top: 15px;
      right: 25px;
      color: #00ffff;
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
    }
    .close-btn:hover,
    .close-btn:focus {
        color: #fff;
        text-decoration: none;
    }

    /* çµæŸç•«é¢æ¨£å¼ */
    #endScreen {
      display: none;
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
    }
    #endScreen h2 {
      font-size: 2.5rem;
      color: #66fcf1;
      margin-bottom: 20px;
    }
    #endScreen p {
      font-size: 1.5rem;
      margin-bottom: 30px;
    }
    #endScreen button {
      background: #45a29e;
      color: #0b0c10;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      margin: 0 10px;
      transition: background 0.2s;
    }
    #endScreen button:hover {
      background: #66fcf1;
    }

    /*-------------------------
      æ˜Ÿæ˜Ÿé£„å‹•å‹•ç•«
    -------------------------*/
    .floating-star {
      position: fixed;
      font-size: 2rem;
      color: #ffd700;
      text-shadow: 0 0 10px #ffd700;
      pointer-events: none;
      z-index: 1000;
      animation: starFloat 1.5s ease-out forwards;
    }
    
    @keyframes starFloat {
      0% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.2);
      }
      100% {
        opacity: 0;
        transform: scale(0.5) translate(var(--target-x), var(--target-y));
      }
    }
    
    .stars-count-animation {
      animation: countBounce 0.6s ease-out;
    }
    
    @keyframes countBounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <!-- å·¦ä¸Šè§’ TopBarï¼šé¡¯ç¤ºæ˜Ÿæ˜Ÿæ•¸ + è¿”å›ç·¨è¼¯é é¢ -->
  <div id="topBar">
    <div id="starsDisplay">â­<span id="totalStarsCount">0</span></div>
    <div id="currentEarnedStars" style="display: none; color: #ffd700; font-size: 1.1rem; margin-left: 15px;">
      æœ¬è¼ªç²å¾—: <span id="earnedStarsCount">0</span>â­
    </div>
    <a href="#" id="backToBook" class="back-btn">â¬… è¿”å›ç·¨è¼¯å–®å­—æœ¬</a>
  </div>

  <!-- æ˜Ÿç©º Canvas -->
  <canvas id="stars"></canvas>

  <!-- ä¸»å®¹å™¨ï¼šå–®å­—é¸æ“‡é¡Œå…§å®¹ -->
  <div class="container">
    <h1 id="modeTitle">å–®å­—é¸æ“‡é¡Œ</h1>
    <!-- é€²åº¦é¡¯ç¤º -->
    <p class="progress">
      ç¬¬ <span id="currentIdx">1</span> é¡Œ ï¼ å…± <span id="totalCount">0</span> é¡Œ
    </p>
    
    <!-- è¨ˆæ™‚å™¨ -->
    <div class="timer-container">
      <div class="timer-display" id="timerDisplay">10</div>
      <div class="timer-bar">
        <div class="timer-progress" id="timerProgress"></div>
      </div>
      <button class="skip-btn">è·³é</button>
    </div>
    
    <div class="question-area">
      <!-- é¡¯ç¤ºã€Œä¾‹å¥ä¸­æŒ–ç©ºã€çš„é¡Œç›® -->
      <div id="questionText">è¼‰å…¥ä¸­â€¦</div>
      <!-- å››å€‹æŒ‰éˆ•æ°´å¹³æ’åˆ— -->
      <div class="choices" id="choices"></div>
      <div class="feedback" id="feedback"></div>
    </div>
  </div>

  <!-- å–®é¡Œè¤‡ç¿’å½ˆçª— -->
  <div id="reviewModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeModalBtn">&times;</span>
      <h2 id="reviewModalTitle">å–®å­—è¤‡ç¿’</h2>
      <div id="reviewWordsContainer">
        <!-- Word will be dynamically inserted here -->
      </div>
      <button id="continueQuizBtn">ä¸‹ä¸€é¡Œ</button>
    </div>
  </div>

  <script src="js/sound.js"></script>
  <script src="js/starRewardSystem.js"></script>
  <script>
    /*----------------------------------------
      (1) è®€å– URL åƒæ•¸ï¼šbook, mode
    ----------------------------------------*/
    const params = new URLSearchParams(location.search);
    const bookName = params.get('book');
    const mode = params.get('mode'); // 'meaning-to-word' æˆ– 'word-to-meaning'
    if (!bookName || !mode) {
      alert('åƒæ•¸éŒ¯èª¤ï¼šç¼ºå°‘ book æˆ– modeã€‚');
      history.back();
    }

    // è¨­å®šã€Œè¿”å›ã€æŒ‰éˆ•çš„é€£çµ
    document.getElementById('backToBook').href = `book_edit.html?book=${encodeURIComponent(bookName)}`;

    // é¡¯ç¤ºæ¸¬é©—æ¨¡å¼æ¨™é¡Œ
    const modeTitleMap = {
      'meaning-to-word': 'Cosmic Clues: Meaning to Word',
      'word-to-meaning': 'Decoding the Cosmos: Word to Meaning'
    };
    if (!modeTitleMap[mode]) {
      alert('mode åƒæ•¸éŒ¯èª¤ã€‚');
      history.back();
    }
    document.getElementById('modeTitle').textContent = modeTitleMap[mode];

    /*----------------------------------------
      (2) è®€å–å–®å­—æœ¬å…§å®¹
    ----------------------------------------*/
    const storageKey = 'book_' + bookName;
    let vocab = [];
    try {
        const vocabData = localStorage.getItem(storageKey);
        // åƒ…åœ¨æœ‰è³‡æ–™æ™‚æ‰è§£æ
        if (vocabData) {
            vocab = JSON.parse(vocabData);
        }
        console.log(`[DEBUG] æˆåŠŸè®€å–å–®å­—æœ¬ '${bookName}'ï¼Œå…± ${vocab.length} ç­†å–®å­—ã€‚`);
    } catch (e) {
        console.error(`[DEBUG] è§£æå–®å­—æœ¬ '${bookName}' çš„ JSON è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:`, e);
        alert(`è®€å–å–®å­—æœ¬ '${bookName}' å¤±æ•—ï¼Œè³‡æ–™å¯èƒ½å·²ææ¯€æˆ–éæ¨™æº– JSON æ ¼å¼ã€‚è«‹åˆ°ç·¨è¼¯é é¢é‡æ–°å„²å­˜ä¸€æ¬¡ï¼Œæˆ–æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤ã€‚`);
        // ç‚ºäº†åµéŒ¯ï¼Œæš«ä¸è·³è½‰
        // location.href = `book_edit.html?book=${encodeURIComponent(bookName)}`;
    }

    if (!Array.isArray(vocab) || vocab.length < 4) {
      alert('æ­¤å–®å­—æœ¬è‡³å°‘éœ€è¦ 4 ç­†ä»¥ä¸Šå–®å­—æ‰èƒ½é€²è¡Œæ¸¬é©—ã€‚');
      location.href = `book_edit.html?book=${encodeURIComponent(bookName)}`;
    }

    // ----------- è‡ªå‹•åˆ†ç´šä¸¦æ··åˆå‡ºé¡Œ -------------
    function autoLevelVocab(vocab, totalCount = 20) {
      // åˆ†ç´š
      const easy = vocab.filter(v => v.word.length <= 4);
      const hard = vocab.filter(v => v.word.length >= 7);
      const medium = vocab.filter(v => v.word.length > 4 && v.word.length < 7);
      // æ±ºå®šå„ç´šæ•¸é‡
      let easyCount = Math.round(totalCount * 0.4);
      let mediumCount = Math.round(totalCount * 0.4);
      let hardCount = totalCount - easyCount - mediumCount;
      // éš¨æ©ŸæŠ½å–
      function pick(arr, n) {
        const copy = arr.slice();
        for (let i = copy.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy.slice(0, n);
      }
      let result = [];
      result = result.concat(pick(easy, easyCount));
      result = result.concat(pick(medium, mediumCount));
      result = result.concat(pick(hard, hardCount));
      // è‹¥ä¸è¶³å‰‡è£œé½Š
      const used = new Set(result.map(v => v.word));
      const left = vocab.filter(v => !used.has(v.word));
      while (result.length < Math.min(totalCount, vocab.length) && left.length > 0) {
        result.push(left.pop());
      }
      // æœ€å¾Œå†æ´—ç‰Œ
      for (let i = result.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [result[i], result[j]] = [result[j], result[i]];
      }
      return result;
    }

    // å–é¡Œæ•¸ä¸Šé™ 20
    vocab = autoLevelVocab(vocab, Math.min(20, vocab.length));

    const totalCount = vocab.length;
    let currentIdx = 0; // å¾ 0 é–‹å§‹
    let earnedStars = 0; // æ–°å¢ï¼šè¿½è¹¤æ¸¬é©—æœŸé–“ç²å¾—çš„æ˜Ÿæ˜Ÿ

    // æ›´æ–°é€²åº¦æ–‡å­—
    const currentIdxEl = document.getElementById('currentIdx');
    const totalCountEl = document.getElementById('totalCount');
    totalCountEl.textContent = totalCount;

    /*----------------------------------------
      (3) è¨ˆæ™‚å™¨ç³»çµ±
    ----------------------------------------*/
    const TIMER_DURATION = 10; // æ¯é¡Œ10ç§’
    let timerInterval;
    let timeLeft;
    let timerDisplay = document.getElementById('timerDisplay');
    let timerProgress = document.getElementById('timerProgress');
    let skipBtn = document.querySelector('.skip-btn');
    
    function startTimer() {
      timeLeft = TIMER_DURATION;
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          handleTimeUp();
        }
      }, 1000);
    }
    
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }
    
    function updateTimerDisplay() {
      timerDisplay.textContent = timeLeft;
      
      const progressPercent = (timeLeft / TIMER_DURATION) * 100;
      timerProgress.style.width = progressPercent + '%';
      
      // æ ¹æ“šå‰©é¤˜æ™‚é–“æ”¹è®Šé¡è‰²å’Œæ•ˆæœ
      timerProgress.className = 'timer-progress';
      const timerContainer = document.querySelector('.timer-container');
      
      // åœ¨10ç§’æ™‚é¡¯ç¤ºè·³éæŒ‰éˆ•
      if (timeLeft <= 10) {
        skipBtn.style.display = 'block';
      } else {
        skipBtn.style.display = 'none';
      }
      
      if (timeLeft <= 5) {
        timerProgress.classList.add('timer-danger');
        timerContainer.classList.add('shake');
      } else if (timeLeft <= 7) {
        timerProgress.classList.add('timer-warning');
        timerContainer.classList.remove('shake');
      } else {
        timerContainer.classList.remove('shake');
      }
    }
    
    function handleTimeUp() {
      if (answered) return; // å¦‚æœå·²ç¶“å›ç­”éäº†ï¼Œå°±ä¸è™•ç†
      
      // æ’­æ”¾æ™‚é–“åˆ°çš„éŸ³æ•ˆ
      const wrongSound = new Audio('sound/wrong.mp3');
      wrongSound.currentTime = 0;
      wrongSound.play();
      
      // æ·»åŠ æ™‚é–“åˆ°çš„è¦–è¦ºæ•ˆæœ
      const timerContainer = document.querySelector('.timer-container');
      timerContainer.style.animation = 'flash 0.3s 3';
      
      // è‡ªå‹•é¸æ“‡éŒ¯èª¤ç­”æ¡ˆï¼ˆç¬¬ä¸€å€‹é¸é …ï¼‰
      handleChoice(0);
      
      // é¡¯ç¤ºæ™‚é–“åˆ°çš„æç¤º
      const feedbackEl = document.getElementById('feedback');
      feedbackEl.innerHTML = '<span style="font-size: 1.3rem; color: #ff6b6b; font-weight: bold;">â° æ™‚é–“åˆ°ï¼</span>';
      feedbackEl.style.color = '#ff6b6b';
    }
    
    // è·³éæŒ‰éˆ•é»æ“Šäº‹ä»¶
    function handleSkip() {
      if (answered) return; // å¦‚æœå·²ç¶“å›ç­”éäº†ï¼Œå°±ä¸è™•ç†
      
      // æ’­æ”¾è·³ééŸ³æ•ˆ
      const skipSound = new Audio('sound/click.mp3');
      skipSound.currentTime = 0;
      skipSound.play();
      
      // é¡¯ç¤ºè·³éæç¤º
      const feedbackEl = document.getElementById('feedback');
      feedbackEl.innerHTML = '<span style="font-size: 1.3rem; color: #ff8e53; font-weight: bold;">â­ï¸ å·²è·³éæ­¤é¡Œ</span>';
      feedbackEl.style.color = '#ff8e53';
      
      // åœæ­¢è¨ˆæ™‚å™¨
      stopTimer();
      
      // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
      const allChoiceBtns = document.querySelectorAll('.choice-btn');
      allChoiceBtns.forEach(btn => {
        btn.disabled = true;
      });
      
      // æ¨™ç¤ºæ­£ç¢ºç­”æ¡ˆ
      const correctBtn = Array.from(allChoiceBtns).find(btn => choices[btn.dataset.index].isCorrect);
      if(correctBtn) correctBtn.classList.add('correct');
      
      // å¿µå‡ºæ­£ç¢ºç­”æ¡ˆ
      const correctText = choices.find(c => c.isCorrect).text;
      if (correctText && currentQuestion.example) {
        speak(correctText, () => speak(currentQuestion.example, () => {
          setTimeout(goToNextStep, 500);
        }));
      } else if (correctText) {
        speak(correctText, () => {
          setTimeout(goToNextStep, 500);
        });
      } else {
        setTimeout(goToNextStep, 500);
      }
    }

    /*----------------------------------------
      (4) æ˜Ÿç©ºèƒŒæ™¯å‹•ç•«
    ----------------------------------------*/
    const canvas = document.getElementById('stars');
    const ctx = canvas.getContext('2d');
    let W, H;
    let stars = [];
    const numStars = 100;

    function initCanvas() {
      W = window.innerWidth;
      H = window.innerHeight;
      canvas.width = W;
      canvas.height = H;
      stars = [];
      for (let i = 0; i < numStars; i++) {
        stars.push({
          x: Math.random() * W,
          y: Math.random() * H,
          size: Math.random() * 1.5 + 0.5,
          speed: Math.random() * 0.5 + 0.2
        });
      }
    }
    function updateStars() {
      stars.forEach(s => {
        s.y += s.speed;
        if (s.y > H) {
          s.y = 0;
          s.x = Math.random() * W;
        }
      });
    }
    function drawStars() {
      ctx.clearRect(0, 0, W, H);
      ctx.fillStyle = '#ffffff';
      stars.forEach(s => {
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
        ctx.fill();
      });
    }
    function animate() {
      updateStars();
      drawStars();
      requestAnimationFrame(animate);
    }
    window.addEventListener('resize', initCanvas);

    /*----------------------------------------
      (5) é¡¯ç¤ºæ˜Ÿæ˜Ÿæ•¸
    ----------------------------------------*/
    function loadTotalStars() {
      const v = localStorage.getItem('totalStars');
      return v ? parseInt(v, 10) : 0;
    }
    function updateStarsDisplay() {
      document.getElementById('totalStarsCount').textContent = loadTotalStars();
    }
    
    function updateCurrentEarnedStars() {
      const currentEarnedEl = document.getElementById('currentEarnedStars');
      const earnedCountEl = document.getElementById('earnedStarsCount');
      
      if (earnedStars > 0) {
        currentEarnedEl.style.display = 'block';
        earnedCountEl.textContent = earnedStars;
      } else {
        currentEarnedEl.style.display = 'none';
      }
    }

    /*----------------------------------------
      (5.5) æ˜Ÿæ˜Ÿé£„å‹•å‹•ç•«ç³»çµ±
    ----------------------------------------*/
    function createFloatingStar(startX, startY, targetX, targetY) {
      const star = document.createElement('div');
      star.className = 'floating-star';
      star.textContent = 'â­';
      star.style.left = startX + 'px';
      star.style.top = startY + 'px';
      star.style.setProperty('--target-x', (targetX - startX) + 'px');
      star.style.setProperty('--target-y', (targetY - startY) + 'px');
      
      document.body.appendChild(star);
      
      // å‹•ç•«çµæŸå¾Œç§»é™¤å…ƒç´ 
      setTimeout(() => {
        if (star.parentNode) {
          star.parentNode.removeChild(star);
        }
      }, 1500);
    }
    
    function animateStarsCollection() {
      if (earnedStars <= 0) return;
      
      const starsDisplay = document.getElementById('totalStarsCount');
      const rect = starsDisplay.getBoundingClientRect();
      const targetX = rect.left + rect.width / 2;
      const targetY = rect.top + rect.height / 2;
      
      // å‰µå»ºå¤šå€‹æ˜Ÿæ˜Ÿå¾ä¸åŒä½ç½®é£„å‘ç›®æ¨™
      for (let i = 0; i < earnedStars; i++) {
        setTimeout(() => {
          // éš¨æ©Ÿèµ·å§‹ä½ç½®ï¼ˆåœ¨è¢å¹•ä¸­å¤®å€åŸŸï¼‰
          const startX = window.innerWidth / 2 + (Math.random() - 0.5) * 200;
          const startY = window.innerHeight / 2 + (Math.random() - 0.5) * 200;
          
          createFloatingStar(startX, startY, targetX, targetY);
        }, i * 200); // æ¯å€‹æ˜Ÿæ˜Ÿé–“éš”200ms
      }
      
      // æ‰€æœ‰æ˜Ÿæ˜Ÿé£„å®Œå¾Œï¼Œæ›´æ–°ç¸½æ˜Ÿæ˜Ÿæ•¸ä¸¦æ’­æ”¾æ•¸å­—å‹•ç•«
      setTimeout(() => {
        const currentStars = loadTotalStars();
        const newTotal = currentStars + earnedStars;
        localStorage.setItem('totalStars', newTotal);
        
        // æ’­æ”¾æ•¸å­—è®ŠåŒ–å‹•ç•«
        animateStarsCount(currentStars, newTotal);
        
        // é‡ç½®ç²å¾—çš„æ˜Ÿæ˜Ÿæ•¸
        earnedStars = 0;
      }, earnedStars * 200 + 1500);
    }
    
    function animateStarsCount(from, to) {
      const starsDisplay = document.getElementById('totalStarsCount');
      const duration = 1000; // 1ç§’å‹•ç•«
      const startTime = Date.now();
      
      function updateCount() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // ä½¿ç”¨ç·©å‹•å‡½æ•¸è®“å‹•ç•«æ›´è‡ªç„¶
        const easeOutQuart = 1 - Math.pow(1 - progress, 4);
        const currentCount = Math.floor(from + (to - from) * easeOutQuart);
        
        starsDisplay.textContent = currentCount;
        starsDisplay.classList.add('stars-count-animation');
        
        if (progress < 1) {
          requestAnimationFrame(updateCount);
        } else {
          // å‹•ç•«çµæŸï¼Œç§»é™¤å‹•ç•«é¡åˆ¥
          setTimeout(() => {
            starsDisplay.classList.remove('stars-count-animation');
          }, 600);
        }
      }
      
      updateCount();
    }

    /*----------------------------------------
      (5.5) èªéŸ³åˆæˆ (TTS)
    ----------------------------------------*/
    function speak(text, onEndCallback) {
      // ä½¿ç”¨æ–°çš„ç™¼éŸ³ç³»çµ±
      if (onEndCallback && typeof onEndCallback === 'function') {
        SoundSystem.speech.speakQuestion(text, onEndCallback);
      } else {
        SoundSystem.speech.speakQuestion(text);
      }
    }

    /*----------------------------------------
      (6) Quiz é‚è¼¯
      - ä»¥å¥å­æŒ–ç©ºçš„æ–¹å¼å‡ºé¡Œ
      - ç­”å°æ™‚æ’­æ”¾æ­£ç¢ºå–®å­—ç™¼éŸ³
    ----------------------------------------*/
    let currentQuestion = null;
    let choices = [];
    let answered = false;

    const questionTextEl = document.getElementById('questionText');
    const choicesEl = document.getElementById('choices');
    const feedbackEl = document.getElementById('feedback');

    // è¼‰å…¥éŸ³æ•ˆ
    const correctSound = new Audio('sound/correct.mp3');
    correctSound.preload = 'auto';
    const wrongSound = new Audio('sound/wrong.mp3');
    wrongSound.preload = 'auto';

    /**
     * ç‚ºäº†è®“æ­£è¦è¡¨é”å¼èƒ½æ­£ç¢ºåŒ¹é…ï¼Œè„«é€¸ç‰¹æ®Šå­—å…ƒã€‚
     * @param {string} str - åŸå§‹å­—ä¸²
     * @returns {string} è„«é€¸å¾Œçš„å­—ä¸²
     */
    function escapeRegex(str) {
      // è„«é€¸åœ¨æ­£è¦è¡¨é”å¼ä¸­æœ‰ç‰¹æ®Šæ„ç¾©çš„å­—å…ƒ
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    /**
     * è¨ˆç®—å…©å€‹å­—ä¸²ä¹‹é–“çš„ Levenshtein è·é›¢ï¼ˆç·¨è¼¯è·é›¢ï¼‰
     * ç”¨ä¾†å°‹æ‰¾æ‹¼å­—ç›¸ä¼¼çš„å–®å­—
     */
    function levenshteinDistance(s1, s2) {
      s1 = s1.toLowerCase();
      s2 = s2.toLowerCase();
      const costs = [];
      for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
          if (i === 0) {
            costs[j] = j;
          } else {
            if (j > 0) {
              let newValue = costs[j - 1];
              if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
              }
              costs[j - 1] = lastValue;
              lastValue = newValue;
            }
          }
        }
        if (i > 0) {
          costs[s2.length] = lastValue;
        }
      }
      return costs[s2.length];
    }

    /**
     * å¾å–®å­—æœ¬ä¸­å°‹æ‰¾èˆ‡ç›®æ¨™å–®å­—æœ€ç›¸ä¼¼çš„ N å€‹å–®å­—
     * @param {string} targetWord - ç›®æ¨™å–®å­—
     * @param {number} count - è¦æ‰¾å‡ºçš„ç›¸ä¼¼å–®å­—æ•¸é‡
     * @returns {string[]} ç›¸ä¼¼å–®å­—é™£åˆ—
     */
    function findSimilarWords(targetWord, count) {
      const allOtherWords = vocab
        .map(v => v.word)
        .filter(word => word.toLowerCase() !== targetWord.toLowerCase());

      if (allOtherWords.length <= count) {
        return allOtherWords; // å–®å­—åº«ä¸è¶³ï¼Œè¿”å›æ‰€æœ‰å…¶ä»–å–®å­—
      }

      // è¨ˆç®—æ‰€æœ‰å–®å­—çš„ Levenshtein è·é›¢
      const wordsWithDistance = allOtherWords.map(word => ({
        word: word,
        distance: levenshteinDistance(targetWord, word)
      }));

      // ä¾è·é›¢æ’åºï¼Œè·é›¢ç›¸åŒå‰‡éš¨æ©Ÿæ’åº
      wordsWithDistance.sort((a, b) => {
        if (a.distance !== b.distance) {
          return a.distance - b.distance;
        }
        return Math.random() - 0.5; // æ‰“äº‚é †åº
      });

      // å–å›æœ€ç›¸ä¼¼çš„å‰ count å€‹å–®å­—
      return wordsWithDistance.slice(0, count).map(item => item.word);
    }

    // ç”¢ç”Ÿç¬¬ currentIdx é¡Œï¼šå¾ vocab[currentIdx]
    function generateQuestion() {
      currentQuestion = vocab[currentIdx];

      // example è£¡é¢åŒ…å«äº†å–®å­—ï¼Œå°‡è©²å–®å­—æ›¿æ›æˆã€Œ______ã€
      let rawSentence = currentQuestion.example || '';
      
      // ç‚ºäº†è™•ç†å–®å­—ä¸­å¯èƒ½åŒ…å«çš„æ­£è¦è¡¨é”å¼ç‰¹æ®Šå­—å…ƒï¼Œå…ˆé€²è¡Œè„«é€¸
      const escapedWord = escapeRegex(currentQuestion.word);
      // ç”¨æ­£è¦å»é…å°å–®å­—ï¼ˆå¤§å°å¯«ä¸æ•æ„Ÿï¼‰
      const wordRegex = new RegExp(`\\b${escapedWord}\\b`, 'i');
      let displaySentence = rawSentence.replace(wordRegex, '______');
      
      // åœ¨é¡Œç›®ä¸‹æ–¹é¡¯ç¤ºå®Œæ•´çš„ä¸­æ–‡ä¾‹å¥ç¿»è­¯ï¼Œä¸¦é«˜äº®å–®å­—å°æ‡‰çš„ä¸­æ–‡
      let chineseTranslation = currentQuestion.exampleMeaning || '(ç„¡ä¾‹å¥ç¿»è­¯)';
      const wordMeaning = currentQuestion.meaning;
      if (wordMeaning && chineseTranslation.includes(wordMeaning)) {
        // ä½¿ç”¨ä¸€å€‹é®®è±”çš„é¡è‰²ä¾†æ¨™ç¤ºå–®å­—çš„ä¸­æ–‡æ„æ€
        const highlightedMeaning = `<span style="color: #ffd700; font-weight: bold; text-shadow: 0 0 6px #ffd700;">${wordMeaning}</span>`;
        // åªæ›¿æ›ç¬¬ä¸€å€‹å‡ºç¾çš„ï¼Œé¿å…æ„å¤–æ›¿æ›å…¶ä»–åœ°æ–¹
        chineseTranslation = chineseTranslation.replace(wordMeaning, highlightedMeaning);
      }

      questionTextEl.innerHTML = `
        ${displaySentence}
        <div style="margin-top: 10px; font-size: 1.1rem; color: #a7ffea; font-weight: 500;">${chineseTranslation}</div>
      `;

      // æº–å‚™é¸é …ï¼šæ­£ç¢ºå–®å­— + ä¸‰å€‹å¹²æ“¾
      choices = [];
      // æ­£ç¢ºé¸é …
      choices.push({ text: currentQuestion.word, isCorrect: true });

      // æŠ½ 3 å€‹å¹²æ“¾ï¼šæ”¹ç‚ºå°‹æ‰¾æ‹¼å­—ç›¸ä¼¼çš„å–®å­—
      const distractors = findSimilarWords(currentQuestion.word, 3);
      distractors.forEach(d => choices.push({ text: d, isCorrect: false }));

      // å¦‚æœæ‰¾ä¸åˆ°è¶³å¤ çš„ç›¸ä¼¼å­—ï¼Œç”¨éš¨æ©Ÿå­—è£œæ»¿
      while (choices.length < 4 && vocab.length > choices.length) {
          const r = vocab[Math.floor(Math.random() * totalCount)];
          let candidate = r.word;
          // æª¢æŸ¥æ˜¯å¦å·²åœ¨é¸é …ä¸­
          if (!choices.some(c => c.text.toLowerCase() === candidate.toLowerCase())) {
              choices.push({ text: candidate, isCorrect: false });
          }
      }

      // Shuffle choices
      for (let i = choices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [choices[i], choices[j]] = [choices[j], choices[i]];
      }

      // è‡ªå‹•å¿µå‡ºé¡Œç›®ï¼ˆå¿µå‡ºåŒ…å«ç­”æ¡ˆçš„å®Œæ•´å¥å­ï¼‰
      if (currentQuestion && currentQuestion.example) {
        speak(currentQuestion.example);
      }
    }

    // è™•ç†ä½¿ç”¨è€…é»é¸
    function handleChoice(index) {
      if (answered) return;
      answered = true;
      
      // åœæ­¢è¨ˆæ™‚å™¨
      stopTimer();
      
      // ===== æ–°å¢ï¼šè¨ˆç®—ç­”é¡Œæ™‚é–“ =====
      const answerTime = (TIMER_DURATION - timeLeft); // 10ç§’å€’è¨ˆæ™‚ï¼Œæ‰€ä»¥ç”¨10æ¸›å»å‰©é¤˜æ™‚é–“
      gameStats.totalAnswered++;
      gameStats.totalTimeUsed += answerTime;
      
      const selected = choices[index];
      const correctText = choices.find(c => c.isCorrect).text;
      const allChoiceBtns = choicesEl.querySelectorAll('.choice-btn');
      
      // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
      allChoiceBtns.forEach(btn => {
        btn.disabled = true;
      });

      let feedbackMessage = '';
      if (selected.isCorrect) {
        feedbackMessage = 'âœ… ç­”å°äº†ï¼';
        feedbackEl.style.color = '#2ecc71';
        selected.buttonEl.classList.add('correct');

        // æ’­æ”¾ç­”å°éŸ³æ•ˆ
        correctSound.currentTime = 0;
        correctSound.play();

        // ===== æ–°å¢ï¼šç­”å°é‚è¼¯ =====
        gameStats.correctCount++;
        gameStats.consecutiveCorrect++;
        
        // æ›´æ–°æœ€å¿«/æœ€æ…¢ç­”é¡Œæ™‚é–“
        if (answerTime < gameStats.fastestAnswer) {
          gameStats.fastestAnswer = answerTime;
        }
        if (answerTime > gameStats.slowestAnswer) {
          gameStats.slowestAnswer = answerTime;
        }
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºå®Œç¾ç­”é¡Œï¼ˆ5ç§’å…§ç­”å°ï¼‰
        if (answerTime <= 5) {
          gameStats.perfectAnswers++;
        }
        
        // è¨ˆç®—æ˜Ÿæ˜Ÿçå‹µ
        const starsEarned = calculateStarReward(true, answerTime, gameStats.consecutiveCorrect, currentQuestion.word.length, 'æ™®é€š');
        
        // ä½¿ç”¨çµ±ä¸€çš„æ˜Ÿæ˜Ÿç³»çµ±
        if (typeof StarRewardSystem !== 'undefined') {
          StarRewardSystem.addStars(starsEarned);
        } else {
          earnedStars += starsEarned;
        }
        
        // æ›´æ–°é¡¯ç¤º
        updateCurrentEarnedStars();
        
        // é¡¯ç¤ºçå‹µå‹•ç•«
        let reasonText = '';
        if (answerTime <= 3) {
          reasonText = 'âš¡ è¶…å¿«é€Ÿç­”é¡Œï¼';
        } else if (answerTime <= 5) {
          reasonText = 'ğŸ¯ å¿«é€Ÿç­”é¡Œï¼';
        } else if (answerTime <= 7) {
          reasonText = 'âœ¨ æº–ç¢ºç­”é¡Œï¼';
        }
        if (gameStats.consecutiveCorrect >= 3) {
          reasonText += reasonText ? ' + é€£æ“Šçå‹µï¼' : 'ğŸ”¥ é€£æ“Šçå‹µï¼';
        }
        
        showRewardAnimation(starsEarned, reasonText);
        
        // é¡¯ç¤ºé€£æ“Šé€šçŸ¥
        showComboNotification(gameStats.consecutiveCorrect);

        // è¨˜éŒ„ç­”å°çš„å–®å­—ï¼ˆç”¨æ–¼å–®å­—é”äººæˆå°±ï¼‰
        if (typeof VocabularyAchievementSystem !== 'undefined') {
          VocabularyAchievementSystem.recordCorrectWord(currentQuestion.word, bookName);
        }
      } else {
        const correctWord = currentQuestion.word;
        feedbackMessage = `âŒ ç­”éŒ¯äº†ï¼ æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š <strong style="color: #ffd700; font-weight: bold;">${correctWord}</strong>`;
        feedbackEl.style.color = '#e74c3c';
        selected.buttonEl.classList.add('incorrect');
        
        // æ’­æ”¾ç­”éŒ¯éŸ³æ•ˆ
        wrongSound.currentTime = 0;
        wrongSound.play();

        // ===== æ–°å¢ï¼šç­”éŒ¯é‚è¼¯ =====
        gameStats.consecutiveCorrect = 0; // é‡ç½®é€£æ“Š

        // æ‰¾å‡ºä¸¦æ¨™ç¤ºæ­£ç¢ºç­”æ¡ˆ
        const correctBtn = Array.from(allChoiceBtns).find(btn => choices[btn.dataset.index].isCorrect);
        if(correctBtn) correctBtn.classList.add('correct');
      }
      
      // å–å¾—ä¸¦é™„åŠ ä¸­æ–‡è§£é‡‹
      feedbackEl.innerHTML = feedbackMessage;

      // ä¸è«–å°éŒ¯ï¼Œéƒ½å…ˆåœæ­¢ç›®å‰çš„æœ—è®€ï¼Œç„¶å¾Œå¿µå‡ºæ­£ç¢ºå–®å­—å’Œä¾‹å¥
      // ä¸¦åœ¨æœ—è®€çµæŸå¾Œæ‰å‰é€²åˆ°ä¸‹ä¸€æ­¥
      window.speechSynthesis.cancel();

      const onSpeechFinished = () => {
        // æœ—è®€å®Œç•¢å¾Œï¼Œç¨å¾®å»¶é²ä¸€ä¸‹å†è·³è½‰ï¼Œé¿å…å¤ªçªå…€
        setTimeout(goToNextStep, 500);
      };

      if (correctText && currentQuestion.example) {
        // å…ˆå¿µå–®å­—ï¼Œå¿µå®Œå¾Œå†å¿µä¾‹å¥ï¼Œä¾‹å¥å¿µå®Œå¾Œè§¸ç™¼å›å‘¼
        speak(correctText, () => speak(currentQuestion.example, onSpeechFinished));
      } else if (correctText) {
        // åªå¿µå–®å­—ï¼Œå¿µå®Œå¾Œè§¸ç™¼å›å‘¼
        speak(correctText, onSpeechFinished);
      } else {
        // å¦‚æœæ²’æœ‰æ±è¥¿å¯ä»¥å¿µï¼Œå°±ç›´æ¥é€²å…¥ä¸‹ä¸€æ­¥
        onSpeechFinished();
      }
    }

    // åœ¨æ¸²æŸ“æ™‚ï¼Œå°‡æŒ‰éˆ•å…ƒç´ é™„åŠ åˆ°é¸é …ç‰©ä»¶ä¸Šï¼Œæ–¹ä¾¿ä¹‹å¾Œå–ç”¨
    function renderQuestion() {
        currentIdxEl.textContent = currentIdx + 1;
        choicesEl.innerHTML = '';
        feedbackEl.textContent = '';
        answered = false;

        generateQuestion();

        choices.forEach((choiceObj, i) => {
            const btn = document.createElement('button');
            btn.textContent = String.fromCharCode(65 + i) + '. ' + choiceObj.text;
            btn.className = 'choice-btn';
            btn.dataset.index = i;
            btn.addEventListener('click', () => handleChoice(i));
            choicesEl.appendChild(btn);
            choiceObj.buttonEl = btn; // å°‡æŒ‰éˆ•å¯¦ä¾‹é™„åŠ åˆ°ç‰©ä»¶
        });

        // å•Ÿå‹•è¨ˆæ™‚å™¨
        startTimer();

        if (currentQuestion && currentQuestion.example) {
            speak(currentQuestion.example);
        }
    }

    /*----------------------------------------
      (7) ç·´ç¿’å½ˆçª—ç›¸é—œé‚è¼¯
    ----------------------------------------*/
    const reviewModal = document.getElementById('reviewModal');
    const reviewWordsContainer = document.getElementById('reviewWordsContainer');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const continueQuizBtn = document.getElementById('continueQuizBtn');

    function goToNextStep() {
      window.speechSynthesis.cancel(); // åœæ­¢æœ—è®€
      stopTimer(); // åœæ­¢è¨ˆæ™‚å™¨

      const isEnding = (currentIdx + 1) >= totalCount;
      if (isEnding) {
        // ====== æ–°å¢ï¼šæˆå°±ç³»çµ±é€£å‹• ======
        updateQuizGameAchievements();
        
        // æ’­æ”¾æ˜Ÿæ˜Ÿæ”¶é›†å‹•ç•«
        animateStarsCollection();
        
        // å»¶é²é¡¯ç¤ºå®Œæˆè¨Šæ¯ï¼Œè®“æ˜Ÿæ˜Ÿå‹•ç•«å…ˆæ’­æ”¾
        setTimeout(() => {
          alert(`æ­å–œå®Œæˆæ‰€æœ‰é¡Œç›®ï¼ç¸½æ˜Ÿæ•¸ï¼š${loadTotalStars()}`);
          window.location.href = `book_edit.html?book=${encodeURIComponent(bookName)}`;
        }, earnedStars * 200 + 2500); // ç­‰å¾…æ˜Ÿæ˜Ÿå‹•ç•«å®Œæˆ
      } else {
        currentIdx++;
        renderQuestion();
      }
    }

    // ====== æ–°å¢ï¼šæˆå°±ç³»çµ±å‡½æ•¸ ======
    function updateQuizGameAchievements() {
      // æ›´æ–°é¸æ“‡é¡ŒéŠæˆ²å®Œæˆæ¬¡æ•¸
      const quizGames = parseInt(localStorage.getItem('quizGamesCompleted') || '0');
      localStorage.setItem('quizGamesCompleted', quizGames + 1);
      
      // æª¢æŸ¥ä¸¦æ›´æ–°ç›¸é—œæˆå°±
      checkAndUpdateQuizGameAchievements();
    }
    
    function checkAndUpdateQuizGameAchievements() {
      // æª¢æŸ¥æ˜¯å¦æœ‰æ–°æˆå°±é”æˆ
      const achievements = [
        { id: 'speed_learner', name: 'å¿«é€Ÿå­¸ç¿’è€…', requirement: 10 },
        { id: 'accuracy_master', name: 'æº–ç¢ºå¤§å¸«', requirement: 20 },
        { id: 'combo_king', name: 'é€£æ“Šä¹‹ç‹', requirement: 15 }
      ];
      
      const claimed = JSON.parse(localStorage.getItem('claimedAchievements') || '[]');
      
      achievements.forEach(ach => {
        if (claimed.includes(ach.id)) return; // å·²ç¶“é ˜å–éäº†
        
        // è¨ˆç®—é€šéçš„é—œå¡æ•¸é‡
        const fillGames = parseInt(localStorage.getItem('fillGamesCompleted') || '0');
        const cardGames = parseInt(localStorage.getItem('cardGamesCompleted') || '0');
        const quizGames = parseInt(localStorage.getItem('quizGamesCompleted') || '0');
        const spellingGames = parseInt(localStorage.getItem('spellingGamesCompleted') || '0');
        const matchingGames = parseInt(localStorage.getItem('matchingGamesCompleted') || '0');
        const totalGames = fillGames + cardGames + quizGames + spellingGames + matchingGames;
        
        if (totalGames >= ach.requirement) {
          // é¡¯ç¤ºæˆå°±é”æˆé€šçŸ¥
          showAchievementNotification(ach.name, ach.id);
        }
      });
    }
    
    function showAchievementNotification(achievementName, achievementId) {
      // å‰µå»ºæˆå°±é€šçŸ¥
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        color: #000;
        padding: 20px 30px;
        border-radius: 15px;
        font-weight: bold;
        font-size: 1.2rem;
        z-index: 10000;
        box-shadow: 0 0 30px #ffd700;
        animation: achievementPop 0.8s cubic-bezier(.68, -0.55, .27, 1.55);
        text-align: center;
        min-width: 300px;
      `;
      
      notification.innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ†</div>
        <div style="margin-bottom: 5px;">ğŸ‰ æˆå°±é”æˆï¼</div>
        <div style="font-size: 1.1rem;">${achievementName}</div>
        <div style="font-size: 0.9rem; margin-top: 10px; color: #666;">
          å‰å¾€æˆå°±é é¢é ˜å–çå‹µ
        </div>
      `;
      
      // æ·»åŠ å‹•ç•«æ¨£å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes achievementPop {
          0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
          50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(notification);
      
      // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
      setTimeout(() => {
        notification.remove();
        style.remove();
      }, 3000);
    }

    function showPreviewModal() {
      reviewWordsContainer.innerHTML = ''; // æ¸…ç©ºå…§å®¹
      
      // é¡¯ç¤ºæ‰€æœ‰å³å°‡æ¸¬é©—çš„å–®å­—
      vocab.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'word-item';
        div.innerHTML = `
          <div class="word-header">
            <h3>${index + 1}. ${item.word}</h3>
            <button class="pronounce-btn" data-word="${item.word}">ğŸ”Š</button>
          </div>
          <p><strong>ä¸­æ–‡æ„æ€ï¼š</strong> ${item.meaning || 'ï¼ˆç„¡ä¸­æ–‡æ„æ€ï¼‰'}</p>
        `;
        reviewWordsContainer.appendChild(div);
      });

      // å¹«æ‰€æœ‰ç™¼éŸ³æŒ‰éˆ•åŠ ä¸Šäº‹ä»¶
      reviewWordsContainer.querySelectorAll('.pronounce-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const wordToSpeak = e.currentTarget.getAttribute('data-word');
          speak(wordToSpeak);
        });
      });
      
      // æ›´æ–°æ¨™é¡Œå’ŒæŒ‰éˆ•
      document.getElementById('reviewModalTitle').textContent = 'æ¸¬é©—å‰é ç¿’';
      continueQuizBtn.textContent = 'é–‹å§‹æ¸¬é©—';
      reviewModal.style.display = 'block';

      // è‡ªå‹•ä¾åºå¿µå‡ºæ‰€æœ‰å–®å­—
      autoPronouncePreviewWords();
    }

    function autoPronouncePreviewWords() {
      let i = 0;
      function speakNext() {
        if (i < vocab.length) {
          const word = vocab[i].word;
          i++;
          speak(word, speakNext);
        }
      }
      speakNext(); // é–‹å§‹æœ—è®€
    }

    function startQuiz() {
      window.speechSynthesis.cancel(); // åœæ­¢æœ—è®€
      stopTimer(); // åœæ­¢è¨ˆæ™‚å™¨
      reviewModal.style.display = 'none';
      currentIdx = 0; // é‡ç½®ç‚ºç¬¬ä¸€é¡Œ
      earnedStars = 0; // é‡ç½®ç²å¾—çš„æ˜Ÿæ˜Ÿæ•¸
      document.getElementById('currentEarnedStars').style.display = 'none'; // éš±è—ç•¶å‰ç²å¾—æ˜Ÿæ˜Ÿæ•¸
      renderQuestion();
    }

    closeModalBtn.addEventListener('click', startQuiz);
    continueQuizBtn.addEventListener('click', startQuiz);
    
    // é»æ“Š modal å¤–é¢ä¹Ÿå¯ä»¥é–‹å§‹æ¸¬é©—
    window.addEventListener('click', (event) => {
      if (event.target == reviewModal) {
        startQuiz();
      }
    });

    /*----------------------------------------
      (8) åˆå§‹åŒ–
    ----------------------------------------*/
    window.addEventListener('load', () => {
      // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
      if (typeof SoundSystem !== 'undefined') {
        SoundSystem.speech.init();
      }
      
      // æ·»åŠ è·³éæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
      skipBtn.addEventListener('click', handleSkip);
      
      updateStarsDisplay();
      initCanvas();
      animate();
      // å…ˆé¡¯ç¤ºé ç¿’å½ˆçª—ï¼Œè€Œä¸æ˜¯ç›´æ¥é–‹å§‹æ¸¬é©—
      showPreviewModal();
    });
    
    // é é¢å¸è¼‰æ™‚åœæ­¢è¨ˆæ™‚å™¨
    window.addEventListener('beforeunload', () => {
      stopTimer();
    });

    // ===== æ–°å¢ï¼šéŠæˆ²ç‹€æ…‹è¿½è¹¤ =====
    let gameStats = {
      correctCount: 0,
      totalAnswered: 0,
      consecutiveCorrect: 0, // é€£çºŒç­”å°æ¬¡æ•¸
      fastestAnswer: Infinity, // æœ€å¿«ç­”é¡Œæ™‚é–“
      slowestAnswer: 0, // æœ€æ…¢ç­”é¡Œæ™‚é–“
      totalTimeUsed: 0, // ç¸½ç”¨æ™‚
      perfectAnswers: 0, // å®Œç¾ç­”é¡Œæ¬¡æ•¸ï¼ˆ5ç§’å…§ç­”å°ï¼‰
      startTime: Date.now()
    };

    // ===== æ–°å¢ï¼šæ˜Ÿæ˜Ÿçå‹µè¨ˆç®—å‡½æ•¸ =====
    function calculateStarReward(isCorrect, answerTime, consecutiveCount, wordLength, rarity) {
      if (!isCorrect) return 0;
      
      let baseReward = 1; // åŸºç¤çå‹µ
      
      // æ™‚é–“çå‹µï¼šè¶Šå¿«ç­”å°çå‹µè¶Šå¤š
      if (answerTime <= 3) {
        baseReward += 3; // 3ç§’å…§ +3æ˜Ÿ
      } else if (answerTime <= 5) {
        baseReward += 2; // 5ç§’å…§ +2æ˜Ÿ
      } else if (answerTime <= 7) {
        baseReward += 1; // 7ç§’å…§ +1æ˜Ÿ
      }
      
      // é€£æ“Šçå‹µï¼šé€£çºŒç­”å°è¶Šå¤šçå‹µè¶Šå¤š
      if (consecutiveCount >= 5) {
        baseReward += 3; // 5é€£æ“Š +3æ˜Ÿ
      } else if (consecutiveCount >= 3) {
        baseReward += 2; // 3é€£æ“Š +2æ˜Ÿ
      } else if (consecutiveCount >= 2) {
        baseReward += 1; // 2é€£æ“Š +1æ˜Ÿ
      }
      
      // å–®å­—é›£åº¦çå‹µï¼šæ ¹æ“šå–®å­—é•·åº¦çµ¦äºˆé¡å¤–çå‹µ
      if (wordLength >= 8) {
        baseReward += 2; // é•·å–®å­—é¡å¤–çå‹µ
      } else if (wordLength >= 6) {
        baseReward += 1; // ä¸­ç­‰é•·åº¦å–®å­—çå‹µ
      }
      
      // é¸æ“‡é¡ŒéŠæˆ²ç‰¹æ®Šçå‹µ
      baseReward += 1; // é¸æ“‡é¡ŒéŠæˆ²é¡å¤–çå‹µ
      
      return baseReward;
    }
    
    // ===== æ–°å¢ï¼šé¡¯ç¤ºçå‹µå‹•ç•« =====
    function showRewardAnimation(starsEarned, reason = '') {
      const rewardDiv = document.createElement('div');
      rewardDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 170, 0, 0.95));
        color: #000;
        padding: 20px 30px;
        border-radius: 15px;
        font-size: 1.5rem;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 0 30px #ffd700;
        animation: rewardPop 1.2s ease-out forwards;
        font-family: 'Orbitron', sans-serif;
        text-align: center;
        min-width: 300px;
      `;
      
      let reasonText = '';
      if (reason) {
        reasonText = `<div style="font-size: 1rem; margin-top: 8px; color: #666;">${reason}</div>`;
      }
      
      rewardDiv.innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 10px;">â­</div>
        <div style="font-size: 1.8rem; margin-bottom: 5px;">+${starsEarned} æ˜Ÿæ˜Ÿ</div>
        ${reasonText}
      `;
      
      // æ·»åŠ å‹•ç•«æ¨£å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes rewardPop {
          0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
          50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(rewardDiv);
      
      // æ’­æ”¾æ˜Ÿæ˜ŸéŸ³æ•ˆ
      if (typeof StarRewardSystem !== 'undefined') {
        StarRewardSystem.playStarSound();
      }
      
      // 2.5ç§’å¾Œç§»é™¤
      setTimeout(() => {
        if (document.body.contains(rewardDiv)) {
          document.body.removeChild(rewardDiv);
        }
        if (document.head.contains(style)) {
          document.head.removeChild(style);
        }
      }, 2500);
    }
    
    // ===== æ–°å¢ï¼šé¡¯ç¤ºé€£æ“Šé€šçŸ¥ =====
    function showComboNotification(comboCount) {
      if (comboCount < 2) return;
      
      const comboDiv = document.createElement('div');
      comboDiv.style.cssText = `
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, rgba(255, 69, 0, 0.9), rgba(255, 140, 0, 0.9));
        color: #fff;
        padding: 15px 25px;
        border-radius: 25px;
        font-size: 1.2rem;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 0 20px #ff4500;
        animation: comboSlide 0.8s ease-out forwards;
        font-family: 'Orbitron', sans-serif;
      `;
      
      let comboText = '';
      let comboIcon = '';
      
      if (comboCount >= 5) {
        comboText = `${comboCount} é€£æ“Šï¼ğŸ”¥ ç„¡æ•µé€£æ“Šï¼`;
        comboIcon = 'ğŸ”¥';
      } else if (comboCount >= 3) {
        comboText = `${comboCount} é€£æ“Šï¼âš¡ è¶…å¼·é€£æ“Šï¼`;
        comboIcon = 'âš¡';
      } else {
        comboText = `${comboCount} é€£æ“Šï¼âœ¨ é€£æ“Šé–‹å§‹ï¼`;
        comboIcon = 'âœ¨';
      }
      
      comboDiv.innerHTML = `${comboIcon} ${comboText} ${comboIcon}`;
      
      // æ·»åŠ å‹•ç•«æ¨£å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes comboSlide {
          0% { transform: translateX(-50%) translateY(-100%); opacity: 0; }
          50% { transform: translateX(-50%) translateY(0); opacity: 1; }
          100% { transform: translateX(-50%) translateY(0); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(comboDiv);
      
      // 2ç§’å¾Œç§»é™¤
      setTimeout(() => {
        if (document.body.contains(comboDiv)) {
          document.body.removeChild(comboDiv);
        }
        if (document.head.contains(style)) {
          document.head.removeChild(style);
        }
      }, 2000);
    }
  </script>
</body>
</html>
