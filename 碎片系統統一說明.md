# 碎片系統統一說明

## 系統概述

現在所有頁面都統一使用碎片邏輯系統，玩家需要收集足夠的碎片才能解鎖卡片，而不是直接獲得完整卡片。

## 碎片需求規則

```javascript
function getRequiredShards(rarity) {
  if (rarity === '超稀有') return 5;  // SSR 需要 5 片
  if (rarity === '稀有') return 3;    // R 需要 3 片  
  return 1;                           // A 需要 1 片
}
```

## 碎片獎勵規則

### 抽卡系統 (gacha.html)
- **超稀有 (SSR)**：每次抽中獲得 2 片碎片
- **稀有 (R)**：每次抽中獲得 1 片碎片
- **普通 (A)**：每次抽中獲得 1 片碎片

### 語法塔系統 (grammar_levels.html)
- **超稀有 (SSR)**：每次抽中獲得 2 片碎片
- **稀有 (R)**：每次抽中獲得 1 片碎片
- **普通 (A)**：每次抽中獲得 1 片碎片

### 遊戲完成獎勵 (sound.js)
- **90%以上正確率**：3 片碎片
- **80%以上正確率**：2 片碎片
- **60%以上正確率**：1 片碎片
- **額外獎勵**：時間獎勵 + 完美獎勵

## 抽卡邏輯流程

### 單抽邏輯
1. **檢查是否已擁有卡片**
   - 已擁有：給予碎片獎勵
   - 未擁有：給予碎片獎勵

2. **檢查碎片是否集滿**
   - 碎片集滿：自動解鎖卡片，標記為新卡片
   - 碎片不足：繼續收集

### 十連抽邏輯
1. **前 9 張**：正常抽卡邏輯
2. **第 10 張**：保底機制
   - 如果前 9 張沒有 SSR，第 10 張必得 SSR
   - 如果已有 SSR，正常抽卡

## 結果類型

### 抽卡結果類型
- `duplicate`：重複卡片，獲得碎片
- `new_card_unlocked`：新卡片，碎片集滿解鎖
- `new_card_shards`：新卡片，碎片不足繼續收集
- `unlock_by_shards`：重複卡片，碎片集滿解鎖

### 通知訊息
- 重複卡片：`抽到重複卡片 [卡片名]，獲得 [數量] 片碎片！`
- 新解鎖：`🎉 恭喜！集滿碎片解鎖新卡片：[卡片名]！`
- 碎片進度：`✨ 獲得 [卡片名] 碎片 x[數量]！進度：[當前]/[需求]`

## 卡片顯示邏輯

### 已解鎖卡片
- 有多餘碎片：顯示 `♻️ [多餘數量]`（可分解）
- 無多餘碎片：顯示 `✔`（已解鎖）

### 未解鎖卡片
- 顯示碎片進度：`[當前數量]/[需求數量]`

## 分解系統

### 分解條件
- 卡片必須已解鎖
- 必須有多餘碎片

### 分解獎勵
- **超稀有**：每片 5 顆星星
- **稀有**：每片 2 顆星星
- **普通**：每片 1 顆星星

## 新卡片標記系統

### 標記條件
- 碎片集滿解鎖的卡片
- 自動添加 "NEW!" 標記

### 標記消失
- 點擊卡片後立即消失
- 10 分鐘後自動消失

## 許願池系統

### 許願機制
- 只能許願 SSR 卡片
- 抽中機率提升 2%
- 十連抽保底優先給許願卡片

### 許願設定
- 可設定許願卡片
- 可清除許願設定
- 許願狀態會保存到 localStorage

## 數據存儲

### localStorage 項目
```javascript
localStorage.setItem('ownedCards', JSON.stringify(ownedCards));     // 已擁有卡片
localStorage.setItem('cardShards', JSON.stringify(shards));         // 碎片數量
localStorage.setItem('recentlyObtainedCards', JSON.stringify([]));  // 新卡片標記
localStorage.setItem('currentWishCard', JSON.stringify(wishCard));  // 許願卡片
```

## 系統特點

### 統一性
- 所有頁面都使用相同的碎片邏輯
- 抽卡、遊戲獎勵、分解系統完全一致

### 收集性
- 增加遊戲的收集樂趣
- 提供明確的收集目標

### 平衡性
- 不同稀有度有不同的碎片需求
- 合理的碎片獎勵機制

### 互動性
- 新卡片標記增加成就感
- 許願池系統增加策略性
- 分解系統提供資源轉換

## 修改記錄

### 主要修改
1. **gacha.html**：將直接給卡片改為碎片系統
2. **grammarTower.js**：將直接給卡片改為碎片系統
3. **通知系統**：更新所有相關通知訊息
4. **顯示邏輯**：統一碎片顯示方式

### 保持不變
1. **cards.html**：原本就使用碎片系統
2. **sound.js**：原本就使用碎片系統
3. **分解系統**：邏輯保持不變
4. **許願池系統**：邏輯保持不變

## 測試建議

### 功能測試
1. 測試單抽碎片邏輯
2. 測試十連抽碎片邏輯
3. 測試碎片集滿解鎖
4. 測試新卡片標記
5. 測試分解系統
6. 測試許願池系統

### 數據測試
1. 檢查 localStorage 數據正確性
2. 檢查碎片數量計算
3. 檢查卡片解鎖狀態
4. 檢查新卡片標記時間

### 界面測試
1. 檢查碎片顯示正確性
2. 檢查通知訊息正確性
3. 檢查動畫效果
4. 檢查響應式設計 