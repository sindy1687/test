<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬äºŒåäºŒé—œï¼šå®Œç¾å¤§å¸«</title>
    <link rel="stylesheet" href="responsive.css">
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #2c5364 100%);
            min-height: 100vh;
            margin: 0;
            color: #e0eaff;
            position: relative;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('img/cards/galaxy.gif') repeat center center, radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            opacity: 0.5;
            z-index: 0;
            pointer-events: none;
        }

        .game-container {
            background: rgba(30, 40, 70, 0.7);
            border-radius: 24px;
            padding: 36px;
            box-shadow: 0 8px 40px #00ffe055, 0 1.5px 8px #0ff2  inset;
            max-width: 820px;
            width: 95%;
            text-align: center;
            backdrop-filter: blur(8px);
            border: 1.5px solid #3ecfff55;
            margin-top: 0;
        }
        
        .level-header {
            margin-bottom: 32px;
        }

        .level-title {
            font-size: 2.7em;
            color: #7eeeff;
            margin-bottom: 10px;
            text-shadow: 0 0 16px #00ffe0, 0 2px 8px #0ff2;
            letter-spacing: 2px;
        }

        .level-subtitle {
            font-size: 1.3em;
            color: #aeefff;
            margin-bottom: 15px;
            text-shadow: 0 0 8px #00ffe0;
        }

        .scene-description {
            font-size: 1.1em;
            color: #b2cfff;
            font-style: italic;
            text-shadow: 0 0 6px #00ffe0;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(90deg, #232b3a 60%, #1b2735 100%);
            border-radius: 15px;
            box-shadow: 0 2px 12px #00ffe033;
        }

        .timer, .score, .stars {
            font-size: 1.5em;
            font-weight: bold;
            color: #00ffe0;
            text-shadow: 0 0 8px #00ffe0;
        }

        .stars { color: #ffe066; text-shadow: 0 0 8px #ffe066; }

        .sound-toggle {
            background: none;
            border: none;
            font-size: 1.7em;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            color: #7eeeff;
            box-shadow: 0 0 8px #00ffe0;
        }

        .sound-toggle:hover {
            background: rgba(0,255,255,0.08);
            transform: scale(1.1);
            box-shadow: 0 0 16px #00ffe0;
        }

        .sound-toggle.muted { opacity: 0.5; }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #1b2735;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px #00ffe033;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffe0, #3ecfff);
            transition: width 0.3s ease;
            box-shadow: 0 0 12px #00ffe0;
        }
        
        .guardian-statue {
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, #00ffe0, #3ecfff);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            box-shadow: 0 0 32px #00ffe0cc;
            transition: all 0.3s ease;
        }

        .guardian-statue.shine {
            animation: shine 0.5s ease;
        }

        @keyframes shine {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); box-shadow: 0 0 40px #00ffe0; }
            100% { transform: scale(1); }
        }

        .grammar-tip {
            background: linear-gradient(135deg, #3ecfff, #00ffe0);
            color: #222;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 2px 12px #00ffe055;
        }

        .question-container {
            background: rgba(20, 30, 50, 0.85);
            border-radius: 18px;
            padding: 32px;
            margin-bottom: 30px;
            box-shadow: 0 4px 24px #00ffe022;
            border: 1px solid #3ecfff33;
        }

        .question {
            font-size: 2em;
            margin-bottom: 30px;
            color: #e0eaff;
            line-height: 1.4;
            text-shadow: 0 0 8px #00ffe0;
        }
        
        .options {
            display: flex;
            gap: 18px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .option {
            background: linear-gradient(135deg, #0ff 0%, #3ecfff 100%);
            color: #222;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px #00ffe055;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .option:hover {
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 8px 32px #00ffe0cc;
            background: linear-gradient(135deg, #3ecfff 0%, #0ff 100%);
        }

        .option.correct {
            background: linear-gradient(135deg, #1e90ff 0%, #00ffe0 100%);
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 12px #00ffe0, 0 0 4px #fff;
            box-shadow: 0 0 24px #00ffe0cc, 0 0 8px #1e90ff;
            border: 2px solid #00ffe0;
        }

        .option.incorrect {
            background: linear-gradient(135deg, #7f53ac 0%, #ff6a88 100%);
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 12px #ff6a88, 0 0 4px #fff;
            box-shadow: 0 0 24px #ff6a88cc, 0 0 8px #7f53ac;
            border: 2px solid #ff6a88;
        }
        
        .hint-buttons {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin-bottom: 20px;
        }

        .hint-btn {
            background: linear-gradient(135deg, #00ffe0, #3ecfff);
            color: #222;
            border: none;
            padding: 10px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px #00ffe055;
        }

        .hint-btn:hover {
            transform: translateY(-1px) scale(1.04);
            box-shadow: 0 8px 24px #00ffe0cc;
            background: linear-gradient(135deg, #3ecfff, #00ffe0);
        }

        .hint-btn:disabled {
            background: #3ecfff55;
            cursor: not-allowed;
            transform: none;
        }

        /* æ–°å¢ï¼šå›°é›£å–®å­—æç¤ºå€å¡Šç§‘æŠ€é¢¨æ ¼ */
        #wordHintDiv {
            margin: 18px 0;
            background: rgba(20,40,70,0.92);
            border: 1.5px solid #00ffe0;
            border-radius: 12px;
            padding: 16px 18px;
            text-align: left;
            box-shadow: 0 0 18px #00ffe088, 0 1.5px 8px #0ff2 inset;
        }
        #wordHintDiv strong {
            color: #00ffe0;
            font-size: 1.1em;
            letter-spacing: 1px;
            text-shadow: 0 0 8px #00ffe0;
        }
        #wordHintDiv .word-block {
            display: inline-block;
            margin: 4px 12px 4px 0;
            padding: 6px 12px;
            background: linear-gradient(135deg, #232b3a 60%, #1b2735 100%);
            color: #7eeeff;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.08em;
            box-shadow: 0 0 8px #00ffe0cc;
            transition: box-shadow 0.2s;
        }
        #wordHintDiv .word-block:hover {
            box-shadow: 0 0 18px #00ffe0, 0 0 8px #7eeeff;
        }
        #wordHintDiv .zh {
            color: #fffbe6;
            font-size: 1em;
            margin-left: 8px;
            text-shadow: 0 0 4px #00ffe0;
        }

        /* æ–°å¢ï¼šé‚è¼¯æç¤ºå€å¡Šç§‘æŠ€é¢¨æ ¼ */
        #logicHintDiv {
            background: rgba(20,40,70,0.92);
            border: 1.5px solid #38ffb0;
            border-radius: 12px;
            margin-top: 16px;
            padding: 14px 18px;
            font-size: 1.05em;
            color: #e0fff7;
            box-shadow: 0 0 18px #38ffb088, 0 1.5px 8px #38ffb055 inset;
            text-align: left;
        }
        #logicHintDiv strong {
            color: #38ffb0;
            font-size: 1.08em;
            letter-spacing: 1px;
            text-shadow: 0 0 8px #38ffb0;
        }
        #logicHintDiv:hover {
            box-shadow: 0 0 24px #38ffb0, 0 0 8px #7eeeff;
        }

        /* æ–°å¢ï¼šç­”æ¡ˆè§£é‡‹å€å¡Šç§‘æŠ€é¢¨æ ¼ */
        .answer-explanation {
            margin: 12px 0 0 0;
            padding: 16px 18px;
            background: rgba(20,40,70,0.92);
            border: 1.5px solid #00ffe0;
            border-radius: 12px;
            color: #7eeeff;
            font-size: 1.18em;
            font-weight: bold;
            text-shadow: 0 0 8px #00ffe0, 0 0 2px #fff;
            box-shadow: 0 0 18px #00ffe088, 0 1.5px 8px #0ff2 inset;
            display: inline-block;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 18px;
        }

        .action-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            background: linear-gradient(135deg, #00ffe0, #3ecfff);
            color: #222;
            box-shadow: 0 2px 12px #00ffe055;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, #3ecfff, #00ffe0);
            box-shadow: 0 8px 24px #00ffe0cc;
            color: #111;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7eeeff, #00ffe0);
            color: #222;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #232b3a, #1b2735);
            color: #7eeeff;
            border: 1.5px solid #3ecfff55;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #3ecfff, #232b3a);
            color: #fff;
        }
        
        .result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 20, 40, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .result-content {
            background: rgba(30, 40, 70, 0.95);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 40px #00ffe055;
            border: 1.5px solid #3ecfff55;
            backdrop-filter: blur(8px);
        }

        .result-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #7eeeff;
            text-shadow: 0 0 16px #00ffe0, 0 2px 8px #0ff2;
        }

        .result-score {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #ffe066;
            text-shadow: 0 0 8px #ffe066;
        }

        .result-message {
            font-size: 1.2em;
            margin-bottom: 30px;
            color: #aeefff;
            text-shadow: 0 0 8px #00ffe0;
        }

        .falling-leaf {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #00ffe0;
            border-radius: 50% 0 50% 0;
            animation: fall 2s linear;
        }

        @keyframes fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
                width: 98%;
            }

            .level-title {
                font-size: 2em;
            }

            .question {
                font-size: 1.5em;
            }

            .options {
                flex-direction: column;
            }

            .game-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="level-header">
            <h1 class="level-title" id="levelTitle">æ¯”è¼ƒç´šå¤§å¸«</h1>
            <h2 class="level-subtitle" id="levelSubtitle">æ¯”è¼ƒç´šæ··åˆé¡Œ</h2>
            <p class="scene-description" id="levelDescription">æ¢ç´¢èªè¨€çš„æ¯”è¼ƒå¥§ç§˜</p>
        </div>

        <div class="game-info">
            <div class="timer">æ™‚é–“ï¼š<span id="timeLeft">03:00</span></div>
            <div class="score">åˆ†æ•¸ï¼š<span id="currentScore">0</span>/100</div>
            <div class="stars">æ˜Ÿæ˜Ÿï¼š<span id="starCount">0</span> â­</div>
            <button class="sound-toggle" onclick="toggleSound()" id="soundToggle">ğŸ”Š</button>
        </div>
        <div style="text-align:center;margin-bottom:20px;">
            <button class="action-btn btn-secondary" id="pauseBtn" onclick="pauseGame()" style="margin:0 8px;">â¸ æš«åœ</button>
            <button class="action-btn btn-primary" id="resumeBtn" onclick="resumeGame()" style="margin:0 8px;display:none;">â–¶ï¸ ç¹¼çºŒ</button>
            <button class="action-btn btn-secondary" onclick="selectSubLevel(1)" style="margin:0 8px;">åŸºç¤</button>
            <button class="action-btn btn-secondary" onclick="selectSubLevel(2)" style="margin:0 8px;">é€²éš</button>
            <button class="action-btn btn-secondary" onclick="selectSubLevel(3)" style="margin:0 8px;">é«˜ç´š</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div class="guardian-statue" id="guardianStatue">âš–ï¸</div>

        <div class="grammar-tip">
            <strong>æ–‡æ³•å°æç¤ºï¼š</strong> æ¯”è¼ƒç´šï¼šå–®éŸ³ç¯€åŠ -erï¼Œå¤šéŸ³ç¯€ç”¨moreï¼Œä¸è¦å‰‡è®ŠåŒ–éœ€è¨˜æ†¶
        </div>

        <div class="question-container" id="questionContainer">
            <div class="question" id="questionText">æº–å‚™é–‹å§‹éŠæˆ²...</div>
            <div class="options" id="optionsContainer"></div>
            <div class="subLevelProgress" id="subLevelProgress"></div>
        </div>

        <div class="hint-buttons">
            <button class="hint-btn" id="wordHintBtn" onclick="useWordHint()">å›°é›£å–®å­—æç¤º (10â­)</button>
            <button class="hint-btn" id="logicHintBtn" onclick="useLogicHint()">åˆ¤æ–·é‚è¼¯æç¤º (20â­)</button>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn btn-secondary" onclick="skipQuestion()">è·³éæ­¤é¡Œ</button>
            <button class="action-btn btn-primary" onclick="nextQuestion()" id="nextBtn" style="display: none;">ä¸‹ä¸€é¡Œ</button>
            <button class="action-btn btn-secondary" onclick="goToMenu()">è¿”å›é¸å–®</button>
            <button class="action-btn btn-secondary" onclick="goToHome()">è¿”å›é¦–é </button>
            <button class="action-btn" onclick="gemSystem.showGemShop()" style="background: linear-gradient(135deg, #00ffe0, #3ecfff); color: #222; border: 1px solid #00ffe0;">ğŸ’ å¯¶çŸ³å•†åº—</button>
        </div>
    </div>

    <div class="result-modal" id="resultModal">
        <div class="result-content">
            <h2 class="result-title" id="resultTitle">éŠæˆ²çµæŸ</h2>
            <div class="result-score" id="resultScore">åˆ†æ•¸ï¼š0/100</div>
            <div class="result-message" id="resultMessage">ç¹¼çºŒåŠªåŠ›ï¼</div>
            <div class="action-buttons">
                <button class="action-btn btn-primary" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
                <button class="action-btn btn-secondary" onclick="goToMenu()">è¿”å›é¸å–®</button>
            </div>
        </div>
    </div>
    
    <script src="js/userData.js"></script>
    <script src="js/grammarLevel22_1_questions.js"></script>
    <script src="js/starRewardSystem.js"></script>
    <script src="js/gemSystem.js"></script>
    <script>
        // éŠæˆ²ç‹€æ…‹
        let gameState = {
            currentLevel: 'level22',
            currentSubLevel: 1,
            currentQuestion: 0,
            score: 0,
            stars: 0,
            timeLeft: 180,
            questions: [],
            currentQuestionData: null,
            timer: null,
            isGameActive: false,
            isSoundEnabled: true,
            logicHintUsed: 0
        };

        // éŸ³æ•ˆç‰©ä»¶
        let sounds = {};

        // è¼‰å…¥éŸ³æ•ˆ
        function loadSounds() {
            try {
                sounds = {
                    correct: new Audio('sound/correct.mp3'),
                    wrong: new Audio('sound/wrong.mp3'),
                    click: new Audio('sound/click.mp3'),
                    complete: new Audio('sound/complete.mp3'),
                    unlock: new Audio('sound/unlock.mp3'),
                    shine: new Audio('sound/shine.mp3')
                };
                Object.values(sounds).forEach(sound => {
                    sound.load();
                    sound.volume = 0.4;
                    sound.preload = 'auto';
                });
                // èƒŒæ™¯éŸ³æ¨‚
                if (!window.bgMusic) {
                    window.bgMusic = new Audio('sound/åˆå¾Œæ”¾é¬†æ™‚å…‰ï¼ˆç´”éŸ³æ¨‚ï¼‰.mp3');
                    window.bgMusic.loop = true;
                    window.bgMusic.volume = 0.25;
                }
                // è‡ªå‹•æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ï¼ˆéœ€ç”¨æˆ¶äº’å‹•è§¸ç™¼ï¼‰
                document.body.addEventListener('click', function playBGOnce() {
                    if (gameState.isSoundEnabled) {
                        window.bgMusic.play().catch(()=>{});
                    }
                    document.body.removeEventListener('click', playBGOnce);
                });
                // è‹¥å·²å•Ÿç”¨éŸ³æ•ˆå‰‡è‡ªå‹•æ’­æ”¾
                if (gameState.isSoundEnabled) {
                    setTimeout(()=>{ window.bgMusic.play().catch(()=>{}); }, 500);
                } else {
                    window.bgMusic.pause();
                }
            } catch (error) {
                console.log('éŸ³æ•ˆè¼‰å…¥å¤±æ•—:', error);
                gameState.isSoundEnabled = false;
            }
        }

        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(soundName) {
            if (!gameState.isSoundEnabled || !sounds[soundName]) {
                return;
            }

            try {
                const sound = sounds[soundName];
                sound.pause();
                sound.currentTime = 0;
                sound.play().catch(error => {
                    console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
                });
            } catch (error) {
                console.log('éŸ³æ•ˆæ’­æ”¾éŒ¯èª¤:', error);
            }
        }

        // åˆ‡æ›éŸ³æ•ˆé–‹é—œ
        function toggleSound() {
            gameState.isSoundEnabled = !gameState.isSoundEnabled;
            const soundToggle = document.getElementById('soundToggle');
            
            if (gameState.isSoundEnabled) {
                soundToggle.textContent = 'ğŸ”Š';
                soundToggle.classList.remove('muted');
                if (window.bgMusic) window.bgMusic.play().catch(()=>{});
            } else {
                soundToggle.textContent = 'ğŸ”‡';
                soundToggle.classList.add('muted');
                if (window.bgMusic) window.bgMusic.pause();
            }
            
            saveUserData();
        }

        // è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
        function loadUserData() {
            try {
                // å¾LinkageSystemè¼‰å…¥æ˜Ÿæ˜Ÿæ•¸æ“š
                if (typeof LinkageSystem !== 'undefined' && LinkageSystem.stars) {
                    gameState.stars = LinkageSystem.stars.get();
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šå¾localStorageè¼‰å…¥
                    gameState.stars = parseInt(localStorage.getItem('totalStars') || '50'); // é è¨­çµ¦50é¡†æ˜Ÿæ˜Ÿæ–¹ä¾¿æ¸¬è©¦
                }
                
                // ç¢ºä¿è‡³å°‘æœ‰ä¸€äº›æ˜Ÿæ˜Ÿé€²è¡Œæ¸¬è©¦
                if (gameState.stars < 50) {
                    gameState.stars = 50;
                    console.log('ç‚ºæ¸¬è©¦ç›®çš„ï¼Œè¨­å®šåˆå§‹æ˜Ÿæ˜Ÿæ•¸ç‚º50');
                }
                
                // è¼‰å…¥éŸ³æ•ˆè¨­å®š
                const savedData = localStorage.getItem('grammarGameData');
                if (savedData) {
                    const userData = JSON.parse(savedData);
                    gameState.isSoundEnabled = userData.isSoundEnabled !== false;
                }
                
                // åˆå§‹åŒ–éŸ³æ•ˆé–‹é—œç‹€æ…‹
                const soundToggle = document.getElementById('soundToggle');
                if (gameState.isSoundEnabled) {
                    soundToggle.textContent = 'ğŸ”Š';
                    soundToggle.classList.remove('muted');
                } else {
                    soundToggle.textContent = 'ğŸ”‡';
                    soundToggle.classList.add('muted');
                }
            } catch (error) {
                console.log('è¼‰å…¥ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
                gameState.stars = 50; // éŒ¯èª¤æ™‚çµ¦äºˆé è¨­æ˜Ÿæ˜Ÿæ•¸
            }
        }

        // ä¿å­˜ç”¨æˆ¶æ•¸æ“š
        function saveUserData() {
            try {
                // åŒæ­¥æ˜Ÿæ˜Ÿæ•¸æ“šåˆ°LinkageSystem
                if (typeof LinkageSystem !== 'undefined' && LinkageSystem.stars) {
                    LinkageSystem.stars.set(gameState.stars);
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä¿å­˜åˆ°localStorage
                    localStorage.setItem('totalStars', gameState.stars.toString());
                }
                
                // ä¿å­˜éŸ³æ•ˆè¨­å®š
                const userData = {
                    isSoundEnabled: gameState.isSoundEnabled,
                    lastPlayed: new Date().toISOString()
                };
                localStorage.setItem('grammarGameData', JSON.stringify(userData));
            } catch (error) {
                console.log('ä¿å­˜ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            }
        }

        // æ›´æ–°é—œå¡é¡¯ç¤º
        function updateLevelDisplay() {
            const levelNames = {
                1: 'åŸºç¤æ¯”è¼ƒç´š',
                2: 'é€²éšæ¯”è¼ƒç´š', 
                3: 'é«˜ç´šæ¯”è¼ƒç´š'
            };
            const levelDescriptions = {
                1: 'å­¸ç¿’åŸºæœ¬çš„æ¯”è¼ƒç´šè¦å‰‡',
                2: 'æŒæ¡è¤‡é›œçš„æ¯”è¼ƒç´šè®ŠåŒ–',
                3: 'æŒ‘æˆ°é«˜é›£åº¦æ¯”è¼ƒç´šé¡Œç›®'
            };
            
            document.getElementById('levelTitle').textContent = levelNames[gameState.currentSubLevel] || 'æ¯”è¼ƒç´šå¤§å¸«';
            document.getElementById('levelSubtitle').textContent = 'æ¯”è¼ƒç´šæ··åˆé¡Œ';
            document.getElementById('levelDescription').textContent = levelDescriptions[gameState.currentSubLevel] || 'æ¢ç´¢èªè¨€çš„æ¯”è¼ƒå¥§ç§˜';
        }

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            loadSounds();
            loadUserData();
            // ä½¿ç”¨æ–°é¡Œåº«ç³»çµ±
            gameState.questions = getRandomQuestions(gameState.currentSubLevel, 10);
            gameState.logicHintUsed = 0;
            
            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('resumeBtn').style.display = 'none';
            
            updateLevelDisplay();
            startGame();
        }

        // é¸æ“‡å­é—œå¡
        function selectSubLevel(subLevel) {
            gameState.currentSubLevel = subLevel;
            // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            // é‡æ–°åˆå§‹åŒ–éŠæˆ²
            initGame();
        }
        
        // é–‹å§‹éŠæˆ²
        function startGame() {
            gameState.isGameActive = true;
            gameState.currentQuestion = 0;
            gameState.score = 0;
            gameState.timeLeft = 180; // 3åˆ†é˜
            
            // ç«‹å³æ›´æ–°æ™‚é–“é¡¯ç¤º
            document.getElementById('timeLeft').textContent = formatTime(gameState.timeLeft);
            updateDisplay();
            loadQuestion();
            startTimer();
        }

        // è¼‰å…¥é¡Œç›®
        function loadQuestion() {
            if (gameState.currentQuestion >= gameState.questions.length) {
                endGame();
                return;
            }

            gameState.currentQuestionData = gameState.questions[gameState.currentQuestion];
            document.getElementById('questionText').textContent = gameState.currentQuestionData.question;
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            gameState.currentQuestionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option';
                button.textContent = option;
                button.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(button);
            });
            // éš±è—ä¸‹ä¸€é¡ŒæŒ‰éˆ•
            document.getElementById('nextBtn').style.display = 'none';
            // éš±è—æ‰€æœ‰æç¤ºå€å¡Š
            hideAllHints();
            // é¡¯ç¤ºå°é—œé€²åº¦
            let progressDiv = document.getElementById('subLevelProgress');
            if (!progressDiv) {
                progressDiv = document.createElement('div');
                progressDiv.id = 'subLevelProgress';
                progressDiv.style.cssText = 'margin: 10px 0 0 0; font-size: 1.1em; color: #4a5568; font-weight: bold;';
                document.getElementById('questionContainer').appendChild(progressDiv);
            }
            progressDiv.textContent = `æœ¬å°é—œé€²åº¦ï¼šç¬¬${gameState.currentQuestion + 1} / ${gameState.questions.length}é¡Œ`;
            updateProgress();
        }
        
        // é¸æ“‡ç­”æ¡ˆ
        function selectAnswer(selectedIndex) {
            if (!gameState.isGameActive) return;
            playSound('click');
            const options = document.querySelectorAll('.option');
            const correctIndex = gameState.currentQuestionData.correct;
            // ç¦ç”¨æ‰€æœ‰é¸é …
            options.forEach(option => option.style.pointerEvents = 'none');
            if (selectedIndex === correctIndex) {
                // ç­”å°
                options[selectedIndex].classList.add('correct');
                gameState.score += 10;
                gameState.stars += 2; // ç­”å°ç²å¾—2é¡†æ˜Ÿæ˜Ÿ
                if (typeof StarRewardSystem !== 'undefined') StarRewardSystem.addStars(2);
                // æª¢æŸ¥æ˜¯å¦å›°é›£é¡Œï¼ˆhardï¼‰
                if (gameState.currentQuestionData.difficulty === 'hard' || gameState.currentQuestionData.isHard) {
                    gameState.stars += 3;
                    if (typeof StarRewardSystem !== 'undefined') StarRewardSystem.addStars(3);
                }
                // å®ˆè­·è€…é›•åƒç™¼å…‰
                const statue = document.getElementById('guardianStatue');
                statue.classList.add('shine');
                setTimeout(() => statue.classList.remove('shine'), 500);
                playSound('correct');
                // ç­”å°ç›´æ¥é€²å…¥ä¸‹ä¸€é¡Œ
                setTimeout(() => {
                    gameState.currentQuestion++;
                    loadQuestion();
                }, 1000);
            } else {
                // ç­”éŒ¯
                options[selectedIndex].classList.add('incorrect');
                options[correctIndex].classList.add('correct');
                createFallingLeaf();
                playSound('wrong');
                // ç­”éŒ¯é¡¯ç¤ºè§£é‡‹å’Œä¸‹ä¸€é¡ŒæŒ‰éˆ•
                setTimeout(() => {
                    showExplanation();
                    document.getElementById('nextBtn').style.display = 'inline-block';
                }, 1500);
            }
            updateDisplay();
            saveUserData();
        }

        // é¡¯ç¤ºè§£é‡‹
        function showExplanation() {
            const questionText = document.getElementById('questionText');
            const originalText = questionText.textContent;
            questionText.innerHTML = `
                <div style="margin-bottom: 15px;">${originalText}</div>
                <div class="answer-explanation">${gameState.currentQuestionData.explanation}</div>
            `;
            setTimeout(() => {
                gameState.currentQuestion++;
                loadQuestion();
            }, 2000);
        }
        
        // ä½¿ç”¨å›°é›£å–®å­—æç¤º
        function useWordHint() {
            if (gameState.stars < 10) {
                alert('æ˜Ÿæ˜Ÿä¸è¶³ï¼éœ€è¦10é¡†æ˜Ÿæ˜Ÿæ‰èƒ½ä½¿ç”¨å›°é›£å–®å­—æç¤ºï¼');
                return;
            }
            playSound('click');
            gameState.stars -= 10;
            updateDisplay();
            saveUserData();

            // å–å¾—æœ¬é¡Œå›°é›£å–®å­—
            const question = gameState.currentQuestionData.question;
            let foundWords = [];
            
            // æª¢æŸ¥DIFFICULT_WORDSæ˜¯å¦å­˜åœ¨
            if (typeof DIFFICULT_WORDS === 'undefined') {
                console.error('DIFFICULT_WORDS æœªå®šç¾©');
                alert('å›°é›£å–®å­—å­—å…¸è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
                return;
            }
            
            // å¾é¡Œç›®ä¸­æå–è‹±æ–‡å–®å­—
            question.replace(/\b([a-zA-Z]+)\b/g, function(word) {
                const lower = word.toLowerCase();
                if (DIFFICULT_WORDS[lower]) {
                    foundWords.push({ en: word, zh: DIFFICULT_WORDS[lower] });
                }
            });
            
            console.log('é¡Œç›®:', question);
            console.log('æ‰¾åˆ°çš„å›°é›£å–®å­—:', foundWords);
            
            // ä¹Ÿæª¢æŸ¥é¡Œç›®çš„ difficultWords æ¬„ä½
            if (gameState.currentQuestionData.difficultWords) {
                gameState.currentQuestionData.difficultWords.forEach(word => {
                    const lower = word.toLowerCase();
                    if (DIFFICULT_WORDS[lower]) {
                        // é¿å…é‡è¤‡
                        if (!foundWords.some(w => w.en.toLowerCase() === lower)) {
                            foundWords.push({ en: word, zh: DIFFICULT_WORDS[lower] });
                        }
                    }
                });
            }
            
            let hintDiv = document.getElementById('wordHintDiv');
            if (!hintDiv) {
                hintDiv = document.createElement('div');
                hintDiv.id = 'wordHintDiv';
                document.getElementById('questionContainer').appendChild(hintDiv);
            }
            
            if (foundWords.length > 0) {
                hintDiv.innerHTML = `<strong>æœ¬é¡Œå›°é›£å–®å­—ï¼š</strong><br>` +
                    foundWords.map(w => `<span class='word-block'>${w.en}</span> <span class='zh'>${w.zh}</span>`).join('<br>');
                hintDiv.style.display = 'block';
            } else {
                hintDiv.innerHTML = '<strong>æœ¬é¡Œç„¡éœ€è¦ç‰¹åˆ¥æ³¨æ„çš„å›°é›£å–®å­—ã€‚</strong>';
                hintDiv.style.display = 'block';
            }
        }

        // ä½¿ç”¨åˆ¤æ–·é‚è¼¯æç¤º
        function useLogicHint() {
            if (gameState.stars < 20) {
                alert('æ˜Ÿæ˜Ÿä¸è¶³ï¼');
                return;
            }
            playSound('click');
            gameState.stars -= 20;
            updateDisplay();
            saveUserData();
            // è™•ç†æç¤ºå€å¡Š
            const questionText = document.getElementById('questionText');
            let logicHintDiv = document.getElementById('logicHintDiv');
            if (!logicHintDiv) {
                logicHintDiv = document.createElement('div');
                logicHintDiv.id = 'logicHintDiv';
                logicHintDiv.className = 'logic-hint';
                let wordHintDiv = document.getElementById('wordHintDiv');
                if (wordHintDiv && wordHintDiv.nextSibling) {
                    questionText.parentNode.insertBefore(logicHintDiv, wordHintDiv.nextSibling);
                } else {
                    questionText.parentNode.insertBefore(logicHintDiv, questionText.nextSibling);
                }
            }
            // é¡¯ç¤ºæç¤ºå€å¡Š
            logicHintDiv.style.display = 'block';
            // ä½¿ç”¨é¡Œç›®å°ˆå±¬çš„åˆ¤æ–·æç¤º
            let logicHint = gameState.currentQuestionData.logicHint || 'è¨˜ä½ï¼šå–®éŸ³ç¯€åŠ -erï¼Œå¤šéŸ³ç¯€ç”¨moreï¼Œä¸è¦å‰‡è®ŠåŒ–éœ€è¨˜æ†¶ã€‚';
            logicHintDiv.innerHTML = `<strong>åˆ¤æ–·é‚è¼¯æç¤ºï¼š</strong>${logicHint}`;
        }

        // è·³éæ­¤é¡Œ
        function skipQuestion() {
            if (confirm('ç¢ºå®šè¦è·³éé€™é¡Œå—ï¼Ÿè·³éå¾Œç„¡æ³•è¿”å›ã€‚')) {
                playSound('click');
                gameState.currentQuestion++;
                loadQuestion();
            }
        }

        // ä¸‹ä¸€é¡Œ
        function nextQuestion() {
            playSound('click');
            gameState.currentQuestion++;
            loadQuestion();
            document.getElementById('nextBtn').style.display = 'none';
        }

        // é–‹å§‹è¨ˆæ™‚å™¨
        function startTimer() {
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                updateDisplay();
                
                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // æš«åœ/ç¹¼çºŒåŠŸèƒ½
        function pauseGame() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            gameState.isGameActive = false;
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('resumeBtn').style.display = 'inline-block';
        }
        function resumeGame() {
            gameState.isGameActive = true;
            startTimer();
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('resumeBtn').style.display = 'none';
        }
        
        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            document.getElementById('timeLeft').textContent = formatTime(gameState.timeLeft);
            const maxScore = gameState.questions.length * 10;
            document.getElementById('currentScore').textContent = `${gameState.score}/${maxScore}`;
            document.getElementById('starCount').textContent = gameState.stars;
            
            // æ›´æ–°é€²åº¦æ¢
            const progress = (gameState.currentQuestion / gameState.questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // æ›´æ–°è¨ˆæ™‚å™¨é¡è‰²
            const timerElement = document.getElementById('timeLeft');
            if (gameState.timeLeft <= 30) {
                timerElement.style.color = '#e53e3e';
            } else if (gameState.timeLeft <= 60) {
                timerElement.style.color = '#ed8936';
            } else {
                timerElement.style.color = '#00ffe0';
            }
            
            // åŒæ­¥æ›´æ–°LinkageSystemçš„æ˜Ÿæ˜Ÿé¡¯ç¤º
            if (typeof LinkageSystem !== 'undefined' && LinkageSystem.stars) {
                LinkageSystem.stars.updateDisplay();
            }
        }

        // éš±è—æ‰€æœ‰æç¤ºå€å¡Š
        function hideAllHints() {
            // éš±è—å–®å­—æç¤º
            const wordHintDiv = document.getElementById('wordHintDiv');
            if (wordHintDiv) {
                wordHintDiv.style.display = 'none';
            }
            // éš±è—åˆ¤æ–·é‚è¼¯æç¤º
            const logicHintDiv = document.getElementById('logicHintDiv');
            if (logicHintDiv) {
                logicHintDiv.style.display = 'none';
            }
        }

        // æ›´æ–°é€²åº¦
        function updateProgress() {
            const progress = (gameState.currentQuestion / gameState.questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        // çµæŸéŠæˆ²
        function endGame() {
            gameState.isGameActive = false;
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            const resultModal = document.getElementById('resultModal');
            const resultTitle = document.getElementById('resultTitle');
            const resultScore = document.getElementById('resultScore');
            const resultMessage = document.getElementById('resultMessage');
            const maxScore = gameState.questions.length * 10;
            resultScore.textContent = `åˆ†æ•¸ï¼š${gameState.score}/${maxScore}`;
            // åˆ¤æ–·ç›®å‰å°é—œ
            let nextSub = null;
            if (gameState.currentSubLevel === 1) nextSub = 2;
            else if (gameState.currentSubLevel === 2) nextSub = 3;
            // é€šé—œåˆ¤æ–·
            if (gameState.score >= maxScore * 0.7) {
                if (nextSub) {
                    resultTitle.textContent = 'éšæ®µå®Œæˆï¼';
                    resultTitle.style.color = '#38a169';
                    resultMessage.textContent = `ä½ å®Œæˆäº†é—œå¡ï¼é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²å…¥ä¸‹ä¸€éšæ®µã€‚`;
                } else {
                    resultTitle.textContent = 'æ­å–œé€šé—œï¼';
                    resultTitle.style.color = '#38a169';
                    resultMessage.textContent = `ä½ æˆåŠŸå®Œæˆäº†æ¯”è¼ƒç´šæŒ‘æˆ°ï¼ç²å¾—ã€Œâš–ï¸ æ¯”è¼ƒå¤©ç§¤çŸ³ã€1é¡†ï¼Œé¡å¤–çå‹µ10é¡†æ˜Ÿæ˜Ÿï¼`;
                    gameState.stars += 10; // é€šé—œçå‹µ10é¡†æ˜Ÿæ˜Ÿ
                    
                    // é€šé—œå¯¶çŸ³çå‹µ
                    try {
                        if (typeof gemSystem !== 'undefined' && gemSystem.addGem) {
                            gemSystem.addGem('æ¯”è¼ƒç´šå¯¶çŸ³', 1);
                            console.log('æˆåŠŸç²å¾—æ¯”è¼ƒç´šå¯¶çŸ³ 1é¡†');
                        } else {
                            console.log('å¯¶çŸ³ç³»çµ±æœªè¼‰å…¥ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ');
                            // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä¿å­˜åˆ°localStorage
                            const userData = JSON.parse(localStorage.getItem('grammarGameData') || '{}');
                            if (!userData.gems) userData.gems = {};
                            userData.gems['æ¯”è¼ƒç´šå¯¶çŸ³'] = (userData.gems['æ¯”è¼ƒç´šå¯¶çŸ³'] || 0) + 1;
                            localStorage.setItem('grammarGameData', JSON.stringify(userData));
                            console.log('å‚™ç”¨æ–¹æ¡ˆï¼šæ¯”è¼ƒç´šå¯¶çŸ³å·²ä¿å­˜åˆ°localStorage');
                        }
                    } catch (error) {
                        console.log('å¯¶çŸ³çå‹µå¤±æ•—:', error);
                    }
                    
                    // æ–°å¢ï¼šæ’­æ”¾é€šé—œèƒŒæ™¯éŸ³æ¨‚ï¼Œæš«åœèƒŒæ™¯éŸ³æ¨‚
                    try {
                        if (window.bgMusic) window.bgMusic.pause();
                        if (!window.kidsHappyMusic) {
                            window.kidsHappyMusic = new Audio('sound/kids-happy-background-music-366043.mp3');
                            window.kidsHappyMusic.volume = 0.7;
                        }
                        window.kidsHappyMusic.pause();
                        window.kidsHappyMusic.currentTime = 0;
                        const playPromise = window.kidsHappyMusic.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                resultMessage.innerHTML += '<br><span style="color:#ff6b6b;font-size:1rem;">ğŸµ é€šé—œéŸ³æ¨‚æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š</span>';
                                console.warn('é€šé—œéŸ³æ¨‚æ’­æ”¾å¤±æ•—', error);
                            });
                        }
                    } catch (e) {
                        resultMessage.innerHTML += '<br><span style="color:#ff6b6b;font-size:1rem;">ğŸµ é€šé—œéŸ³æ¨‚æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š</span>';
                        console.warn('é€šé—œéŸ³æ¨‚æ’­æ”¾å¤±æ•—', e);
                    }
                    
                    playSound('complete');
                    playSound('unlock');
                }
            } else {
                resultTitle.textContent = 'æŒ‘æˆ°å¤±æ•—';
                resultTitle.style.color = '#e53e3e';
                resultMessage.textContent = `åˆ†æ•¸æœªé”${Math.ceil(maxScore * 0.7)}åˆ†ï¼Œè«‹å†æ¥å†å²ï¼`;
            }
            saveUserData();
            // é¡¯ç¤ºä¸‹ä¸€éšæ®µæŒ‰éˆ•
            const actionBtns = resultModal.querySelector('.action-buttons');
            let nextBtn = document.getElementById('nextStageBtn');
            if (nextBtn) nextBtn.remove();
            if (nextSub && gameState.score >= maxScore * 0.7) {
                nextBtn = document.createElement('button');
                nextBtn.id = 'nextStageBtn';
                nextBtn.className = 'action-btn btn-primary';
                nextBtn.textContent = 'é€²å…¥ä¸‹ä¸€éšæ®µ';
                nextBtn.onclick = function() {
                    playSound('click');
                    gameState.currentSubLevel = nextSub;
                    document.getElementById('resultModal').style.display = 'none';
                    initGame();
                };
                actionBtns.appendChild(nextBtn);
            }
            resultModal.style.display = 'flex';
        }
        
        // é‡æ–°é–‹å§‹éŠæˆ²
        function restartGame() {
            playSound('click');
            // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            document.getElementById('resultModal').style.display = 'none';
            initGame();
        }
        
        // è¿”å›é¸å–®
        function goToMenu() {
            playSound('click');
            window.location.href = 'grammar_tower_select.html';
        }

        // è¿”å›é¦–é 
        function goToHome() {
            playSound('click');
            window.location.href = 'index.html';
        }
        

        // å·¥å…·å‡½æ•¸
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function formatTime(seconds) {
            // ç¢ºä¿æ™‚é–“ä¸æœƒæ˜¯è² æ•¸
            if (seconds < 0) seconds = 0;
            
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function createFallingLeaf() {
            const leaf = document.createElement('div');
            leaf.className = 'falling-leaf';
            leaf.style.left = Math.random() * window.innerWidth + 'px';
            document.body.appendChild(leaf);
            
            setTimeout(() => {
                document.body.removeChild(leaf);
            }, 2000);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–éŠæˆ²
        window.onload = function() {
            initGame();
        };
    </script>
</body>
</html> 