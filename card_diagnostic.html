<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡ç‰‡è³‡æ–™è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .diagnostic-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .diagnostic-section h2 {
            color: #00ffff;
            margin-top: 0;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 10px;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
            color: #00ff00;
        }
        
        .status.warning {
            background: rgba(255, 255, 0, 0.2);
            border: 1px solid #ffff00;
            color: #ffff00;
        }
        
        .status.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
            color: #ff0000;
        }
        
        .card-list {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            border-left: 4px solid #00ffff;
        }
        
        .card-item.problem {
            border-left-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }
        
        .card-item.fixed {
            border-left-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }
        
        .button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        
        .button.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
        }
        
        .stat-label {
            color: #ccc;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å¡ç‰‡è³‡æ–™è¨ºæ–·å·¥å…·</h1>
        
        <div class="diagnostic-section">
            <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h2>
            <div id="systemStatus"></div>
            <button class="button" onclick="runDiagnostic()">ğŸ” åŸ·è¡Œè¨ºæ–·</button>
            <button class="button success" onclick="fixProblems()">ğŸ”§ è‡ªå‹•ä¿®å¾©</button>
            <button class="button danger" onclick="resetCardData()">ğŸ—‘ï¸ é‡ç½®å¡ç‰‡è³‡æ–™</button>
        </div>
        
        <div class="diagnostic-section">
            <h2>ğŸ“ˆ çµ±è¨ˆè³‡æ–™</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>
        
        <div class="diagnostic-section">
            <h2>âš ï¸ ç™¼ç¾çš„å•é¡Œ</h2>
            <div id="problemsList"></div>
        </div>
        
        <div class="diagnostic-section">
            <h2>âœ… ä¿®å¾©çµæœ</h2>
            <div id="fixResults"></div>
        </div>
    </div>

    <script src="js/userData.js"></script>
    <script src="js/cardStorage.js"></script>
    <script>
        let diagnosticResults = {
            problems: [],
            fixed: [],
            stats: {}
        };

        function runDiagnostic() {
            diagnosticResults = {
                problems: [],
                fixed: [],
                stats: {}
            };
            
            console.log('ğŸ” é–‹å§‹åŸ·è¡Œå¡ç‰‡è³‡æ–™è¨ºæ–·...');
            
            // æª¢æŸ¥ç³»çµ±æ˜¯å¦è¼‰å…¥
            checkSystemLoaded();
            
            // æª¢æŸ¥å¡ç‰‡è³‡æ–™å®Œæ•´æ€§
            checkCardDataIntegrity();
            
            // æª¢æŸ¥ç¢ç‰‡è³‡æ–™ä¸€è‡´æ€§
            checkShardConsistency();
            
            // æª¢æŸ¥å·²è§£é–å¡ç‰‡ç‹€æ…‹
            checkUnlockedCards();
            
            // æ›´æ–°é¡¯ç¤º
            updateDisplay();
        }

        function checkSystemLoaded() {
            const status = document.getElementById('systemStatus');
            
            if (typeof LinkageSystem === 'undefined') {
                diagnosticResults.problems.push({
                    type: 'system',
                    message: 'LinkageSystem æœªè¼‰å…¥',
                    severity: 'error'
                });
                status.innerHTML = '<div class="status error">âŒ ç³»çµ±æœªæ­£ç¢ºè¼‰å…¥</div>';
                return;
            }
            
            if (typeof window.allCards === 'undefined' || !window.allCards.length) {
                diagnosticResults.problems.push({
                    type: 'system',
                    message: 'å¡ç‰‡è³‡æ–™æœªè¼‰å…¥',
                    severity: 'error'
                });
                status.innerHTML = '<div class="status error">âŒ å¡ç‰‡è³‡æ–™æœªè¼‰å…¥</div>';
                return;
            }
            
            status.innerHTML = '<div class="status success">âœ… ç³»çµ±æ­£å¸¸è¼‰å…¥</div>';
        }

        function checkCardDataIntegrity() {
            console.log('ğŸ” æª¢æŸ¥å¡ç‰‡è³‡æ–™å®Œæ•´æ€§...');
            
            const ownedCards = LinkageSystem.cards.getOwnedCards();
            const shards = LinkageSystem.cards.getShards();
            
            diagnosticResults.stats = {
                totalCards: window.allCards.length,
                ownedCards: Object.keys(ownedCards).length,
                totalShards: Object.values(shards).reduce((sum, count) => sum + (parseInt(count) || 0), 0),
                shardTypes: Object.keys(shards).length
            };
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å¡ç‰‡åœ¨ ownedCards ä¸­ä½†ä¸åœ¨ allCards ä¸­
            const invalidOwnedCards = Object.keys(ownedCards).filter(cardWord => 
                !window.allCards.find(card => card.word === cardWord)
            );
            
            if (invalidOwnedCards.length > 0) {
                diagnosticResults.problems.push({
                    type: 'integrity',
                    message: `ç™¼ç¾ ${invalidOwnedCards.length} å¼µç„¡æ•ˆçš„å·²æ“æœ‰å¡ç‰‡`,
                    details: invalidOwnedCards,
                    severity: 'warning'
                });
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ç¢ç‰‡ä½†å¡ç‰‡ä¸å­˜åœ¨
            const invalidShards = Object.keys(shards).filter(cardWord => 
                !window.allCards.find(card => card.word === cardWord)
            );
            
            if (invalidShards.length > 0) {
                diagnosticResults.problems.push({
                    type: 'integrity',
                    message: `ç™¼ç¾ ${invalidShards.length} å€‹ç„¡æ•ˆçš„ç¢ç‰‡è¨˜éŒ„`,
                    details: invalidShards,
                    severity: 'warning'
                });
            }
        }

        function checkShardConsistency() {
            console.log('ğŸ” æª¢æŸ¥ç¢ç‰‡è³‡æ–™ä¸€è‡´æ€§...');
            
            const ownedCards = LinkageSystem.cards.getOwnedCards();
            const shards = LinkageSystem.cards.getShards();
            
            // æª¢æŸ¥å·²è§£é–å¡ç‰‡æ˜¯å¦æœ‰å¤šé¤˜ç¢ç‰‡
            const unlockedWithExcessShards = [];
            
            Object.keys(ownedCards).forEach(cardWord => {
                const card = window.allCards.find(c => c.word === cardWord);
                if (!card) return;
                
                const required = getRequiredShards(card.rarity);
                const haveShards = shards[cardWord] || 0;
                
                if (haveShards > required) {
                    unlockedWithExcessShards.push({
                        card: card,
                        required: required,
                        have: haveShards,
                        excess: haveShards - required
                    });
                }
            });
            
            if (unlockedWithExcessShards.length > 0) {
                diagnosticResults.problems.push({
                    type: 'consistency',
                    message: `ç™¼ç¾ ${unlockedWithExcessShards.length} å¼µå·²è§£é–å¡ç‰‡æœ‰å¤šé¤˜ç¢ç‰‡`,
                    details: unlockedWithExcessShards,
                    severity: 'warning'
                });
            }
        }

        function checkUnlockedCards() {
            console.log('ğŸ” æª¢æŸ¥å·²è§£é–å¡ç‰‡ç‹€æ…‹...');
            
            const ownedCards = LinkageSystem.cards.getOwnedCards();
            const shards = LinkageSystem.cards.getShards();
            
            // æª¢æŸ¥æ‡‰è©²è§£é–ä½†æœªè§£é–çš„å¡ç‰‡
            const shouldBeUnlocked = [];
            
            window.allCards.forEach(card => {
                const required = getRequiredShards(card.rarity);
                const haveShards = shards[card.word] || 0;
                const isOwned = ownedCards[card.word] || false;
                
                if (haveShards >= required && !isOwned) {
                    shouldBeUnlocked.push({
                        card: card,
                        required: required,
                        have: haveShards
                    });
                }
            });
            
            if (shouldBeUnlocked.length > 0) {
                diagnosticResults.problems.push({
                    type: 'unlock',
                    message: `ç™¼ç¾ ${shouldBeUnlocked.length} å¼µå¡ç‰‡æ‡‰è©²è§£é–ä½†æœªè§£é–`,
                    details: shouldBeUnlocked,
                    severity: 'error'
                });
            }
            
            // æª¢æŸ¥å·²è§£é–ä½†ç¢ç‰‡ä¸è¶³çš„å¡ç‰‡
            const unlockedWithInsufficientShards = [];
            
            Object.keys(ownedCards).forEach(cardWord => {
                const card = window.allCards.find(c => c.word === cardWord);
                if (!card) return;
                
                const required = getRequiredShards(card.rarity);
                const haveShards = shards[cardWord] || 0;
                
                if (haveShards < required) {
                    unlockedWithInsufficientShards.push({
                        card: card,
                        required: required,
                        have: haveShards
                    });
                }
            });
            
            if (unlockedWithInsufficientShards.length > 0) {
                diagnosticResults.problems.push({
                    type: 'unlock',
                    message: `ç™¼ç¾ ${unlockedWithInsufficientShards.length} å¼µå·²è§£é–å¡ç‰‡ç¢ç‰‡ä¸è¶³`,
                    details: unlockedWithInsufficientShards,
                    severity: 'warning'
                });
            }
        }

        function fixProblems() {
            console.log('ğŸ”§ é–‹å§‹è‡ªå‹•ä¿®å¾©...');
            
            const fixResults = [];
            
            diagnosticResults.problems.forEach(problem => {
                if (problem.type === 'unlock') {
                    // ä¿®å¾©æ‡‰è©²è§£é–ä½†æœªè§£é–çš„å¡ç‰‡
                    problem.details.forEach(item => {
                        LinkageSystem.cards.addCard(item.card.word);
                        fixResults.push(`âœ… è§£é–å¡ç‰‡: ${item.card.zh} (${item.card.word})`);
                    });
                }
                
                if (problem.type === 'integrity') {
                    // æ¸…ç†ç„¡æ•ˆçš„ç¢ç‰‡è¨˜éŒ„
                    if (problem.message.includes('ç„¡æ•ˆçš„ç¢ç‰‡è¨˜éŒ„')) {
                        const shards = LinkageSystem.cards.getShards();
                        problem.details.forEach(cardWord => {
                            delete shards[cardWord];
                            fixResults.push(`ğŸ—‘ï¸ æ¸…ç†ç„¡æ•ˆç¢ç‰‡: ${cardWord}`);
                        });
                        LinkageSystem.cards.setShards(shards);
                    }
                    
                    // æ¸…ç†ç„¡æ•ˆçš„å·²æ“æœ‰å¡ç‰‡
                    if (problem.message.includes('ç„¡æ•ˆçš„å·²æ“æœ‰å¡ç‰‡')) {
                        const ownedCards = LinkageSystem.cards.getOwnedCards();
                        problem.details.forEach(cardWord => {
                            delete ownedCards[cardWord];
                            fixResults.push(`ğŸ—‘ï¸ æ¸…ç†ç„¡æ•ˆå¡ç‰‡: ${cardWord}`);
                        });
                        LinkageSystem.cards.setOwnedCards(ownedCards);
                    }
                }
            });
            
            diagnosticResults.fixed = fixResults;
            
            // é‡æ–°åŸ·è¡Œè¨ºæ–·
            setTimeout(() => {
                runDiagnostic();
            }, 100);
        }

        function resetCardData() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å¡ç‰‡è³‡æ–™å—ï¼Ÿ\n\né€™å°‡æœƒï¼š\nâ€¢ æ¸…é™¤æ‰€æœ‰å·²è§£é–çš„å¡ç‰‡\nâ€¢ æ¸…é™¤æ‰€æœ‰ç¢ç‰‡\nâ€¢ ç„¡æ³•å¾©åŸ\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }
            
            // æ¸…é™¤å¡ç‰‡è³‡æ–™
            localStorage.removeItem('ownedCards');
            localStorage.removeItem('cardShards');
            localStorage.removeItem('recentlyObtainedCards');
            localStorage.removeItem('newCardTimestamps');
            
            // é‡æ–°è¼‰å…¥é é¢
            location.reload();
        }

        function updateDisplay() {
            // æ›´æ–°çµ±è¨ˆè³‡æ–™
            const statsGrid = document.getElementById('statsGrid');
            if (diagnosticResults.stats) {
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${diagnosticResults.stats.totalCards || 0}</div>
                        <div class="stat-label">ç¸½å¡ç‰‡æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${diagnosticResults.stats.ownedCards || 0}</div>
                        <div class="stat-label">å·²è§£é–å¡ç‰‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${diagnosticResults.stats.totalShards || 0}</div>
                        <div class="stat-label">ç¸½ç¢ç‰‡æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${diagnosticResults.stats.shardTypes || 0}</div>
                        <div class="stat-label">ç¢ç‰‡ç¨®é¡</div>
                    </div>
                `;
            }
            
            // æ›´æ–°å•é¡Œåˆ—è¡¨
            const problemsList = document.getElementById('problemsList');
            if (diagnosticResults.problems.length === 0) {
                problemsList.innerHTML = '<div class="status success">âœ… æ²’æœ‰ç™¼ç¾å•é¡Œ</div>';
            } else {
                problemsList.innerHTML = diagnosticResults.problems.map(problem => `
                    <div class="card-item ${problem.severity === 'error' ? 'problem' : 'warning'}">
                        <div>
                            <strong>${problem.message}</strong>
                            ${problem.details ? `<br><small>${JSON.stringify(problem.details)}</small>` : ''}
                        </div>
                        <div style="color: ${problem.severity === 'error' ? '#ff0000' : '#ffff00'}">
                            ${problem.severity === 'error' ? 'âŒ éŒ¯èª¤' : 'âš ï¸ è­¦å‘Š'}
                        </div>
                    </div>
                `).join('');
            }
            
            // æ›´æ–°ä¿®å¾©çµæœ
            const fixResults = document.getElementById('fixResults');
            if (diagnosticResults.fixed.length === 0) {
                fixResults.innerHTML = '<div class="status">å°šæœªåŸ·è¡Œä¿®å¾©</div>';
            } else {
                fixResults.innerHTML = diagnosticResults.fixed.map(result => `
                    <div class="card-item fixed">
                        <div>${result}</div>
                    </div>
                `).join('');
            }
        }

        function getRequiredShards(rarity) {
            switch (rarity) {
                case 'è¶…ç¨€æœ‰': return 5;
                case 'ç¨€æœ‰': return 3;
                case 'æ™®é€š': return 1;
                default: return 1;
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œè¨ºæ–·
        window.addEventListener('load', () => {
            setTimeout(() => {
                runDiagnostic();
            }, 1000);
        });
    </script>
</body>
</html> 