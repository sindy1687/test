<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>填空挑戰 - 英打小英雄</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="responsive_enhanced.css">
  <style>
    /* 防止水平滾動 */
    html {
      overflow-x: hidden;
    }
    
    /* 確保所有元素都在視窗範圍內 */
    * {
      box-sizing: border-box;
      max-width: 100%;
    }
    
    /* ===== 基礎樣式 ===== */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif, 'Orbitron', sans-serif;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      color: #fff;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      width: 100%;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    h1 {
      color: #ffd700;
      text-shadow: 0 0 8px #ffd700;
      margin-bottom: 20px;
      letter-spacing: 2px;
      font-family: 'Orbitron', Arial, sans-serif;
      font-size: 2.2rem;
    }

    /* ===== 背景音樂控制按鈕樣式 ===== */
    #bgMusicControl {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 215, 0, 0.9);
      color: #000;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 12;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #bgMusicControl:hover {
      background: rgba(255, 215, 0, 1);
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
    }

    #bgMusicControl.paused {
      background: rgba(255, 255, 255, 0.3);
      color: #fff;
    }

    #bgMusicControl.paused:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* ===== 按鈕樣式 ===== */
    .top-btns {
      position: fixed;
      top: 20px;
      right: 20px;
      left: auto;
      display: flex;
      gap: 8px;
      z-index: 11;
    }

    .top-btns button {
      padding: 6px 12px;
      font-size: 1rem;
      background: #ffd700;
      color: #000;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(255, 215, 0, 0.2);
      font-family: 'Orbitron', Arial, sans-serif;
      transition: background 0.2s;
    }

    .top-btns button:hover {
      background: #ffe54f;
    }

    button {
      font-size: 1rem;
      padding: 10px 26px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px #0003;
      font-family: 'Orbitron', Arial, sans-serif;
    }

    #submit-btn {
      background: #ffd700;
      color: #111;
    }

    #submit-btn:disabled {
      background: #ccc;
      color: #888;
      cursor: not-allowed;
    }

    #skip-btn {
      background: #bbb;
      color: #222;
    }

    #skip-btn:hover {
      background: #ccc;
    }

    #speak-btn {
      background: #0ff;
      color: #111;
      margin-top: 10px;
    }

    #speak-btn:disabled {
      background: #555;
      color: #888;
    }

    #speak-btn:hover {
      background: #7ff;
    }

    #next-btn {
      background: #4caf50;
      color: #fff;
      margin-top: 10px;
    }

    #next-btn:hover {
      background: #6fdc7f;
    }

    /* ===== 顯示區塊樣式 ===== */
    #star-counter {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      background: rgba(30, 30, 40, 0.92);
      border-radius: 18px;
      box-shadow: 0 4px 18px 0 rgba(31, 38, 135, 0.18);
      padding: 14px 32px;
      margin-bottom: 18px;
      border: 1.5px solid #ffd70044;
      font-size: 1.18rem;
      color: #ffd700;
      min-width: 260px;
      font-family: 'Orbitron', Arial, sans-serif;
    }

    #starsDisplay {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(10, 20, 40, 0.85);
      padding: 8px 14px;
      border-radius: 10px;
      color: #ffd700;
      font-weight: bold;
      box-shadow: 0 0 12px #ffd700, 0 0 32px #00ffff;
      border: 2px solid #00ffff;
      font-size: 1.2rem;
      z-index: 10;
    }

    #timer {
      font-size: 1.1rem;
      margin-bottom: 16px;
    }

    #timer.hidden {
      display: none;
    }

    /* ===== 問題容器樣式 ===== */
    #question-container {
      background: rgba(30, 30, 40, 0.97);
      border-radius: 22px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      padding: 38px 30px 30px;
      max-width: 440px;
      width: 100%;
      margin: auto;
      border: 1.5px solid #ffd70044;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 18px;
    }

    .question-title {
      font-size: 1.1rem;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }

    .question-sentence {
      font-size: 1.7rem;
      font-weight: bold;
      margin: 10px 0 20px 0;
      line-height: 1.5;
      word-break: break-word;
    }

    .question-sentence .blank {
      color: #0ff;
      background: #fff2;
      border-radius: 8px;
      padding: 2px 16px;
      box-shadow: 0 1px 4px #0ff2;
    }

    .question-zh {
      color: #ffd700;
      margin-bottom: 16px;
      font-size: 1.08rem;
    }

    /* ===== 輸入框樣式 ===== */
    input {
      width: 92%;
      padding: 15px;
      font-size: 1.15rem;
      border: 2px solid #ffd700;
      border-radius: 14px;
      background: #222;
      color: #fff;
      margin-bottom: 22px;
      box-shadow: 0 2px 8px #0003;
      outline: none;
      transition: border 0.2s;
    }

    input:focus {
      border-color: #0ff;
    }

    /* ===== 按鈕列樣式 ===== */
    .btn-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 14px;
      width: 100%;
    }

    /* ===== 反饋樣式 ===== */
    #feedback {
      margin-top: 12px;
      font-size: 1.13rem;
      min-height: 28px;
    }

    .feedback-box {
      display: inline-block;
      padding: 10px 22px;
      border-radius: 16px;
      font-size: 1.18rem;
      font-weight: bold;
      box-shadow: 0 2px 16px #0004;
      margin-top: 8px;
      transition: background 0.3s, color 0.3s, transform 0.2s;
      animation: popfade 0.7s cubic-bezier(.68, -0.55, .27, 1.55);
    }

    .feedback-correct {
      background: linear-gradient(90deg, #2ecc40, #bfff00);
      color: #222;
    }

    .feedback-wrong {
      background: linear-gradient(90deg, #ff4f4f, #ffbaba);
      color: #fff;
    }

    .feedback-bonus {
      color: #ffd700;
      animation: bonusflash 1s infinite alternate;
      font-size: 1.25em;
    }

    /* ===== 動畫效果 ===== */
    .complete-anim {
      animation: pop 0.7s cubic-bezier(.68, -0.55, .27, 1.55) both;
    }

    @keyframes pop {
      0% {
        transform: scale(0.7);
        opacity: 0;
      }
      60% {
        transform: scale(1.15);
        opacity: 1;
      }
      100% {
        transform: scale(1);
      }
    }

    @keyframes popfade {
      0% {
        transform: scale(0.7);
        opacity: 0;
      }
      60% {
        transform: scale(1.15);
        opacity: 1;
      }
      100% {
        transform: scale(1);
      }
    }

    @keyframes bonusflash {
      0% {
        text-shadow: 0 0 8px #ffd700;
      }
      100% {
        text-shadow: 0 0 24px #fff700;
      }
    }

    /* ===== 響應式設計優化 ===== */
    @media (max-width: 768px) {
      .top-btns {
        position: fixed;
        top: 10px;
        right: 10px;
        left: auto;
        display: flex;
        gap: 6px;
        z-index: 11;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      
      .top-btns button {
        padding: 4px 8px;
        font-size: 0.9rem;
      }
      
      #starsDisplay {
        top: 10px;
        left: 10px;
        padding: 6px 10px;
        font-size: 1rem;
      }
      
      h1 {
        font-size: 1.8rem;
        margin-top: 60px;
      }
      
      #question-container {
        max-width: 95vw;
        padding: 20px 15px;
        margin: 10px auto;
      }
      
      .question-sentence {
        font-size: 1.3rem;
      }
      
      .modal-content {
        padding: 20px;
        margin: 10px;
        max-width: 95vw;
      }
      
      .end-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .end-buttons button {
        width: 100%;
        padding: 10px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .top-btns {
        position: relative;
        top: auto;
        right: auto;
        left: auto;
        justify-content: center;
        margin-bottom: 15px;
      }
      
      #starsDisplay {
        position: relative;
        top: auto;
        left: auto;
        display: inline-block;
        margin-bottom: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
        margin-top: 10px;
      }
      
      #sessionStarsDisplay {
        font-size: 1rem;
        margin-bottom: 8px;
      }
      
      #star-counter {
        font-size: 1rem;
        padding: 10px 20px;
        min-width: 200px;
      }
      
      .question-sentence {
        font-size: 1.1rem;
      }
      
      input {
        font-size: 1rem;
        padding: 12px;
      }
      
      .btn-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn-row button {
        width: 100%;
        padding: 12px;
      }
    }

    /* ===== 遊戲結束畫面樣式 ===== */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(12px);
      animation: modalFadeIn 0.4s ease-out;
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-content {
      background: linear-gradient(135deg, rgba(30, 30, 40, 0.98), rgba(40, 40, 60, 0.98));
      border: 3px solid #ffd700;
      border-radius: 25px;
      padding: 40px;
      text-align: center;
      max-width: 550px;
      width: 90%;
      box-shadow: 0 0 50px #ffd70044, 0 0 100px #00ffff22 inset, 0 0 150px rgba(255, 215, 0, 0.3);
      animation: modalPop 0.6s cubic-bezier(.68, -0.55, .27, 1.55);
      position: relative;
      overflow: hidden;
    }
    
    .modal-content::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
      animation: shimmer 3s infinite;
    }

    .end-icon {
      font-size: 5rem;
      margin-bottom: 20px;
      animation: tada 2s ease-in-out infinite;
      filter: drop-shadow(0 0 20px #ffd700);
      position: relative;
      z-index: 1;
    }

    .modal-content h2 {
      color: #ffd700;
      font-size: 2.2rem;
      margin-bottom: 25px;
      text-shadow: 0 0 15px #ffd700, 0 0 30px #ffed4e;
      font-family: 'Orbitron', Arial, sans-serif;
      position: relative;
      z-index: 1;
      letter-spacing: 2px;
    }

    .end-stats {
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
    }

    .end-stats p {
      font-size: 1.3rem;
      margin: 15px 0;
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      border-radius: 12px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .end-stats p:hover {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.6);
      transform: scale(1.02);
    }

    .end-stats span {
      color: #ffd700;
      font-weight: bold;
      text-shadow: 0 0 8px #ffd700;
      font-size: 1.4rem;
    }

    .end-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      position: relative;
      z-index: 1;
    }

    .end-buttons button {
      background: linear-gradient(90deg, #ffd700, #ffed4e);
      color: #000;
      border: none;
      border-radius: 15px;
      padding: 15px 30px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Orbitron', Arial, sans-serif;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
      position: relative;
      overflow: hidden;
    }
    
    .end-buttons button::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .end-buttons button:hover {
      transform: scale(1.08);
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), 0 0 40px rgba(255, 215, 0, 0.3);
    }
    
    .end-buttons button:hover::before {
      opacity: 1;
    }
    
    .end-buttons button:active {
      transform: scale(0.95);
    }

    @keyframes modalPop {
      0% {
        transform: scale(0.3) rotate(-10deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.1) rotate(2deg);
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    @keyframes tada {
      0% { transform: scale(1) rotate(0deg); }
      10%, 20% { transform: scale(0.9) rotate(-3deg); }
      30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
      40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(360deg); }
    }
    
    /* ===== 複習單字彈窗美化 ===== */
    #reviewModal .modal-content {
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      background: linear-gradient(135deg, rgba(20, 30, 50, 0.98), rgba(30, 40, 70, 0.98));
      border-color: #00ffff;
      box-shadow: 0 0 50px #00ffff44, 0 0 100px #a259ff22 inset, 0 0 150px rgba(0, 255, 255, 0.3);
    }
    
    #reviewModal .end-icon {
      color: #00ffff;
      filter: drop-shadow(0 0 20px #00ffff);
    }
    
    #reviewModal h2 {
      color: #00ffff;
      text-shadow: 0 0 15px #00ffff, 0 0 30px #a259ff;
    }
    
    /* 分類選擇器美化 */
    #categoryFilter {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(162, 89, 255, 0.1));
      color: #fff;
      border: 2px solid #00ffff;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }
    
    #categoryFilter:hover {
      border-color: #a259ff;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      transform: scale(1.02);
    }
    
    #categoryFilter:focus {
      outline: none;
      border-color: #ffd700;
      box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
    }
    
    /* 統計資訊美化 */
    #vocabStats {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 170, 0, 0.15));
      border: 2px solid #ffd700;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      color: #ffd700;
      font-size: 1rem;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }
    
    #vocabStats button {
      background: linear-gradient(90deg, #00ffff, #a259ff);
      color: #000;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.9rem;
      margin-left: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
    }
    
    #vocabStats button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
    }
    
    #vocabStats button:last-child {
      background: linear-gradient(90deg, #4caf50, #45a049);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.4);
    }
    
    #vocabStats button:last-child:hover {
      box-shadow: 0 0 15px rgba(76, 175, 80, 0.6);
    }
    
    /* 單字容器美化 */
    #reviewWordsContainer {
      max-height: 400px;
      overflow-y: auto;
      margin: 20px 0;
      padding: 10px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(0, 255, 255, 0.2);
    }
    
    #reviewWordsContainer::-webkit-scrollbar {
      width: 8px;
    }
    
    #reviewWordsContainer::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }
    
    #reviewWordsContainer::-webkit-scrollbar-thumb {
      background: linear-gradient(90deg, #00ffff, #a259ff);
      border-radius: 4px;
    }
    
    #reviewWordsContainer::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(90deg, #a259ff, #00ffff);
    }
    
    /* 單字項目美化 */
    .vocab-item {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(0, 255, 255, 0.05));
      border: 2px solid rgba(255, 215, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      text-align: left;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .vocab-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
      transition: left 0.5s ease;
    }
    
    .vocab-item:hover {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(0, 255, 255, 0.1));
      border-color: rgba(255, 215, 0, 0.6);
      transform: scale(1.02);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }
    
    .vocab-item:hover::before {
      left: 100%;
    }
    
    .vocab-item .word {
      color: #ffd700;
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 10px;
      word-break: break-word;
      text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
    }
    
    .vocab-item .meaning {
      color: #fff;
      font-size: 1.1rem;
      margin-bottom: 10px;
      word-break: break-word;
    }
    
    .vocab-item .sentence {
      color: #00ffff;
      font-size: 1rem;
      font-style: italic;
      word-break: break-word;
      line-height: 1.4;
    }
    
    .vocab-item .category-tag {
      color: #00ffff;
      font-size: 0.8rem;
      background: rgba(0, 255, 255, 0.2);
      padding: 4px 8px;
      border-radius: 6px;
      margin-left: 10px;
      border: 1px solid rgba(0, 255, 255, 0.3);
    }
    
    .vocab-item .speak-btn {
      background: linear-gradient(90deg, #00ffff, #a259ff);
      color: #000;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.4rem;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
    }
    
    .vocab-item .speak-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
    }
    
    /* 分類標題美化 */
    .category-title {
      color: #00ffff;
      font-size: 1.4rem;
      font-weight: bold;
      margin: 20px 0 15px 0;
      padding: 15px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(162, 89, 255, 0.1));
      border-radius: 12px;
      text-align: center;
      border: 2px solid rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }
    
    /* 無單字提示美化 */
    .no-words {
      text-align: center;
      color: #888;
      font-size: 1.2rem;
      padding: 50px;
      font-style: italic;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
  <script src="js/gameDialogue.js"></script>
</head>
<body>
  <!-- 背景音樂控制按鈕 -->
  <button id="bgMusicControl" onclick="toggleBackgroundMusic()" title="背景音樂控制">🎵</button>

  <!-- 星星數顯示區塊 -->
  <div id="starsDisplay">
    ⭐<span id="totalStarsCount">0</span>
  </div>

  <!-- 頂部按鈕 -->
  <div class="top-btns">
    <button onclick="location.href='atlas.html?tab=greek'" aria-label="回首頁">🏠 回首頁</button>
    <button onclick="resetProgress()" aria-label="重新開始">🔄 重新開始</button>
    <button onclick="showReviewModal()" aria-label="複習單字">📚 複習單字</button>
    <button onclick="location.href='achievement.html'" aria-label="成就徽章">🏆 成就徽章</button>
  </div>

  <h1>阿瑞斯 Ares - 填空挑戰</h1>

  <!-- 本次星星顯示 -->
  <div id="sessionStarsDisplay" style="margin-bottom:10px;color:#ffd700;font-weight:bold;font-size:1.08rem;">
    本次已獲得 0 顆星星
  </div>

  <!-- 進度顯示 -->
  <div id="star-counter">
    第 <span id="current-index">0</span> / <span id="total-questions">0</span> 題
  </div>

  <!-- 計時器 -->
  <div id="timer" class="hidden">
    ⏳ 倒數：<span id="time-left">0</span> 秒
  </div>

  <!-- 問題容器 -->
  <div id="question-container"></div>

  <!-- 遊戲結束畫面 -->
  <div id="gameEndModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="end-icon">🎉</div>
      <h2>遊戲完成！</h2>
      <div class="end-stats">
        <p>⭐ 本次獲得星星：<span id="endSessionStars">0</span></p>
        <p>✅ 答對題數：<span id="endCorrectCount">0</span></p>
        <p>❌ 答錯題數：<span id="endWrongCount">0</span></p>
        <p>⭐ 累積總星星：<span id="endTotalStars">0</span></p>
      </div>
      <div class="end-buttons">
        <button onclick="restartGame()">🔄 重新開始</button>
        <button onclick="location.href='atlas.html?tab=greek'">🏠 返回首頁</button>
      </div>
    </div>
  </div>

  <!-- 複習單字彈窗 -->
  <div id="reviewModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="end-icon">📚</div>
      <h2>單字複習</h2>
      
      <!-- 分類選擇器 -->
      <div style="margin-bottom: 20px;">
        <label for="categoryFilter" style="color: #ffd700; font-weight: bold; margin-right: 10px;">選擇分類：</label>
        <select id="categoryFilter" style="
          background: #222;
          color: #fff;
          border: 2px solid #ffd700;
          border-radius: 8px;
          padding: 8px 12px;
          font-size: 1rem;
          cursor: pointer;
        ">
          <option value="all">全部單字</option>
          <option value="動作動詞">動作動詞</option>
          <option value="形容詞">形容詞</option>
          <option value="食物水果">食物水果</option>
          <option value="稱謂人際">稱謂人際</option>
          <option value="節日慶祝">節日慶祝</option>
          <option value="日常用品">日常用品</option>
          <option value="場所位置">場所位置</option>
          <option value="抽象概念">抽象概念</option>
          <option value="自然環境">自然環境</option>
          <option value="身體健康">身體健康</option>
        </select>
      </div>
      
      <!-- 統計資訊 -->
      <div id="vocabStats" style="
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid #ffd700;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
        color: #ffd700;
        font-size: 0.9rem;
      ">
        總共 <span id="totalVocabCount">0</span> 個單字
        <button onclick="showVocabStats()" style="
          background: #0ff;
          color: #000;
          border: none;
          border-radius: 6px;
          padding: 4px 8px;
          font-size: 0.8rem;
          margin-left: 10px;
          cursor: pointer;
        ">📊 詳細統計</button>
        <button onclick="exportVocabData()" style="
          background: #4caf50;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 4px 8px;
          font-size: 0.8rem;
          margin-left: 5px;
          cursor: pointer;
        ">📥 匯出字庫</button>
      </div>
      
      <div id="reviewWordsContainer" style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
        <!-- 單字列表將在這裡動態生成 -->
      </div>
      <div class="end-buttons">
        <button onclick="closeReviewModal()">關閉</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 遊戲配置 =====
    const GAME_CONFIG = {
      QUESTIONS_COUNT: 20,
      TIME_LIMIT: 30,
      MAX_ATTEMPTS: 3
    };

    // ===== 題庫資料 =====
    const VOCAB_DATA = [
      {
        "word": "papaya",
        "zh": "木瓜",
        "en_sentence": "Papaya is sweet and delicious.",
        "zh_sentence": "木瓜又甜又美味。",
        "category": "食物水果"
      },
      {
        "word": "lemon",
        "zh": "檸檬",
        "en_sentence": "Lemon juice is very sour.",
        "zh_sentence": "檸檬汁非常酸。",
        "category": "食物水果"
      },
      {
        "word": "guava",
        "zh": "芭樂",
        "en_sentence": "Guava is green on the outside.",
        "zh_sentence": "芭樂外皮是綠色的。",
        "category": "食物水果"
      },
      {
        "word": "sir",
        "zh": "先生（尊稱）",
        "en_sentence": "Excuse me, sir, where is the bus stop?",
        "zh_sentence": "不好意思，先生，公車站在哪裡？",
        "category": "稱謂人際"
      },
      {
        "word": "Dr.",
        "zh": "博士；醫生",
        "en_sentence": "Dr. Lee helps patients feel better.",
        "zh_sentence": "李醫生幫助病人感覺好一點。",
        "category": "稱謂人際"
      },
      {
        "word": "neighbor",
        "zh": "鄰居",
        "en_sentence": "My neighbor waters my plants when I'm away.",
        "zh_sentence": "我不在時，我的鄰居會幫我澆花。",
        "category": "稱謂人際"
      },
      {
        "word": "Easter",
        "zh": "復活節",
        "en_sentence": "We hunt for eggs on Easter.",
        "zh_sentence": "復活節我們去尋蛋。",
        "category": "節日慶祝"
      },
      {
        "word": "basket",
        "zh": "籃子",
        "en_sentence": "I carry apples in a basket to the picnic.",
        "zh_sentence": "我用籃子把蘋果帶到野餐。",
        "category": "日常用品"
      },
      {
        "word": "church",
        "zh": "教堂",
        "en_sentence": "We go to church on Sunday morning.",
        "zh_sentence": "我們星期天早上去教堂。",
        "category": "場所位置"
      },
      {
        "word": "hunt",
        "zh": "打獵",
        "en_sentence": "My grandfather used to hunt in the forest.",
        "zh_sentence": "我爺爺以前在森林裡打獵。",
        "category": "動作動詞"
      },
      {
        "word": "roll",
        "zh": "滾動；晃動",
        "en_sentence": "The ball will roll down the hill.",
        "zh_sentence": "球會從小山滾下來。",
        "category": "動作動詞"
      },
      {
        "word": "hang",
        "zh": "掛；懸吊",
        "en_sentence": "Please hang your coat on that hook.",
        "zh_sentence": "請把外套掛在那個掛勾上。",
        "category": "動作動詞"
      },
      {
        "word": "snack",
        "zh": "點心；小吃",
        "en_sentence": "I eat a snack after school every day.",
        "zh_sentence": "我每天放學後都吃點心。",
        "category": "食物水果"
      },
      {
        "word": "tool",
        "zh": "工具",
        "en_sentence": "He uses a tool to fix the bike.",
        "zh_sentence": "他用工具修理自行車。",
        "category": "日常用品"
      },
      {
        "word": "letter",
        "zh": "信；字母",
        "en_sentence": "I write a letter to my friend every week.",
        "zh_sentence": "我每週都給朋友寫一封信。",
        "category": "日常用品"
      },
      {
        "word": "envelope",
        "zh": "信封",
        "en_sentence": "Put the letter inside the envelope.",
        "zh_sentence": "把信放進信封裡。",
        "category": "日常用品"
      },
      {
        "word": "ground",
        "zh": "地面",
        "en_sentence": "The children sit on the ground to play.",
        "zh_sentence": "孩子們坐在地面上玩。",
        "category": "場所位置"
      },
      {
        "word": "R.O.C.",
        "zh": "中華民國",
        "en_sentence": "The flag of the R.O.C. flies on the building.",
        "zh_sentence": "中華民國的國旗飄揚在那棟建築上。",
        "category": "抽象概念"
      },
      {
        "word": "world",
        "zh": "世界",
        "en_sentence": "He dreams of traveling around the world.",
        "zh_sentence": "他夢想環遊世界。",
        "category": "抽象概念"
      },
      {
        "word": "seed",
        "zh": "種子",
        "en_sentence": "She plants a seed in the pot.",
        "zh_sentence": "她在花盆裡種下一粒種子。",
        "category": "自然環境"
      },
      {
        "word": "other",
        "zh": "其他",
        "en_sentence": "I have no other ideas right now.",
        "zh_sentence": "目前我沒有其他想法。",
        "category": "抽象概念"
      },
      {
        "word": "taste",
        "zh": "味道；嚐",
        "en_sentence": "Please taste the soup and tell me if it needs salt.",
        "zh_sentence": "請嚐嚐湯，告訴我是否需要加鹽。",
        "category": "身體健康"
      },
      {
        "word": "smell",
        "zh": "氣味；聞",
        "en_sentence": "I smell cookies baking in the oven.",
        "zh_sentence": "我聞到烤箱裡餅乾的香味。",
        "category": "身體健康"
      },
      {
        "word": "sound",
        "zh": "聲音；聽",
        "en_sentence": "Do you hear the sound of birds in the morning?",
        "zh_sentence": "你聽到早晨鳥兒的聲音嗎？",
        "category": "身體健康"
      },
      {
        "word": "feel",
        "zh": "感覺",
        "en_sentence": "I feel cold when I go outside without a coat.",
        "zh_sentence": "如果我不穿外套出門，我會感到寒冷。",
        "category": "身體健康"
      },
      {
        "word": "large",
        "zh": "大的",
        "en_sentence": "They lived in a large house near the lake.",
        "zh_sentence": "他們住在靠近湖邊的一棟大房子裡。",
        "category": "形容詞"
      },
      {
        "word": "heavy",
        "zh": "重的",
        "en_sentence": "This box is too heavy for me to lift.",
        "zh_sentence": "這個箱子對我來說太重了，無法抬起。",
        "category": "形容詞"
      },
      {
        "word": "try",
        "zh": "試做",
        "en_sentence": "I will try my best on the exam.",
        "zh_sentence": "我會在考試中盡力而為。",
        "category": "動作動詞"
      },
      {
        "word": "comfortable",
        "zh": "舒適的",
        "en_sentence": "This chair is very comfortable to sit on.",
        "zh_sentence": "這張椅子坐起來非常舒適。",
        "category": "形容詞"
      },
      {
        "word": "successful",
        "zh": "成功的",
        "en_sentence": "She felt successful after finishing the race.",
        "zh_sentence": "她跑完比賽後感到很成功。",
        "category": "形容詞"
      },
      {
        "word": "famous",
        "zh": "有名的",
        "en_sentence": "The famous singer visited our school.",
        "zh_sentence": "那位有名的歌手來訪我們學校。",
        "category": "形容詞"
      },
      {
        "word": "care",
        "zh": "關心；喜歡",
        "en_sentence": "She takes care of her little brother every day.",
        "zh_sentence": "她每天照顧她的弟弟。",
        "category": "動作動詞"
      },
      {
        "word": "careful",
        "zh": "小心的",
        "en_sentence": "Be careful when you cross the street.",
        "zh_sentence": "過馬路時要小心。",
        "category": "形容詞"
      },
      {
        "word": "friendly",
        "zh": "友善的",
        "en_sentence": "The neighbors are very friendly to us.",
        "zh_sentence": "鄰居對我們非常友善。",
        "category": "形容詞"
      },
      {
        "word": "fresh",
        "zh": "新鮮的",
        "en_sentence": "We picked fresh strawberries from the farm.",
        "zh_sentence": "我們從農場採摘了新鮮的草莓。",
        "category": "形容詞"
      },
      {
        "word": "sweet",
        "zh": "甜美的",
        "en_sentence": "The cake tastes sweet and soft.",
        "zh_sentence": "蛋糕嘗起來甜美又鬆軟。",
        "category": "形容詞"
      },
      {
        "word": "each",
        "zh": "每一；每個",
        "en_sentence": "Each student must bring a pencil to class.",
        "zh_sentence": "每個學生都必須帶鉛筆來上課。",
        "category": "抽象概念"
      },
      {
        "word": "swing",
        "zh": "搖擺；鞦韆",
        "en_sentence": "The children love to swing at the playground.",
        "zh_sentence": "孩子們喜歡在遊樂場的鞦韆上搖擺。",
        "category": "動作動詞"
      },
      {
        "word": "slide",
        "zh": "滑動；滑坡",
        "en_sentence": "Please slide the door open slowly.",
        "zh_sentence": "請慢慢地把門滑開。",
        "category": "動作動詞"
      },
      {
        "word": "hide",
        "zh": "躲藏",
        "en_sentence": "He likes to hide behind the tree during games.",
        "zh_sentence": "他喜歡在遊戲時躲在樹後面。",
        "category": "動作動詞"
      },
      {
        "word": "restaurant",
        "zh": "餐廳",
        "en_sentence": "We celebrate our birthday at a restaurant.",
        "zh_sentence": "我們在餐廳慶祝生日。",
        "category": "場所位置"
      },
      {
        "word": "drop",
        "zh": "掉落；滴下",
        "en_sentence": "Be careful not to drop the vase.",
        "zh_sentence": "小心別把花瓶掉落。",
        "category": "動作動詞"
      }
    ];

    // ===== 遊戲狀態變數 =====
    let gameState = {
      data: [],
      currentIndex: 0,
      attemptCount: 0,
      answered: false,
      timerInterval: null,
      preferredVoice: null,
      answerLog: [],
      sessionStars: 0
    };

    // ===== 音效資源 =====
    const SOUNDS = {
      correct: new Audio('audio/correct.mp3'),
      wrong: new Audio('audio/wrong.mp3'),
      type: new Audio('audio/type.mp3')
    };

    // ===== 背景音樂控制 =====
    let bgMusic = null;
    let isMusicPlaying = false;

    function initBackgroundMusic() {
      bgMusic = new Audio('sound/午後放鬆時光（純音樂）.mp3');
      bgMusic.loop = true;
      bgMusic.volume = 0.3;
      
      // 從localStorage讀取音樂狀態
      const musicState = localStorage.getItem('bgMusicState');
      if (musicState === 'playing') {
        playBackgroundMusic();
      }
    }

    function toggleBackgroundMusic() {
      if (isMusicPlaying) {
        pauseBackgroundMusic();
      } else {
        playBackgroundMusic();
      }
    }

    function playBackgroundMusic() {
      if (bgMusic) {
        bgMusic.play().then(() => {
          isMusicPlaying = true;
          document.getElementById('bgMusicControl').textContent = '🔊';
          document.getElementById('bgMusicControl').classList.remove('paused');
          localStorage.setItem('bgMusicState', 'playing');
        }).catch(err => {
          console.log('背景音樂播放失敗:', err);
        });
      }
    }

    function pauseBackgroundMusic() {
      if (bgMusic) {
        bgMusic.pause();
        isMusicPlaying = false;
        document.getElementById('bgMusicControl').textContent = '🔇';
        document.getElementById('bgMusicControl').classList.add('paused');
        localStorage.setItem('bgMusicState', 'paused');
      }
    }

    // ===== 工具函數 =====
    function escapeRegExp(s) {
      return s.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&');
    }

    function getRandomQuestions(arr, n) {
      const count = Math.min(n, arr.length);
      return arr.slice().sort(() => Math.random() - 0.5).slice(0, count);
    }

    // ===== 資料初始化 =====
    function initData() {
      const selected = getRandomQuestions(VOCAB_DATA, GAME_CONFIG.QUESTIONS_COUNT);
      gameState.data = selected.map(item => ({
        answer: item.word,
        zh: item.zh,
        sentence: item.en_sentence.replace(new RegExp(escapeRegExp(item.word), 'i'), '___'),
        original: item.en_sentence,
        zh_sentence: item.zh_sentence,
        category: item.category
      }));
      document.getElementById('total-questions').textContent = gameState.data.length;
    }

    // ===== 進度管理 =====
    function saveProgress() {
      localStorage.setItem('fillIndex', gameState.currentIndex);
    }

    function loadProgress() {
      gameState.currentIndex = parseInt(localStorage.getItem('fillIndex')) || 0;
      if (typeof gameState.data !== 'undefined' && Array.isArray(gameState.data) && gameState.currentIndex >= gameState.data.length) {
        gameState.currentIndex = 0;
        localStorage.removeItem('fillIndex');
      }
    }

    function resetProgress() {
      localStorage.removeItem('fillIndex');
      location.reload();
    }

    function updateCounter() {
      document.getElementById('current-index').textContent = gameState.currentIndex + 1;
    }

    // ===== 計時器功能 =====
    function startTimer() {
      clearInterval(gameState.timerInterval);
      let timeLeft = GAME_CONFIG.TIME_LIMIT;
      document.getElementById('time-left').textContent = timeLeft;
      document.getElementById('timer').classList.remove('hidden');
      
      gameState.timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('time-left').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(gameState.timerInterval);
          revealAnswer(true);
        }
      }, 1000);
    }

    function stopTimer() {
      clearInterval(gameState.timerInterval);
    }

    // ===== 語音功能 =====
    function pickVoice() {
      const voices = window.speechSynthesis.getVoices();
      const prefer = [
        'Google US English', 'Microsoft Aria Online', 'Microsoft Jenny Online', 
        'Samantha', 'Jenny', 'Aria', 'en-US'
      ];
      gameState.preferredVoice = voices.find(v => prefer.some(p => v.name.includes(p))) || 
                                 voices.find(v => v.lang === 'en-US') || voices[0];
    }

    function speak(text, rate = 1.0, callback) {
      if (!window.speechSynthesis) return;
      
      const utter = new window.SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      utter.rate = rate;
      utter.pitch = 1.12;
      if (gameState.preferredVoice) utter.voice = gameState.preferredVoice;
      if (callback) utter.onend = callback;
      
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    function speakQuestionAndWord(question) {
      window.speechSynthesis.cancel();
      speak(question.original, 0.97, function() {
        setTimeout(() => {
          speak(question.original.replace(new RegExp(escapeRegExp(question.answer), 'i'), '...'), 1.02, function() {
            setTimeout(() => speak(question.answer, 1.08), 350);
          });
        }, 350);
      });
    }

    // ===== 答案處理 =====
    function revealAnswer(autoNext = false) {
      gameState.attemptCount = Infinity;
      document.getElementById('feedback').innerHTML = 
        '<span style="color:#f66;">⏰ 時間到！正確答案：<b>' + gameState.data[gameState.currentIndex].answer + '</b></span>';
      document.getElementById('submit-btn').disabled = true;
      document.getElementById('user-input').disabled = true;
      
      logAnswer(false);
      
      if (autoNext) {
        setTimeout(() => {
          gameState.currentIndex++;
          showQuestion();
        }, 500);
      }
    }

    function logAnswer(correct, userAnswer = '') {
      const currentQuestion = gameState.data[gameState.currentIndex];
      const timeSpent = window.answerStartTime ? (Date.now() - window.answerStartTime) / 1000 : 0;
      
      gameState.answerLog[gameState.currentIndex] = {
        word: currentQuestion.answer,
        zh: currentQuestion.zh_sentence || currentQuestion.zh,
        en: currentQuestion.original,
        user: userAnswer,
        correct: correct,
        stars: 0,
        category: currentQuestion.category,
        timeSpent: timeSpent
      };
    }

    // ===== 問題顯示 =====
    function showQuestion() {
      if (!gameState.data || !Array.isArray(gameState.data) || gameState.data.length === 0) {
        document.getElementById('question-container').innerHTML = 
          '<div style="color:#f66;font-size:1.2rem;">⚠️ 題庫沒有題目，請檢查資料！</div>';
        return;
      }

      if (gameState.currentIndex < 0 || gameState.currentIndex >= gameState.data.length) {
        // 遊戲結束，顯示結束畫面
        showGameEndScreen();
        return;
      }

      gameState.answered = false;
      gameState.attemptCount = 0;
      const question = gameState.data[gameState.currentIndex];

      document.getElementById('question-container').innerHTML = 
        '<div class="question-title">英文句子：</div>' +
        '<div class="question-sentence">' + question.sentence.replace('___', '<span class="blank">___</span>') + '</div>' +
        '<div class="question-zh">中文提示：' + (question.zh_sentence || question.zh) + '</div>' +
        '<input id="user-input" placeholder="輸入答案…" autocomplete="off" />' +
        '<div class="btn-row">' +
          '<button id="submit-btn" onclick="checkAnswer()">送出</button>' +
          '<button id="skip-btn" onclick="skipQuestion()">跳過</button>' +
          '<button id="next-btn" onclick="nextQuestion()">下一題</button>' +
        '</div>' +
        '<div id="feedback"></div>' +
        '<button id="speak-btn" onclick="speakQuestionAndWord(question)">🔊 朗讀</button>';

      const inputEl = document.getElementById('user-input');
      inputEl.focus();
      inputEl.onkeydown = function(e) {
        if (e.key === 'Enter') {
          checkAnswer();
        } else if (e.key.length === 1) {
          try {
            SOUNDS.type.currentTime = 0;
            SOUNDS.type.play();
          } catch (e) {}
        }
      };

      updateCounter();
      startTimer();
      
      setTimeout(() => {
        speak(question.original, 0.97);
      }, 400);

      document.getElementById('speak-btn').onclick = () => speakQuestionAndWord(question);
      window.answerStartTime = Date.now();
      
      // 鎖定複習按鈕
      lockReviewButton();
    }

    // ===== 遊戲結束畫面 =====
    function showGameEndScreen() {
      // 計算統計數據
      const correctCount = gameState.answerLog.filter(log => log && log.correct === true).length;
      const wrongCount = gameState.answerLog.filter(log => log && log.correct === false).length;
      const totalStars = loadTotalStars();
      
      // 計算平均時間
      const totalTime = gameState.answerLog.reduce((sum, log) => {
        return sum + (log && log.timeSpent ? log.timeSpent : 0);
      }, 0);
      const averageTime = correctCount > 0 ? totalTime / correctCount : 0;

      // 更新結束畫面數據
      document.getElementById('endSessionStars').textContent = gameState.sessionStars;
      document.getElementById('endCorrectCount').textContent = correctCount;
      document.getElementById('endWrongCount').textContent = wrongCount;
      document.getElementById('endTotalStars').textContent = totalStars;

      // 顯示結束畫面
      document.getElementById('gameEndModal').style.display = 'flex';
      
      // 停止計時器
      stopTimer();
      
      // 解鎖複習按鈕
      unlockReviewButton();
      
      // 更新成就統計
      updateFillAchievements(); // 更新遊戲完成次數
      updateFillStreak(); // 更新連續天數
      updateFillCorrectWords(correctCount); // 更新答對單字數
      
      // 檢查是否為完美分數
      if (correctCount === gameState.data.length && wrongCount === 0) {
        updateFillPerfectScore();
      }
      
      // 檢查是否為快速遊戲
      updateFillSpeedGame(averageTime);
      
      // 播放完成音效
      try {
        SOUNDS.correct.currentTime = 0;
        SOUNDS.correct.play();
      } catch (e) {}
    }

    function restartGame() {
      // 隱藏結束畫面
      document.getElementById('gameEndModal').style.display = 'none';
      
      // 重置遊戲狀態
      gameState.currentIndex = 0;
      gameState.sessionStars = 0;
      gameState.answerLog = [];
      
      // 重新初始化數據
      initData();
      updateCounter();
      showQuestion();
      
      // 更新本次星星顯示
      document.getElementById('sessionStarsDisplay').textContent = '本次已獲得 0 顆星星';
    }

    // ===== 問題操作 =====
    function skipQuestion() {
      stopTimer();
      logAnswer(null, '');
      const feedback = document.getElementById('feedback');
      if (feedback) feedback.innerHTML = '<span style="color:#bbb;">已跳過本題</span>';
      setTimeout(() => {
        gameState.currentIndex++;
        showQuestion();
      }, 400);
    }

    function nextQuestion() {
      stopTimer();
      if (!gameState.answerLog[gameState.currentIndex]) {
        logAnswer(false, document.getElementById('user-input')?.value || '');
        const feedback = document.getElementById('feedback');
        if (feedback) feedback.innerHTML = '<span style="color:#bbb;">未作答</span>';
      }
      setTimeout(() => {
        gameState.currentIndex++;
        showQuestion();
      }, 400);
    }

    function checkAnswer() {
      if (gameState.answered) return;
      
      gameState.attemptCount++;
      const inputEl = document.getElementById('user-input');
      const feedback = document.getElementById('feedback');
      const answer = gameState.data[gameState.currentIndex].answer.toLowerCase();
      const userAnswer = inputEl.value.trim().toLowerCase();

      if (userAnswer === answer) {
        gameState.answered = true;
        stopTimer();

        const usedSeconds = (Date.now() - (window.answerStartTime || Date.now())) / 1000;
        let bonus = 0;
        let feedbackMsg = '<div class="feedback-box feedback-correct">✅ 答對了！太棒了！';
        
        if (usedSeconds < 10) {
          bonus = 2;
          feedbackMsg += ' <span class="feedback-bonus">BONUS! ⏱️ +2</span>';
        }
        feedbackMsg += '</div>';
        
        feedback.innerHTML = feedbackMsg;
        inputEl.disabled = true;
        document.getElementById('submit-btn').disabled = true;
        
        speak(answer, 1.1);
        saveProgress();
        updateCounter();
        
        logAnswer(true, inputEl.value.trim());
        
        const addStars = 1 + bonus;
        addStarsToTotal(addStars);
        gameState.sessionStars += addStars;
        document.getElementById('sessionStarsDisplay').textContent = '本次已獲得 ' + gameState.sessionStars + ' 顆星星';
        
        try {
          SOUNDS.correct.currentTime = 0;
          SOUNDS.correct.play();
        } catch (e) {}
        
        setTimeout(() => {
          gameState.currentIndex++;
          showQuestion();
        }, 1300);
      } else {
        if (gameState.attemptCount < GAME_CONFIG.MAX_ATTEMPTS) {
          feedback.innerHTML = '<div class="feedback-box feedback-wrong">❌ 再試一次！你可以的！</div>';
          try {
            SOUNDS.wrong.currentTime = 0;
            SOUNDS.wrong.play();
          } catch (e) {}
        } else {
          feedback.innerHTML = '<div class="feedback-box feedback-wrong">❌ 正確答案：<b>' + gameState.data[gameState.currentIndex].answer + '</b><br>別氣餒，再接再厲！</div>';
          inputEl.disabled = true;
          document.getElementById('submit-btn').disabled = true;
          
          logAnswer(false, inputEl.value.trim());
          
          try {
            SOUNDS.wrong.currentTime = 0;
            SOUNDS.wrong.play();
          } catch (e) {}
          
          setTimeout(() => {
            gameState.currentIndex++;
            showQuestion();
          }, 1300);
        }
      }
    }

    // ===== 星星系統 =====
    function loadTotalStars() {
      const stars = localStorage.getItem('totalStars');
      return stars !== null ? parseInt(stars, 10) : 0;
    }

    function addStarsToTotal(stars) {
      const currentStars = loadTotalStars();
      const newTotal = currentStars + stars;
      localStorage.setItem('totalStars', newTotal);
      updateStarsDisplay();
    }

    function updateStarsDisplay() {
      document.getElementById('totalStarsCount').textContent = loadTotalStars();
    }

    // ===== 複習單字功能 =====
    function showReviewModal() {
      // 暫停遊戲計時器
      stopTimer();
      
      const container = document.getElementById('reviewWordsContainer');
      const categoryFilter = document.getElementById('categoryFilter');
      const totalVocabCount = document.getElementById('totalVocabCount');
      
      // 更新總數統計
      totalVocabCount.textContent = VOCAB_DATA.length;
      
      // 顯示所有單字
      displayVocabByCategory('all');
      
      // 添加分類篩選事件監聽器
      categoryFilter.onchange = function() {
        displayVocabByCategory(this.value);
      };
      
      document.getElementById('reviewModal').style.display = 'flex';
    }

    function displayVocabByCategory(category) {
      const container = document.getElementById('reviewWordsContainer');
      const totalVocabCount = document.getElementById('totalVocabCount');
      
      // 清空容器
      container.innerHTML = '';
      
      // 篩選單字
      let filteredVocab = VOCAB_DATA;
      if (category !== 'all') {
        filteredVocab = VOCAB_DATA.filter(item => item.category === category);
      }
      
      // 更新統計資訊
      totalVocabCount.textContent = filteredVocab.length;
      
      // 顯示分類標題
      if (category !== 'all') {
        const categoryTitle = document.createElement('div');
        categoryTitle.className = 'category-title';
        categoryTitle.textContent = `📂 ${category} (${filteredVocab.length}個單字)`;
        container.appendChild(categoryTitle);
      }
      
      // 顯示單字
      filteredVocab.forEach((item, index) => {
        const wordDiv = document.createElement('div');
        wordDiv.className = 'vocab-item';
        
        // 添加分類標籤
        const categoryLabel = category === 'all' ? `<span class="category-tag">${item.category}</span>` : '';
        
        wordDiv.innerHTML = `
          <div style="display: flex; align-items: flex-start; gap: 15px;">
            <div style="flex: 1; min-width: 0;">
              <div class="word">
                ${index+1}. ${item.word}${categoryLabel}
              </div>
              <div class="meaning">
                ${item.zh}
              </div>
              <div class="sentence">
                ${item.en_sentence}
              </div>
            </div>
            <button class="speak-btn" onclick="event.stopPropagation(); speakWord('${item.word}')">
              🔊
            </button>
          </div>
        `;
        
        wordDiv.addEventListener('click', () => {
          speakWord(item.word);
        });
        
        container.appendChild(wordDiv);
      });
      
      // 如果沒有單字，顯示提示
      if (filteredVocab.length === 0) {
        const noWordsDiv = document.createElement('div');
        noWordsDiv.className = 'no-words';
        noWordsDiv.textContent = '此分類暫無單字';
        container.appendChild(noWordsDiv);
      }
    }

    function closeReviewModal() {
      document.getElementById('reviewModal').style.display = 'none';
      // 恢復遊戲計時器（如果遊戲還在進行中）
      if (gameState.currentIndex < gameState.data.length && !gameState.answered) {
        startTimer();
      }
    }

    function speakWord(word) {
      if (!window.speechSynthesis) return;
      
      const utter = new window.SpeechSynthesisUtterance(word);
      utter.lang = 'en-US';
      utter.rate = 0.9;
      utter.pitch = 1.1;
      if (gameState.preferredVoice) utter.voice = gameState.preferredVoice;
      
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    // ===== 複習按鈕鎖定功能 =====
    function lockReviewButton() {
      const reviewBtn = document.querySelector('.top-btns button[onclick*="showReviewModal"]');
      if (reviewBtn) {
        reviewBtn.disabled = true;
        reviewBtn.style.background = '#555';
        reviewBtn.style.color = '#888';
        reviewBtn.style.cursor = 'not-allowed';
        reviewBtn.title = '遊戲進行中，無法複習單字';
      }
    }

    function unlockReviewButton() {
      const reviewBtn = document.querySelector('.top-btns button[onclick*="showReviewModal"]');
      if (reviewBtn) {
        reviewBtn.disabled = false;
        reviewBtn.style.background = '#ffd700';
        reviewBtn.style.color = '#000';
        reviewBtn.style.cursor = 'pointer';
        reviewBtn.title = '複習單字';
      }
    }

    // ===== 字庫統計功能 =====
    function showVocabStats() {
      // 計算各分類的單字數量
      const categoryStats = {};
      VOCAB_DATA.forEach(item => {
        categoryStats[item.category] = (categoryStats[item.category] || 0) + 1;
      });
      
      // 創建統計彈窗
      const statsModal = document.createElement('div');
      statsModal.className = 'modal';
      statsModal.style.display = 'flex';
      statsModal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="end-icon">📊</div>
          <h2>字庫統計</h2>
          <div style="text-align: left; margin: 20px 0;">
            <h3 style="color: #ffd700; margin-bottom: 15px;">📈 分類統計</h3>
            ${Object.entries(categoryStats).map(([category, count]) => `
              <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid rgba(255, 215, 0, 0.3);
              ">
                <span style="color: #fff;">${category}</span>
                <span style="color: #0ff; font-weight: bold;">${count} 個單字</span>
              </div>
            `).join('')}
            <div style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 12px 0;
              border-top: 2px solid #ffd700;
              margin-top: 10px;
              font-weight: bold;
            ">
              <span style="color: #ffd700;">總計</span>
              <span style="color: #ffd700;">${VOCAB_DATA.length} 個單字</span>
            </div>
          </div>
          <div class="end-buttons">
            <button onclick="this.closest('.modal').remove()">關閉</button>
          </div>
        </div>
      `;
      
      // 添加點擊外部關閉功能
      statsModal.addEventListener('click', function(e) {
        if (e.target === statsModal) {
          statsModal.remove();
        }
      });
      
      document.body.appendChild(statsModal);
    }

    // ===== 字庫匯出功能 =====
    function exportVocabData() {
      // 創建CSV格式的數據
      const csvContent = [
        ['單字', '中文', '英文例句', '中文例句', '分類'],
        ...VOCAB_DATA.map(item => [
          item.word,
          item.zh,
          item.en_sentence,
          item.zh_sentence,
          item.category
        ])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      
      // 創建下載連結
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `zeus_vocabulary_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // 顯示成功訊息
      showNotification('✅ 字庫已成功匯出！', 'success');
    }

    // ===== 通知功能 =====
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#4caf50' : '#2196f3'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 10000;
        animation: slideDown 0.3s ease-out;
      `;
      notification.textContent = message;
      
      // 添加動畫樣式
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
          to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(notification);
      
      // 3秒後自動移除
      setTimeout(() => {
        notification.remove();
        style.remove();
      }, 3000);
    }

    // ===== 成就系統 =====
    function updateFillAchievements() {
      // 更新遊戲完成次數
      const gamesCompleted = parseInt(localStorage.getItem('fillGamesCompleted') || '0');
      localStorage.setItem('fillGamesCompleted', gamesCompleted + 1);
      
      // 檢查並更新相關成就
      checkAndUpdateAchievements();
    }
    
    function updateFillPerfectScore() {
      // 更新完美分數次數
      const perfectScores = parseInt(localStorage.getItem('fillPerfectScores') || '0');
      localStorage.setItem('fillPerfectScores', perfectScores + 1);
      
      // 檢查並更新相關成就
      checkAndUpdateAchievements();
    }
    
    function updateFillSpeedGame(averageTime) {
      // 檢查是否為快速遊戲（平均時間少於15秒）
      if (averageTime < 15) {
        const speedGames = parseInt(localStorage.getItem('fillSpeedGames') || '0');
        localStorage.setItem('fillSpeedGames', speedGames + 1);
        
        // 檢查並更新相關成就
        checkAndUpdateAchievements();
      }
    }
    
    function updateFillStreak() {
      // 更新連續天數
      const today = new Date().toDateString();
      const lastPlayDate = localStorage.getItem('fillLastPlayDate');
      const currentStreak = parseInt(localStorage.getItem('fillStreakDays') || '0');
      
      if (lastPlayDate === today) {
        // 今天已經玩過了，不重複計算
        return;
      }
      
      if (lastPlayDate === new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString()) {
        // 昨天有玩，連續天數+1
        localStorage.setItem('fillStreakDays', currentStreak + 1);
      } else {
        // 中斷了，重新開始
        localStorage.setItem('fillStreakDays', 1);
      }
      
      localStorage.setItem('fillLastPlayDate', today);
      
      // 檢查並更新相關成就
      checkAndUpdateAchievements();
    }
    
    function updateFillCorrectWords(correctCount) {
      // 更新答對單字總數
      const totalCorrect = parseInt(localStorage.getItem('fillCorrectWords') || '0');
      localStorage.setItem('fillCorrectWords', totalCorrect + correctCount);
      
      // 檢查並更新相關成就
      checkAndUpdateAchievements();
    }
    
    function checkAndUpdateAchievements() {
      // 檢查是否有新成就達成
      const achievements = [
        { id: 'fill_beginner', name: '填空新手', requirement: 1 },
        { id: 'fill_regular', name: '填空常客', requirement: 10 },
        { id: 'fill_expert', name: '填空專家', requirement: 50 },
        { id: 'fill_master', name: '填空大師', requirement: 100 },
        { id: 'fill_perfect', name: '完美填空', requirement: 1 },
        { id: 'fill_speed', name: '快速填空', requirement: 5 },
        { id: 'fill_streak', name: '連續填空', requirement: 7 },
        { id: 'fill_vocab', name: '詞彙填空', requirement: 100 }
      ];
      
      const claimed = JSON.parse(localStorage.getItem('claimedAchievements') || '[]');
      
      achievements.forEach(ach => {
        if (claimed.includes(ach.id)) return; // 已經領取過了
        
        let unlocked = false;
        switch (ach.id) {
          case 'fill_beginner':
          case 'fill_regular':
          case 'fill_expert':
          case 'fill_master':
            unlocked = parseInt(localStorage.getItem('fillGamesCompleted') || '0') >= ach.requirement;
            break;
          case 'fill_perfect':
            unlocked = parseInt(localStorage.getItem('fillPerfectScores') || '0') >= ach.requirement;
            break;
          case 'fill_speed':
            unlocked = parseInt(localStorage.getItem('fillSpeedGames') || '0') >= ach.requirement;
            break;
          case 'fill_streak':
            unlocked = parseInt(localStorage.getItem('fillStreakDays') || '0') >= ach.requirement;
            break;
          case 'fill_vocab':
            unlocked = parseInt(localStorage.getItem('fillCorrectWords') || '0') >= ach.requirement;
            break;
        }
        
        if (unlocked) {
          // 顯示成就達成通知
          showAchievementNotification(ach.name, ach.id);
        }
      });
    }
    
    function showAchievementNotification(achievementName, achievementId) {
      // 創建成就通知
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(10, 20, 40, 0.98), rgba(20, 40, 80, 0.98));
        color: #fff;
        padding: 30px 40px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 1.3rem;
        z-index: 10000;
        box-shadow: 0 0 50px #ffd700, 0 0 100px #00ffff, 0 0 150px rgba(255, 215, 0, 0.5);
        animation: achievementPop 0.8s cubic-bezier(.68, -0.55, .27, 1.55);
        text-align: center;
        min-width: 350px;
        border: 3px solid #ffd700;
        position: relative;
        overflow: hidden;
      `;
      
      notification.innerHTML = `
        <div style="
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
          animation: shimmer 2s infinite;
        "></div>
        <div style="font-size: 4rem; margin-bottom: 15px; filter: drop-shadow(0 0 20px #ffd700); position: relative; z-index: 1;">🏆</div>
        <div style="margin-bottom: 8px; color: #ffd700; font-size: 1.4rem; position: relative; z-index: 1;">🎉 成就達成！</div>
        <div style="font-size: 1.2rem; margin-bottom: 15px; position: relative; z-index: 1;">${achievementName}</div>
        <div style="font-size: 1rem; margin-top: 15px; color: #00ffff; position: relative; z-index: 1;">
          前往成就頁面領取獎勵
        </div>
        <div style="
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          overflow: hidden;
        ">
          ${Array.from({length: 20}, (_, i) => `
            <div style="
              position: absolute;
              width: 6px;
              height: 6px;
              background: ${['#ffd700', '#00ffff', '#a259ff', '#ff6b6b'][i % 4]};
              border-radius: 50%;
              left: ${Math.random() * 100}%;
              top: ${Math.random() * 100}%;
              animation: particleFloat 3s ease-out forwards;
              animation-delay: ${Math.random() * 2}s;
              box-shadow: 0 0 10px currentColor;
            "></div>
          `).join('')}
        </div>
      `;
      
      // 添加動畫樣式
      const style = document.createElement('style');
      style.textContent = `
        @keyframes achievementPop {
          0% { transform: translate(-50%, -50%) scale(0.3) rotate(-15deg); opacity: 0; }
          50% { transform: translate(-50%, -50%) scale(1.15) rotate(3deg); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes particleFloat {
          0% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
          100% { opacity: 0; transform: translateY(-100px) scale(0) rotate(360deg); }
        }
        @keyframes shimmer {
          0% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
          100% { transform: translateX(100%) translateY(100%) rotate(360deg); }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(notification);
      
      // 播放成就音效
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.2);
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.3);
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.4);
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (e) {
        // 如果音效API不可用，靜默處理
      }
      
      // 4秒後自動移除
      setTimeout(() => {
        notification.remove();
        style.remove();
      }, 4000);
    }

    // ===== 初始化 =====
    if (typeof speechSynthesis !== 'undefined') {
      speechSynthesis.onvoiceschanged = pickVoice;
      pickVoice();
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateStarsDisplay();
      document.getElementById('sessionStarsDisplay').textContent = '本次已獲得 0 顆星星';
      initData();
      gameState.currentIndex = 0;
      updateCounter();
      showQuestion();
      localStorage.removeItem('fillIndex');
      
      // 初始化背景音樂
      initBackgroundMusic();
      
      // 初始化時解鎖複習按鈕
      unlockReviewButton();
    });

    // 點擊彈窗外也能關閉
    document.addEventListener('DOMContentLoaded', function() {
      const reviewModal = document.getElementById('reviewModal');
      const gameEndModal = document.getElementById('gameEndModal');
      
      if(reviewModal){
        reviewModal.addEventListener('click', function(e){
          if(e.target === reviewModal){
            closeReviewModal();
          }
        });
      }
      
      if(gameEndModal){
        gameEndModal.addEventListener('click', function(e){
          if(e.target === gameEndModal){
            document.getElementById('gameEndModal').style.display = 'none';
          }
        });
      }
    });

    // 取得主頁選擇的角色（假設存在 localStorage.characterName）
    let currentCharacter = localStorage.getItem('characterName') || 'zeus';
    if (window.GameDialogue) {
      window.GameDialogue.currentCharacter = currentCharacter;
    }

    function showGameStartDialogue() {
      if (window.GameDialogue) {
        window.GameDialogue.showGameStartDialogue();
      }
    }
    function showCorrectAnswerDialogue() {
      if (window.GameDialogue) {
        window.GameDialogue.showCorrectAnswerDialogue();
      }
    }
    function showWrongAnswerDialogue() {
      if (window.GameDialogue) {
        window.GameDialogue.showWrongAnswerDialogue();
      }
    }
    function showGameVictoryDialogue() {
      if (window.GameDialogue) {
        window.GameDialogue.showGameVictoryDialogue();
      }
    }
    function showGameDefeatDialogue() {
      if (window.GameDialogue) {
        window.GameDialogue.showGameDefeatDialogue();
      }
    }
    // 在遊戲初始化時觸發開始對話
    window.addEventListener('DOMContentLoaded', function() {
      if (window.GameDialogue) {
        window.GameDialogue.init();
        showGameStartDialogue();
      }
    });
    // ... existing code ...
    // 在答對時呼叫 showCorrectAnswerDialogue()
    // 在答錯時呼叫 showWrongAnswerDialogue()
    // 在遊戲勝利時呼叫 showGameVictoryDialogue()
    // 在遊戲失敗時呼叫 showGameDefeatDialogue()
    // 請將這些呼叫插入到原本的遊戲流程對應位置
    // ... existing code ...
  </script>
  <script src="js/achievementSystem.js"></script>
</body>
</html>
