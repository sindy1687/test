<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>社交分享 - Typing Hero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="responsive.css">
  <style>
    /* ====== 全域樣式 ====== */
    body {
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: url('https://wallpaperaccess.com/full/192936.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      text-align: center;
      overflow-y: auto;
    }

    header {
      background: rgba(10, 20, 40, 0.85);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 24px 8px #00ffff88, 0 0 40px 0 #a259ff33 inset;
      border-bottom: 2px solid #00ffff;
      backdrop-filter: blur(4px);
      position: relative;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 2.1rem;
      color: #00ffff;
      letter-spacing: 2px;
      text-shadow: 0 0 12px #00ffff, 0 0 32px #a259ff;
    }

    .btn {
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      border: none;
      padding: 10px 22px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 16px #00ffff, 0 0 24px #a259ff99;
      margin-left: 8px;
      font-size: 1.1rem;
      letter-spacing: 1px;
      transition: transform 0.15s, box-shadow 0.15s;
    }

    .btn:hover {
      transform: scale(1.07);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }

    /* ====== 主要內容區域 ====== */
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 20px;
    }

    .share-section {
      background: rgba(10, 20, 40, 0.85);
      border: 2px solid #00ffff;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      backdrop-filter: blur(8px);
    }

    .share-title {
      font-size: 1.8rem;
      color: #00ffff;
      margin-bottom: 16px;
      text-shadow: 0 0 8px #00ffff;
    }

    /* ====== 分享卡片生成器 ====== */
    .share-card-generator {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .share-card {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.1) 0%, rgba(162, 89, 255, 0.1) 100%);
      border: 2px solid #00ffff;
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .share-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 255, 0.05) 50%, transparent 70%);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .share-card-title {
      font-size: 1.3rem;
      color: #ffd700;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
    }

    .share-card-content {
      position: relative;
      z-index: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 16px 0;
    }

    .stat-item {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 8px;
      font-size: 0.9rem;
    }

    .stat-label {
      color: #ccc;
      font-size: 0.8rem;
    }

    .stat-value {
      color: #00ffff;
      font-weight: bold;
      font-size: 1.1rem;
    }

    /* ====== 分享按鈕 ====== */
    .share-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .share-btn {
      background: linear-gradient(45deg, #00ffff, #a259ff);
      color: #000;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 255, 255, 0.4);
    }

    /* ====== 排行榜區域 ====== */
    .leaderboard-section {
      background: rgba(10, 20, 40, 0.85);
      border: 2px solid #ffd700;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      backdrop-filter: blur(8px);
    }

    .leaderboard-title {
      font-size: 1.8rem;
      color: #ffd700;
      margin-bottom: 16px;
      text-shadow: 0 0 8px #ffd700;
    }

    .leaderboard-list {
      display: grid;
      gap: 12px;
    }

    .leaderboard-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .leaderboard-item:hover {
      background: rgba(255, 215, 0, 0.1);
      border-color: #ffd700;
    }

    .rank {
      font-size: 1.2rem;
      font-weight: bold;
      color: #ffd700;
      min-width: 40px;
    }

    .player-info {
      flex: 1;
      text-align: left;
      margin-left: 12px;
    }

    .player-name {
      font-weight: bold;
      color: #fff;
    }

    .player-stats {
      font-size: 0.8rem;
      color: #ccc;
    }

    .player-score {
      font-size: 1.1rem;
      font-weight: bold;
      color: #00ffff;
    }

    /* ====== 討論區域 ====== */
    .discussion-section {
      background: rgba(10, 20, 40, 0.85);
      border: 2px solid #a259ff;
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(8px);
    }

    .discussion-title {
      font-size: 1.8rem;
      color: #a259ff;
      margin-bottom: 16px;
      text-shadow: 0 0 8px #a259ff;
    }

    .discussion-topics {
      display: grid;
      gap: 16px;
    }

    .topic-item {
      background: rgba(162, 89, 255, 0.1);
      border: 1px solid rgba(162, 89, 255, 0.3);
      border-radius: 8px;
      padding: 16px;
      text-align: left;
      transition: all 0.2s;
    }

    .topic-item:hover {
      background: rgba(162, 89, 255, 0.2);
      border-color: #a259ff;
    }

    .topic-title {
      font-weight: bold;
      color: #fff;
      margin-bottom: 8px;
    }

    .topic-desc {
      color: #ccc;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .topic-meta {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.8rem;
      color: #888;
    }

    /* ====== 通知系統 ====== */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(10, 20, 40, 0.95);
      border: 2px solid #00ffff;
      border-radius: 12px;
      padding: 16px 24px;
      color: #fff;
      font-weight: bold;
      z-index: 10000;
      animation: slideDown 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <header>
    <h1>👥 社交分享</h1>
    <div>
      <button class="btn" onclick="location.href='index.html'">🏠 首頁</button>
      <button class="btn" onclick="location.href='cards.html'">📁 卡片收藏</button>
      <button class="btn" onclick="location.href='game_scenarios.html'">🎮 遊戲場景</button>
      <button class="btn" onclick="testDataSync()" style="background: linear-gradient(90deg, #ff6b6b 0%, #ffd700 100%);">🧪 測試連動</button>
    </div>
  </header>

  <div class="main-content">
    <!-- 分享卡片生成器 -->
    <div class="share-section">
      <h2 class="share-title">📤 分享你的收藏</h2>
      <div class="share-card-generator">
        <div class="share-card">
          <div class="share-card-title">🎯 收集進度</div>
          <div class="share-card-content">
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-label">總卡片</div>
                <div class="stat-value" id="totalCards">0</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">已收集</div>
                <div class="stat-value" id="collectedCards">0</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">完成度</div>
                <div class="stat-value" id="completionRate">0%</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">稀有度</div>
                <div class="stat-value" id="rarityLevel">新手</div>
              </div>
            </div>
            <div class="share-buttons">
              <button class="share-btn" onclick="shareProgress()">
                📊 分享進度
              </button>
              <button class="share-btn" onclick="shareAchievement()">
                🏆 分享成就
              </button>
            </div>
          </div>
        </div>

        <div class="share-card">
          <div class="share-card-title">⭐ 稀有收藏</div>
          <div class="share-card-content">
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-label">SSR卡片</div>
                <div class="stat-value" id="ssrCards">0</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">稀有卡片</div>
                <div class="stat-value" id="rareCards">0</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">普通卡片</div>
                <div class="stat-value" id="commonCards">0</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">收集等級</div>
                <div class="stat-value" id="collectionLevel">新手</div>
              </div>
            </div>
            <div class="share-buttons">
              <button class="share-btn" onclick="shareRarity()">
                ⭐ 分享稀有度
              </button>
              <button class="share-btn" onclick="shareCollection()">
                📚 分享收藏
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 新增：詳細統計區域 -->
    <div class="share-section">
      <h2 class="share-title">📊 詳細統計</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">總卡片數</div>
          <div class="stat-value" id="totalCardsDetail">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">已收集</div>
          <div class="stat-value" id="collectedCardsDetail">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">收集進度</div>
          <div class="stat-value" id="collectionProgressPercent">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">總碎片數</div>
          <div class="stat-value" id="totalShards">-</div>
        </div>
      </div>
      
      <!-- 類別統計 -->
      <div style="margin-top: 20px;">
        <h3 style="color: #00ffff; margin-bottom: 10px;">🏷️ 類別統計</h3>
        <div id="categoryStats" style="text-align: left; max-height: 200px; overflow-y: auto;"></div>
      </div>
      
      <!-- 稀有度統計 -->
      <div style="margin-top: 20px;">
        <h3 style="color: #ffd700; margin-bottom: 10px;">⭐ 稀有度統計</h3>
        <div id="rarityStats" style="text-align: left; max-height: 200px; overflow-y: auto;"></div>
      </div>
      
      <!-- 收集進度 -->
      <div style="margin-top: 20px;">
        <h3 style="color: #a259ff; margin-bottom: 10px;">📈 收集進度</h3>
        <div id="collectionProgressDetail" style="text-align: left; max-height: 200px; overflow-y: auto;"></div>
      </div>
    </div>

    <!-- ====== 卡片分析區域 ====== -->
    <div class="share-section">
      <h2 class="share-title">🔍 卡片分析</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <button class="btn" onclick="showCategoryBreakdown()">類別詳情</button>
        <button class="btn" onclick="showRarityBreakdown()">稀有度詳情</button>
        <button class="btn" onclick="showCollectionTips()">收集建議</button>
        <button class="btn" onclick="showNextTargets()">下個目標</button>
      </div>
      
      <!-- 碎片分析 -->
      <div style="margin-top: 20px;">
        <h3 style="color: #ff6b6b; margin-bottom: 10px;">💎 碎片分析</h3>
        <div id="shardAnalysis" style="text-align: left; max-height: 200px; overflow-y: auto;"></div>
      </div>
    </div>

    <!-- ====== 資料匯出匯入區域 ====== -->
    <div class="share-section">
      <h2 class="share-title">💾 資料管理</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <button class="btn" onclick="exportData()">匯出資料</button>
        <button class="btn" onclick="importData()">匯入資料</button>
        <button class="btn" onclick="resetData()">重置資料</button>
        <button class="btn" onclick="testData()">測試資料</button>
      </div>
    </div>

    <!-- 排行榜 -->
    <div class="leaderboard-section">
      <h2 class="leaderboard-title">🏆 收集排行榜</h2>
      <div class="leaderboard-list" id="leaderboardList">
        <!-- 排行榜項目將由JavaScript動態生成 -->
      </div>
    </div>

    <!-- 討論區域 -->
    <div class="discussion-section">
      <h2 class="discussion-title">💬 卡片討論</h2>
      <div class="discussion-topics" id="discussionTopics">
        <!-- 討論主題將由JavaScript動態生成 -->
      </div>
    </div>
  </div>

  <script src="js/sound.js"></script>
  <script src="js/userData.js"></script>
  <script src="cards.js"></script>
  <script>
    // 簡單測試函數
    console.log('social_share.html JavaScript 已載入');
    
    // 載入 cards.js 資料
    let allCards = [];
    let ownedCards = {};
    let stars = 0;

    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM 已載入完成');
      
      // 簡單測試：確保頁面元素存在
      const testElement = document.getElementById('totalCards');
      if (testElement) {
        console.log('頁面元素載入正常');
        testElement.textContent = '測試中...';
      } else {
        console.error('找不到頁面元素');
      }
      
      // 檢查是否已載入 cards.js
      if (typeof window.allCards !== 'undefined') {
        allCards = window.allCards;
        console.log('成功載入 cards.js 資料，共', allCards.length, '張卡片');
        loadUserData();
        updateAllStats();
      } else {
        console.warn('cards.js 尚未載入，請確保已引入該檔案');
        // 載入 cards.js
        const script = document.createElement('script');
        script.src = 'cards.js';
        script.onload = function() {
          allCards = window.allCards || [];
          console.log('動態載入 cards.js 成功，共', allCards.length, '張卡片');
          loadUserData();
          updateAllStats();
        };
        script.onerror = function() {
          console.error('無法載入 cards.js');
          alert('無法載入卡片資料，請檢查 cards.js 檔案是否存在');
        };
        document.head.appendChild(script);
      }
    });

    // 載入使用者資料
    function loadUserData() {
      try {
        // 從 localStorage 載入資料
        const savedOwnedCards = localStorage.getItem('ownedCards');
        const savedStars = localStorage.getItem('totalStars');
        
        if (savedOwnedCards) {
          ownedCards = JSON.parse(savedOwnedCards);
        }
        
        if (savedStars) {
          stars = parseInt(savedStars) || 0;
        }
        
        console.log('載入使用者資料完成');
      } catch (error) {
        console.error('載入使用者資料時發生錯誤:', error);
      }
    }

    // 更新所有統計資料
    function updateAllStats() {
      updateBasicStats();
      updateCategoryStats();
      updateRarityStats();
      updateCollectionProgress();
      updateShardAnalysis();
    }

    // 更新基本統計
    function updateBasicStats() {
      const totalCards = allCards.length;
      const collectedCards = Object.keys(ownedCards).length;
      const collectionProgress = totalCards > 0 ? Math.round((collectedCards / totalCards) * 100) : 0;
      const totalShards = Object.values(shards).reduce((sum, count) => sum + count, 0);
      
      // 更新分享卡片區域
      document.getElementById('totalCards').textContent = totalCards;
      document.getElementById('collectedCards').textContent = collectedCards;
      document.getElementById('completionRate').textContent = collectionProgress + '%';
      
      // 更新詳細統計區域
      document.getElementById('totalCardsDetail').textContent = totalCards;
      document.getElementById('collectedCardsDetail').textContent = collectedCards;
      document.getElementById('collectionProgressPercent').textContent = collectionProgress + '%';
      document.getElementById('totalShards').textContent = totalShards;
    }

    // 更新類別統計
    function updateCategoryStats() {
      const categoryStats = {};
      
      allCards.forEach(card => {
        if (!categoryStats[card.category]) {
          categoryStats[card.category] = { total: 0, collected: 0, shards: 0 };
        }
        categoryStats[card.category].total++;
        
        if (ownedCards[card.word]) {
          categoryStats[card.category].collected++;
        }
        
        const cardShards = shards[card.word] || 0;
        categoryStats[card.category].shards += cardShards;
      });
      
      const categoryStatsHtml = Object.entries(categoryStats)
        .map(([category, stats]) => {
          const progress = Math.round((stats.collected / stats.total) * 100);
          const progressBar = '█'.repeat(Math.floor(progress / 10)) + '░'.repeat(10 - Math.floor(progress / 10));
          return `
            <div style="margin-bottom: 8px; padding: 8px; border-radius: 6px; background: rgba(0,255,255,0.1); border-left: 3px solid #00ffff;">
              <div style="font-weight: bold; color: #00ffff;">${category}</div>
              <div style="font-size: 0.9rem; color: #ccc;">
                ${stats.collected}/${stats.total} (${progress}%) | 碎片: ${stats.shards}
              </div>
              <div style="font-size: 0.8rem; color: #00ffff;">${progressBar}</div>
            </div>
          `;
        }).join('');
      
      document.getElementById('categoryStats').innerHTML = categoryStatsHtml || '<div style="color: #ccc;">尚無資料</div>';
    }

    // 更新稀有度統計
    function updateRarityStats() {
      const rarityStats = {};
      
      allCards.forEach(card => {
        if (!rarityStats[card.rarity]) {
          rarityStats[card.rarity] = { total: 0, collected: 0, shards: 0 };
        }
        rarityStats[card.rarity].total++;
        
        if (ownedCards[card.word]) {
          rarityStats[card.rarity].collected++;
        }
        
        const cardShards = shards[card.word] || 0;
        rarityStats[card.rarity].shards += cardShards;
      });
      
      const rarityStatsHtml = Object.entries(rarityStats)
        .map(([rarity, stats]) => {
          const progress = Math.round((stats.collected / stats.total) * 100);
          const progressBar = '█'.repeat(Math.floor(progress / 10)) + '░'.repeat(10 - Math.floor(progress / 10));
          const rarityColor = rarity === '超稀有' ? '#ffd700' : rarity === '稀有' ? '#a259ff' : '#00ffff';
          return `
            <div style="margin-bottom: 8px; padding: 8px; border-radius: 6px; background: rgba(255,215,0,0.1); border-left: 3px solid ${rarityColor};">
              <div style="font-weight: bold; color: ${rarityColor};">${rarity}</div>
              <div style="font-size: 0.9rem; color: #ccc;">
                ${stats.collected}/${stats.total} (${progress}%) | 碎片: ${stats.shards}
              </div>
              <div style="font-size: 0.8rem; color: ${rarityColor};">${progressBar}</div>
            </div>
          `;
        }).join('');
      
      document.getElementById('rarityStats').innerHTML = rarityStatsHtml || '<div style="color: #ccc;">尚無資料</div>';
    }

    // 更新收集進度
    function updateCollectionProgress() {
      const rarityProgress = {};
      
      // 統計各稀有度的進度
      allCards.forEach(card => {
        if (!rarityProgress[card.rarity]) {
          rarityProgress[card.rarity] = { total: 0, collected: 0, shards: 0 };
        }
        rarityProgress[card.rarity].total++;
        
        if (ownedCards[card.word]) {
          rarityProgress[card.rarity].collected++;
        }
        
        const cardShards = shards[card.word] || 0;
        rarityProgress[card.rarity].shards += cardShards;
      });
      
      // 生成收集進度 HTML
      const progressHtml = Object.entries(rarityProgress)
        .map(([rarity, stats]) => {
          const progress = Math.round((stats.collected / stats.total) * 100);
          const progressBar = '█'.repeat(Math.floor(progress / 10)) + '░'.repeat(10 - Math.floor(progress / 10));
          const rarityColor = rarity === '超稀有' ? '#ffd700' : rarity === '稀有' ? '#a259ff' : '#00ffff';
          return `
            <div style="margin-bottom: 8px; padding: 8px; border-radius: 6px; background: rgba(162,89,255,0.1); border-left: 3px solid ${rarityColor};">
              <div style="font-weight: bold; color: ${rarityColor};">${rarity}</div>
              <div style="font-size: 0.9rem; color: #ccc;">
                ${stats.collected}/${stats.total} (${progress}%) | 碎片: ${stats.shards}
              </div>
              <div style="font-size: 0.8rem; color: ${rarityColor};">${progressBar}</div>
            </div>
          `;
        }).join('');
      
      document.getElementById('collectionProgressDetail').innerHTML = progressHtml || '<div style="color: #ccc;">尚無資料</div>';
    }

    // 更新碎片分析
    function updateShardAnalysis() {
      const shardAnalysis = [];
      
      // 找出碎片最多的卡片
      const sortedShards = Object.entries(shards)
        .filter(([, count]) => count > 0)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);
      
      if (sortedShards.length === 0) {
        document.getElementById('shardAnalysis').innerHTML = '<div style="color: #ccc;">尚無碎片資料</div>';
        return;
      }
      
      const shardHtml = sortedShards
        .map(([word, count]) => {
          const card = allCards.find(c => c.word === word);
          const isOwned = ownedCards[word];
          const status = isOwned ? '✅ 已擁有' : '⏳ 收集中';
          const statusColor = isOwned ? '#00ff00' : '#ff6b6b';
          
          return `
            <div style="margin-bottom: 6px; padding: 6px; border-radius: 4px; background: rgba(255,107,107,0.1);">
              <div style="font-size: 0.9rem; color: #ff6b6b;">
                ${card ? card.zh : word} (${count} 片)
              </div>
              <div style="font-size: 0.8rem; color: ${statusColor};">${status}</div>
            </div>
          `;
        }).join('');
      
      document.getElementById('shardAnalysis').innerHTML = shardHtml;
    }

    // 顯示類別詳情
    function showCategoryBreakdown() {
      const categoryStats = {};
      
      allCards.forEach(card => {
        if (!categoryStats[card.category]) {
          categoryStats[card.category] = { total: 0, collected: 0, shards: 0, cards: [] };
        }
        categoryStats[card.category].total++;
        categoryStats[card.category].cards.push(card);
        
        if (ownedCards[card.word]) {
          categoryStats[card.category].collected++;
        }
        
        const cardShards = shards[card.word] || 0;
        categoryStats[card.category].shards += cardShards;
      });
      
      let breakdownMessage = '🏷️ 類別詳細分析\n\n';
      
      Object.entries(categoryStats)
        .sort(([,a], [,b]) => b.collected - a.collected)
        .forEach(([category, stats]) => {
          const progress = Math.round((stats.collected / stats.total) * 100);
          breakdownMessage += `${category}:\n`;
          breakdownMessage += `• 進度: ${stats.collected}/${stats.total} (${progress}%)\n`;
          breakdownMessage += `• 碎片: ${stats.shards} 片\n`;
          breakdownMessage += `• 稀有度分布: `;
          
          const rarityCount = {};
          stats.cards.forEach(card => {
            rarityCount[card.rarity] = (rarityCount[card.rarity] || 0) + 1;
          });
          breakdownMessage += Object.entries(rarityCount)
            .map(([rarity, count]) => `${rarity}${count}`)
            .join(' ') + '\n\n';
        });
      
      alert(breakdownMessage);
    }

    // 顯示稀有度詳情
    function showRarityBreakdown() {
      const rarityStats = {};
      
      allCards.forEach(card => {
        if (!rarityStats[card.rarity]) {
          rarityStats[card.rarity] = { total: 0, collected: 0, shards: 0, cards: [] };
        }
        rarityStats[card.rarity].total++;
        rarityStats[card.rarity].cards.push(card);
        
        if (ownedCards[card.word]) {
          rarityStats[card.rarity].collected++;
        }
        
        const cardShards = shards[card.word] || 0;
        rarityStats[card.rarity].shards += cardShards;
      });
      
      let breakdownMessage = '⭐ 稀有度詳細分析\n\n';
      
      ['普通', '稀有', '超稀有'].forEach(rarity => {
        const stats = rarityStats[rarity];
        if (stats) {
          const progress = Math.round((stats.collected / stats.total) * 100);
          breakdownMessage += `${rarity}:\n`;
          breakdownMessage += `• 進度: ${stats.collected}/${stats.total} (${progress}%)\n`;
          breakdownMessage += `• 碎片: ${stats.shards} 片\n`;
          breakdownMessage += `• 類別分布: `;
          
          const categoryCount = {};
          stats.cards.forEach(card => {
            categoryCount[card.category] = (categoryCount[card.category] || 0) + 1;
          });
          breakdownMessage += Object.entries(categoryCount)
            .map(([category, count]) => `${category}${count}`)
            .join(' ') + '\n\n';
        }
      });
      
      alert(breakdownMessage);
    }

    // 顯示收集建議
    function showCollectionTips() {
      const tips = [
        '💡 收集建議：',
        '',
        '🎯 優先收集策略：',
        '• 先完成普通卡片，碎片需求較少',
        '• 專注於特定類別，提高完成度',
        '• 保留星星用於稀有卡片',
        '',
        '🏆 碎片管理：',
        '• 優先收集未擁有的卡片碎片',
        '• 已擁有卡片會獲得星星補償',
        '• 定期檢查碎片進度',
        '',
        '🏆 成就目標：',
        '• 完成特定類別收集',
        '• 達到稀有度里程碑',
        '• 分享進度獲得獎勵'
      ].join('\n');
      
      alert(tips);
    }

    // 顯示下個目標
    function showNextTargets() {
      const categoryStats = {};
      
      allCards.forEach(card => {
        if (!categoryStats[card.category]) {
          categoryStats[card.category] = { total: 0, collected: 0, shards: 0 };
        }
        categoryStats[card.category].total++;
        
        if (ownedCards[card.word]) {
          categoryStats[card.category].collected++;
        }
        
        const cardShards = shards[card.word] || 0;
        categoryStats[card.category].shards += cardShards;
      });
      
      // 找出最接近完成的類別
      const targets = Object.entries(categoryStats)
        .map(([category, stats]) => ({
          category,
          progress: stats.collected / stats.total,
          remaining: stats.total - stats.collected,
          shards: stats.shards
        }))
        .filter(target => target.remaining > 0)
        .sort((a, b) => b.progress - a.progress)
        .slice(0, 5);
      
      let targetsMessage = '🎯 下個收集目標\n\n';
      
      if (targets.length === 0) {
        targetsMessage += '🎉 恭喜！你已經收集完所有卡片！';
      } else {
        targets.forEach((target, index) => {
          const progress = Math.round(target.progress * 100);
          targetsMessage += `${index + 1}. ${target.category}\n`;
          targetsMessage += `   進度: ${progress}% (還需 ${target.remaining} 張)\n`;
          targetsMessage += `   碎片: ${target.shards} 片\n\n`;
        });
      }
      
      alert(targetsMessage);
    }

    // 匯出資料
    function exportData() {
      const data = {
        ownedCards,
        stars,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `typing-hero-data-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      alert('資料匯出成功！');
    }

    // 匯入資料
    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const data = JSON.parse(e.target.result);
              
              if (data.ownedCards) ownedCards = data.ownedCards;
              if (data.stars) stars = data.stars;
              
              // 儲存到 localStorage
              localStorage.setItem('ownedCards', JSON.stringify(ownedCards));
              localStorage.setItem('totalStars', stars.toString());
              
              updateAllStats();
              alert('資料匯入成功！');
            } catch (error) {
              alert('匯入失敗：檔案格式錯誤');
              console.error('匯入資料錯誤:', error);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    // 重置資料
    function resetData() {
      if (confirm('確定要重置所有資料嗎？此操作無法復原。')) {
        ownedCards = {};
        stars = 0;
        
        localStorage.removeItem('ownedCards');
        localStorage.removeItem('totalStars');
        
        updateAllStats();
        alert('資料已重置');
      }
    }

    // 測試資料
    function testData() {
      console.log('=== 測試資料 ===');
      console.log('allCards 長度:', allCards.length);
      console.log('ownedCards:', ownedCards);
      console.log('stars:', stars);
      
      // 生成一些測試資料
      if (allCards.length > 0) {
        const testCard = allCards[0];
        if (!ownedCards[testCard.word]) {
          ownedCards[testCard.word] = true;
        }
        stars = 100;
        
        localStorage.setItem('ownedCards', JSON.stringify(ownedCards));
        localStorage.setItem('totalStars', stars.toString());
        
        updateAllStats();
        alert('已生成測試資料！');
      } else {
        alert('無法生成測試資料：cards.js 尚未載入');
      }
    }

    // 測試頁面顯示
    function testPageDisplay() {
      console.log('=== 測試頁面顯示 ===');
      
      // 檢查必要元素是否存在
      const elements = [
        'totalCards', 'collectedCards', 'completionRate',
        'totalCardsDetail', 'collectedCardsDetail', 'collectionProgressPercent', 'totalShards'
      ];
      
      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          console.log(`✓ ${id} 元素存在`);
          element.textContent = '測試';
        } else {
          console.error(`✗ ${id} 元素不存在`);
        }
      });
      
      // 生成測試資料
      if (allCards.length > 0) {
        const testCard = allCards[0];
        if (!ownedCards[testCard.word]) {
          ownedCards[testCard.word] = true;
        }
        stars = 100;
        
        localStorage.setItem('ownedCards', JSON.stringify(ownedCards));
        localStorage.setItem('totalStars', stars.toString());
        
        updateAllStats();
        alert('測試資料已生成！請檢查頁面顯示是否正常。');
      } else {
        alert('無法生成測試資料：cards.js 尚未載入');
      }
    }

    // 頁面載入完成後自動測試
    window.addEventListener('load', function() {
      setTimeout(function() {
        console.log('頁面載入完成，開始測試...');
        testPageDisplay();
        initLeaderboard();
        initDiscussionTopics();
      }, 2000); // 延遲 2 秒測試，確保所有資源已載入
    });

    // 初始化排行榜
    function initLeaderboard() {
      const leaderboardList = document.getElementById('leaderboardList');
      if (!leaderboardList) return;
      
      // 模擬排行榜資料
      const mockLeaderboard = [
        { name: '收集大師', cards: 95, level: '傳奇' },
        { name: '卡片獵人', cards: 87, level: '專家' },
        { name: '收藏家', cards: 76, level: '大師' },
        { name: '新手玩家', cards: 45, level: '進階' },
        { name: '剛開始', cards: 23, level: '新手' }
      ];
      
      const leaderboardHtml = mockLeaderboard.map((player, index) => `
        <div class="leaderboard-item">
          <div class="rank">#${index + 1}</div>
          <div class="player-info">
            <div class="player-name">${player.name}</div>
            <div class="player-stats">等級：${player.level}</div>
          </div>
          <div class="player-score">${player.cards} 張</div>
        </div>
      `).join('');
      
      leaderboardList.innerHTML = leaderboardHtml;
    }

    // 初始化討論主題
    function initDiscussionTopics() {
      const discussionTopics = document.getElementById('discussionTopics');
      if (!discussionTopics) return;
      
      const mockTopics = [
        {
          title: '最難收集的卡片是哪張？',
          desc: '大家覺得哪張卡片的碎片最難收集？分享你的收集心得！',
          author: '收集大師',
          replies: 15,
          views: 128
        },
        {
          title: '碎片系統的改進建議',
          desc: '對於當前的碎片收集機制，大家有什麼想法和建議嗎？',
          author: '卡片獵人',
          replies: 8,
          views: 89
        },
        {
          title: '稀有卡片展示',
          desc: '來曬曬你的稀有卡片收藏吧！看看誰的收藏最厲害！',
          author: '收藏家',
          replies: 23,
          views: 256
        },
        {
          title: '收集策略分享',
          desc: '大家都是用什麼策略來收集卡片的？有什麼小技巧嗎？',
          author: '新手玩家',
          replies: 12,
          views: 156
        }
      ];
      
      const topicsHtml = mockTopics.map(topic => `
        <div class="topic-item">
          <div class="topic-title">${topic.title}</div>
          <div class="topic-desc">${topic.desc}</div>
          <div class="topic-meta">
            <span>作者：${topic.author}</span>
            <span>💬 ${topic.replies} | 👁️ ${topic.views}</span>
          </div>
        </div>
      `).join('');
      
      discussionTopics.innerHTML = topicsHtml;
    }

    // 分享進度
    function shareProgress() {
      const totalCards = allCards.length;
      const collectedCards = Object.keys(ownedCards).length;
      const collectionProgress = totalCards > 0 ? Math.round((collectedCards / totalCards) * 100) : 0;
      
      const shareText = `🎯 我在 Typing Hero 中已收集 ${collectedCards}/${totalCards} 張卡片，完成度 ${collectionProgress}%！\n\n🏆 一起來挑戰收集所有卡片吧！`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Typing Hero 收集進度',
          text: shareText,
          url: window.location.href
        });
      } else {
        // 複製到剪貼簿
        navigator.clipboard.writeText(shareText).then(() => {
          showNotification('📋 分享內容已複製到剪貼簿！');
        }).catch(() => {
          alert(shareText);
        });
      }
    }

    // 分享成就
    function shareAchievement() {
      const totalCards = allCards.length;
      const collectedCards = Object.keys(ownedCards).length;
      const totalShards = Object.values(shards).reduce((sum, count) => sum + count, 0);
      
      let achievement = '新手收集者';
      if (collectedCards >= 100) achievement = '卡片傳奇';
      else if (collectedCards >= 50) achievement = '卡片專家';
      else if (collectedCards >= 20) achievement = '卡片大師';
      else if (collectedCards >= 10) achievement = '收藏家';
      else if (collectedCards >= 1) achievement = '初次收集';
      
      const shareText = `🏆 我在 Typing Hero 中獲得「${achievement}」成就！\n\n📊 收集進度：${collectedCards}/${totalCards} 張卡片\n💎 總碎片：${totalShards} 片\n\n🎮 一起來挑戰更高成就吧！`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Typing Hero 成就分享',
          text: shareText,
          url: window.location.href
        });
      } else {
        navigator.clipboard.writeText(shareText).then(() => {
          showNotification('📋 成就分享內容已複製到剪貼簿！');
        }).catch(() => {
          alert(shareText);
        });
      }
    }

    // 分享稀有度
    function shareRarity() {
      const rarityStats = {};
      
      allCards.forEach(card => {
        if (!rarityStats[card.rarity]) {
          rarityStats[card.rarity] = { total: 0, collected: 0 };
        }
        rarityStats[card.rarity].total++;
        if (ownedCards[card.word]) {
          rarityStats[card.rarity].collected++;
        }
      });
      
      const shareText = `⭐ 我的稀有度收集狀況：\n\n${Object.entries(rarityStats).map(([rarity, stats]) => {
        const progress = Math.round((stats.collected / stats.total) * 100);
        return `${rarity}：${stats.collected}/${stats.total} (${progress}%)`;
      }).join('\n')}\n\n🎯 一起來收集稀有卡片吧！`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Typing Hero 稀有度分享',
          text: shareText,
          url: window.location.href
        });
      } else {
        navigator.clipboard.writeText(shareText).then(() => {
          showNotification('📋 稀有度分享內容已複製到剪貼簿！');
        }).catch(() => {
          alert(shareText);
        });
      }
    }

    // 分享收藏
    function shareCollection() {
      const totalCards = allCards.length;
      const collectedCards = Object.keys(ownedCards).length;
      const totalShards = Object.values(shards).reduce((sum, count) => sum + count, 0);
      
      // 找出最稀有的已收集卡片
      const ownedCardList = allCards.filter(card => ownedCards[card.word]);
      const rarestCard = ownedCardList.sort((a, b) => {
        const rarityOrder = { '普通': 1, '稀有': 2, '超稀有': 3 };
        return rarityOrder[b.rarity] - rarityOrder[a.rarity];
      })[0];
      
      const shareText = `📚 我的收藏展示：\n\n🏆 最稀有卡片：${rarestCard ? `${rarestCard.zh} (${rarestCard.rarity})` : '尚無'}\n📊 收集進度：${collectedCards}/${totalCards} 張\n💎 總碎片：${totalShards} 片\n\n🎮 一起來建立你的收藏吧！`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Typing Hero 收藏分享',
          text: shareText,
          url: window.location.href
        });
      } else {
        navigator.clipboard.writeText(shareText).then(() => {
          showNotification('📋 收藏分享內容已複製到剪貼簿！');
        }).catch(() => {
          alert(shareText);
        });
      }
    }

    // 顯示通知
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // 測試資料連動
    function testDataSync() {
      console.log('=== 測試資料連動 ===');
      
      // 重新載入資料
      loadUserData();
      
      // 檢查資料
      const totalCards = allCards.length;
      const collectedCards = Object.keys(ownedCards).length;
      const totalShards = Object.values(shards).reduce((sum, count) => sum + count, 0);
      
      console.log('allCards 長度:', totalCards);
      console.log('ownedCards:', ownedCards);
      console.log('stars:', stars);
      
      // 檢查 localStorage
      const localStorageOwnedCards = localStorage.getItem('ownedCards');
      const localStorageStars = localStorage.getItem('totalStars');
      
      console.log('localStorage ownedCards:', localStorageOwnedCards);
      console.log('localStorage totalStars:', localStorageStars);
      
      // 生成測試報告
      let report = '🧪 資料連動測試報告\n\n';
      report += `📊 基本統計：\n`;
      report += `• 總卡片數：${totalCards}\n`;
      report += `• 已收集：${collectedCards}\n`;
      report += `• 總碎片：${totalShards}\n`;
      report += `• 星星數：${stars}\n\n`;
      
      report += `💾 localStorage 狀態：\n`;
      report += `• ownedCards：${localStorageOwnedCards ? '✅ 存在' : '❌ 不存在'}\n`;
      report += `• totalStars：${localStorageStars ? '✅ 存在' : '❌ 不存在'}\n\n`;
      
      // 檢查資料一致性
      const ownedCardsFromStorage = localStorageOwnedCards ? JSON.parse(localStorageOwnedCards) : {};
      const starsFromStorage = localStorageStars ? parseInt(localStorageStars) : 0;
      
      const ownedCardsMatch = JSON.stringify(ownedCards) === JSON.stringify(ownedCardsFromStorage);
      const starsMatch = stars === starsFromStorage;
      
      report += `🔗 資料一致性：\n`;
      report += `• ownedCards：${ownedCardsMatch ? '✅ 一致' : '❌ 不一致'}\n`;
      report += `• stars：${starsMatch ? '✅ 一致' : '❌ 不一致'}\n\n`;
      
      if (ownedCardsMatch && starsMatch) {
        report += '🎉 所有資料連動正常！';
      } else {
        report += '⚠️ 發現資料不一致，請檢查 localStorage 設定。';
      }
      
      alert(report);
      
      // 更新頁面顯示
      updateAllStats();
    }
  </script>
</body>
</html>