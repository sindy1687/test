<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è‹±æ‰“å°è‹±é›„ - é¦–é </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* å…¨å±€æ¨£å¼ */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, 'Orbitron', sans-serif;
      background: url('https://th.bing.com/th/id/OIP.EXCeug5EiI00kMhj2ySQUwHaEo?r=0&w=1920&h=1200&rs=1&pid=ImgDetMain') center center fixed;
      background-size: cover;
      color: #f3f6fa;
      min-height: 100vh;
      display: block;
      text-align: center;
    }

    /* æ¨™é¡Œ */
    h1 {
      font-size: 2.8rem;
      color: #e6f0ff;
      text-shadow: 0 2px 12px #2e3a5e, 0 0 40px #a259ff, 0 0 60px #ff6b6b;
      margin: 5px 0 8px;
      text-align: center;
      font-weight: 800;
      letter-spacing: 3px;
      background: none;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
      animation: titleGlow 3s ease-in-out infinite alternate;
      font-family: 'Orbitron', 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
    }

    @keyframes titleGlow {
      0% { filter: brightness(1) saturate(1); }
      100% { filter: brightness(1.2) saturate(1.3); }
    }

    .subtitle {
      font-size: 1.4rem;
      color: #a3b8ff;
      margin-bottom: 12px;
      text-shadow: 0 1px 8px #2e3a5e, 0 0 20px #a259ff;
      font-weight: 600;
      letter-spacing: 2px;
      background: none;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
    }

    .description {
      font-size: 1.1rem;
      color: #b8c7e0;
      margin-bottom: 20px;
      line-height: 1.8;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      text-shadow: 0 1px 6px #2e3a5e;
      font-weight: 400;
      letter-spacing: 0.5px;
      background: none;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
    }

    /* ä¸»è¦å®¹å™¨ */
    #container {
      max-width: 800px;
      width: 90%;
      margin: 4px auto 20px auto;
      padding: 12px;
      background: rgba(10, 20, 40, 0.45);
      border-radius: 20px;
      box-shadow: 0 0 32px #00ffff44, 0 0 80px #a259ff22 inset;
      border: 2px solid #00ffff;
      backdrop-filter: blur(2px);
      text-align: center;
      color: #f3f6fa;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
    }

    /* ç©å®¶åç¨±è¼¸å…¥ */
    #playerName {
      width: 60%;
      padding: 8px 12px;
      margin: 8px 0;
      font-size: 0.95rem;
      background: rgba(10, 20, 40, 0.6);
      border: 2px solid #00ffff;
      border-radius: 10px;
      color: #fff;
      box-shadow: 0 0 20px #00ffff80, 0 0 40px #a259ff40;
      font-family: 'Roboto Mono', monospace;
      text-align: center;
      font-weight: 500;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      backdrop-filter: blur(2px);
    }

    #playerName:focus {
      outline: none;
      border-color: #ff6b6b;
      box-shadow: 0 0 30px #00ffff, 0 0 60px #ff6b6b80;
      transform: scale(1.02);
    }

    #playerName::placeholder {
      color: rgba(255, 255, 255, 0.6);
      font-style: italic;
    }

    /* é ­åƒé¸æ“‡ */
    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 15px;
      margin: 16px 0;
      padding: 15px;
      background: rgba(10, 20, 40, 0.2);
      border-radius: 20px;
      border: 1px solid rgba(0, 255, 255, 0.3);
      backdrop-filter: blur(2px);
    }

    .avatar-option {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid #00ffff;
      transition: all 0.2s ease-out;
      box-shadow: 0 0 20px #00ffff44, 0 0 40px #a259ff22;
      background-size: cover;
      background-position: center top;
      background-repeat: no-repeat;
      position: relative;
      overflow: hidden;
      background-clip: content-box;
    }

    .avatar-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 50%;
    }

    .avatar-option:hover {
      transform: scale(1.08);
      box-shadow: 0 0 30px #00ffff, 0 0 60px #a259ff66;
      border-color: #ff6b6b;
      /* æ‡¸åœæ™‚æ”¾å¤§èƒŒæ™¯åœ–ç‰‡ä»¥æ›´å¥½åœ°é¡¯ç¤ºè‡‰éƒ¨ */
      background-size: 115% auto;
    }

    .avatar-option:hover::before {
      opacity: 1;
    }

    .avatar-option.selected {
      border-color: #ffd700;
      box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd70066;
      transform: scale(1.1);
      animation: selectedPulse 2s ease-in-out infinite;
      /* é¸ä¸­æ™‚ä¹Ÿæ”¾å¤§èƒŒæ™¯åœ–ç‰‡ */
      background-size: 110% auto;
    }

    /* è‡ªè¨‚é ­åƒé¸é …æ¨£å¼ */
    .custom-avatar-option {
      background: linear-gradient(135deg, #a259ff 0%, #ff6b6b 100%) !important;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
    }

    .custom-avatar-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 50%;
    }

    .custom-avatar-option:hover::before {
      opacity: 1;
    }

    .custom-avatar-icon {
      font-size: 2rem;
      margin-bottom: 4px;
      animation: customIconGlow 2s ease-in-out infinite alternate;
    }

    .custom-avatar-text {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 1px;
    }

    @keyframes customIconGlow {
      0% { 
        filter: brightness(1) saturate(1);
        transform: scale(1);
      }
      100% { 
        filter: brightness(1.3) saturate(1.5);
        transform: scale(1.1);
      }
    }

    .custom-avatar-option.selected {
      background: linear-gradient(135deg, #ffd700 0%, #ff6b6b 100%) !important;
      animation: customSelectedPulse 2s ease-in-out infinite;
    }

    @keyframes customSelectedPulse {
      0%, 100% { 
        box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd70066;
        transform: scale(1.1);
      }
      50% { 
        box-shadow: 0 0 40px #ffd700, 0 0 80px #ffd70099;
        transform: scale(1.15);
      }
    }

    @keyframes selectedPulse {
      0%, 100% { box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd70066; }
      50% { box-shadow: 0 0 40px #ffd700, 0 0 80px #ffd70099; }
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      display: inline-block;
      padding: 12px 24px;
      margin: 8px;
      font-size: 1.1rem;
      color: #222b3a;
      background: linear-gradient(135deg, #00ffff 0%, #a259ff 50%, #ff6b6b 100%);
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Orbitron', 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
      font-weight: 700;
      letter-spacing: 1.5px;
      box-shadow: 0 0 20px #00ffff, 0 0 40px #a259ff99, 0 8px 16px rgba(0, 0, 0, 0.3);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 0 30px #00ffff, 0 0 60px #a259ffcc, 0 12px 24px rgba(0, 0, 0, 0.4);
      background: linear-gradient(135deg, #00ffff 0%, #a259ff 30%, #ff6b6b 70%, #ffd700 100%);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:active {
      transform: translateY(-1px) scale(1.02);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* éŸ³æ•ˆæ§åˆ¶ */
    #audioControls {
      position: fixed;
      bottom: 15px;
      right: 15px;
      display: flex;
      gap: 8px;
    }

    #audioControls button {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      border: 2px solid #00ffff;
      background: rgba(10, 20, 40, 0.6);
      color: #fff;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 16px #00ffff;
      backdrop-filter: blur(1px);
    }

    #audioControls button:hover {
      transform: scale(1.1);
      box-shadow: 0 0 32px #00ffff;
    }

    /* ç©å®¶åç¨±é¡¯ç¤º */
    #playerNameDisplay {
      position: fixed;
      top: 15px;
      right: 15px;
      background: rgba(10, 20, 40, 0.6);
      padding: 6px 12px;
      border-radius: 10px;
      color: #ffd700;
      font-weight: bold;
      box-shadow: 0 0 12px #ffd700, 0 0 32px #00ffff;
      border: 2px solid #00ffff;
      font-size: 1.1rem;
      backdrop-filter: blur(1px);
    }

    /* æ˜Ÿæ˜Ÿé¡¯ç¤º */
    #starsDisplay {
      position: fixed;
      top: 15px;
      left: 15px;
      background: rgba(10, 20, 40, 0.6);
      padding: 4px 8px;
      border-radius: 10px;
      color: #ffd700;
      font-weight: bold;
      box-shadow: 0 0 12px #ffd700, 0 0 32px #00ffff;
      border: 2px solid #00ffff;
      font-size: 1.1rem;
      backdrop-filter: blur(1px);
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 600px) {
      h1 {
        font-size: 1.6rem;
        margin: 3px 0 6px;
      }

      .subtitle {
        font-size: 1.2rem;
        margin-bottom: 8px;
      }

      #container {
        width: 95%;
        padding: 12px;
        margin: 2px auto 0 auto;
        min-height: auto;
        display: block;
      }

      .btn {
        width: 100%;
        margin: 4px 0;
        padding: 10px 20px;
        font-size: 1rem;
      }

      .avatar-grid {
        grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
        gap: 8px;
        margin: 12px 0;
        padding: 12px;
      }

      .avatar-option {
        width: 60px;
        height: 60px;
      }

      #characterPreview {
        width: 200px;
        height: 280px;
        margin: 8px auto;
        background: rgba(10, 20, 40, 0.2);
        backdrop-filter: blur(4px);
      }

      .nav-buttons {
        gap: 8px;
        margin-top: 16px;
        margin-bottom: 20px;
      }

      .nav-btn {
        padding: 8px 14px;
        font-size: 0.9rem;
        overflow: visible !important; /* ç¢ºä¿æˆå°±æŒ‰éˆ•åœ¨æ‰‹æ©Ÿç‰ˆä¹Ÿèƒ½æ­£å¸¸é¡¯ç¤ºæ³¡æ³¡ */
      }

      #characterSlogan {
        font-size: 1rem;
        margin: 8px 0;
        min-height: 1.2rem;
      }

      .main-buttons {
        margin: 12px 0;
      }

      /* å¢åŠ åº•éƒ¨é–“è· */
      body {
        padding-bottom: 20px;
      }

      /* å„ªåŒ–å®¹å™¨é«˜åº¦ */
      #container {
        margin-bottom: 20px;
      }

      /* æ”¹å–„æŒ‰éˆ•é–“è· */
      .main-buttons .btn {
        margin: 6px 0;
      }

      .nav-buttons .nav-btn {
        margin: 4px 0;
      }
    }

    /* å¹³æ¿å°ºå¯¸éŸ¿æ‡‰å¼ */
    @media (min-width: 601px) and (max-width: 1024px) {
      #container {
        width: 85%;
        padding: 20px;
        margin: 10px auto 0 auto;
        min-height: auto;
      }

      h1 {
        font-size: 2.2rem;
        margin: 8px 0 12px;
      }

      .subtitle {
        font-size: 1.3rem;
        margin-bottom: 15px;
      }

      .btn {
        padding: 14px 28px;
        font-size: 1.05rem;
        margin: 6px;
      }

      .nav-btn {
        padding: 12px 20px;
        font-size: 1rem;
      }

      .avatar-grid {
        grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
        gap: 12px;
        margin: 18px 0;
        padding: 18px;
      }

      .avatar-option {
        width: 70px;
        height: 70px;
      }

      #characterPreview {
        width: 250px;
        height: 350px;
        margin: 15px auto;
      }

      #characterSlogan {
        font-size: 1.15rem;
        margin: 12px 0;
      }
    }

    /* å¤§è¢å¹•å„ªåŒ– */
    @media (min-width: 1025px) {
      #container {
        width: 80%;
        max-width: 900px;
        padding: 30px;
        margin: 20px auto 0 auto;
        min-height: auto;
      }

      h1 {
        font-size: 3rem;
        margin: 10px 0 15px;
      }

      .subtitle {
        font-size: 1.5rem;
        margin-bottom: 20px;
      }

      .btn {
        padding: 16px 32px;
        font-size: 1.1rem;
        margin: 8px;
      }

      .nav-btn {
        padding: 14px 24px;
        font-size: 1.05rem;
      }

      .avatar-grid {
        grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
        gap: 15px;
        margin: 20px 0;
        padding: 20px;
      }

      .avatar-option {
        width: 85px;
        height: 85px;
      }

      #characterPreview {
        width: 300px;
        height: 400px;
        margin: 20px auto;
      }

      #characterSlogan {
        font-size: 1.3rem;
        margin: 15px 0;
      }
    }

    /* è¶…å°è¢å¹•å„ªåŒ– */
    @media (max-width: 480px) {
      #container {
        width: 98%;
        padding: 10px;
        margin: 1px auto 0 auto;
        min-height: auto;
      }

      h1 {
        font-size: 1.4rem;
        margin: 2px 0 4px;
      }

      .subtitle {
        font-size: 1.1rem;
        margin-bottom: 6px;
      }

      .btn {
        padding: 8px 16px;
        font-size: 0.9rem;
        margin: 3px 0;
      }

      .nav-btn {
        padding: 6px 12px;
        font-size: 0.85rem;
        margin: 2px 0;
      }

      .avatar-grid {
        grid-template-columns: repeat(auto-fit, minmax(55px, 1fr));
        gap: 6px;
        margin: 10px 0;
        padding: 10px;
      }

      .avatar-option {
        width: 55px;
        height: 55px;
      }

      #characterPreview {
        width: 180px;
        height: 250px;
        margin: 6px auto;
      }

      #characterSlogan {
        font-size: 0.9rem;
        margin: 6px 0;
      }

      /* å¢åŠ æ›´å¤šåº•éƒ¨é–“è· */
      body {
        padding-bottom: 30px;
      }

      #container {
        margin-bottom: 30px;
      }
    }

    /* æ–°å¢æ¨£å¼ */
    .input-group {
      margin: 12px 0;
    }

    #characterPreview {
      width: 300px;
      height: 400px;
      margin: 12px auto;
      border-radius: 15px;
      overflow: hidden;
      background: rgba(10, 20, 40, 0.2);
      backdrop-filter: blur(1px);
    }

    #characterImage {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: transparent;
      mix-blend-mode: screen;
    }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }

    .nav-btn {
      background: linear-gradient(135deg, #a259ff 0%, #ff6b6b 100%);
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      box-shadow: 0 0 16px #a259ff, 0 0 32px #ff6b6b99, 0 6px 12px rgba(0, 0, 0, 0.3);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
      transform-origin: center;
      will-change: transform;
    }

    .nav-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
      pointer-events: none; /* ç¢ºä¿ä¸æœƒå¹²æ“¾æ»‘é¼ äº‹ä»¶ */
    }

    .nav-btn:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 0 24px #a259ff, 0 0 48px #ff6b6bcc, 0 8px 16px rgba(0, 0, 0, 0.4);
      background: linear-gradient(135deg, #a259ff 0%, #ff6b6b 50%, #ffd700 100%);
    }

    .nav-btn:hover::before {
      left: 100%;
    }

    .nav-btn.primary {
      background: linear-gradient(135deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      font-weight: 700;
      box-shadow: 0 0 20px #00ffff, 0 0 40px #a259ff99, 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    .nav-btn.primary:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 0 30px #00ffff, 0 0 60px #a259ffcc, 0 12px 24px rgba(0, 0, 0, 0.4);
      background: linear-gradient(135deg, #00ffff 0%, #a259ff 50%, #ff6b6b 100%);
    }

    /* ä¸»æŒ‰éˆ•å€åŸŸ */
    .main-buttons {
      margin: 16px 0;
    }

    /* è§’è‰²æ¨™èª */
    #characterSlogan {
      font-size: 1.2rem;
      color: #ffe9a3;
      margin: 10px 0;
      text-shadow: 0 1px 8px #2e3a5e, 0 0 12px #ffd700;
      font-weight: 600;
      letter-spacing: 1px;
      min-height: 1.5rem;
      font-style: italic;
      transition: all 0.2s ease-out;
      opacity: 1;
      transform: translateY(0);
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
    }

    /* ä¸»è¦å…§å®¹å­—é«” */
    #container, #container * {
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
      color: #f3f6fa;
    }

    /* æŒ‰éˆ•å­—é«”é¡è‰²å¾®èª¿ */
    .btn, .nav-btn {
      color: #222b3a;
      font-family: 'Orbitron', 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
    }

    /* æ–°å¢ï¼šæˆå°±æ•¸é‡æ³¡æ³¡æ¨£å¼ */
    .achievement-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #ff6b6b, #ff4757);
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
      border: 2px solid white;
      animation: badgePulse 2s ease-in-out infinite;
      z-index: 1000;
      pointer-events: none;
      transform-origin: center;
      will-change: transform;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    @keyframes badgePulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 0 15px rgba(255, 107, 107, 0.8);
      }
    }
    
    .achievement-badge.hidden {
      display: none;
    }

    /* æˆå°±æŒ‰éˆ•ç‰¹æ®Šè™•ç†ï¼šé¿å…hoveræ™‚æ³¡æ³¡ä½ç½®éŒ¯äº‚ */
    .nav-btn#achievementBtn {
      overflow: visible !important;
      position: relative;
      isolation: isolate; /* å‰µå»ºæ–°çš„å±¤ç–Šä¸Šä¸‹æ–‡ */
    }

    /* æˆå°±æŒ‰éˆ•hoveræ™‚ï¼Œä¿æŒæ³¡æ³¡çš„ç›¸å°ä½ç½® */
    .nav-btn#achievementBtn:hover .achievement-badge {
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(255, 107, 107, 0.8);
      animation: none; /* æš«åœåŸæœ¬çš„å‹•ç•« */
    }

    /* æˆå°±æŒ‰éˆ•hoverçµæŸå¾Œï¼Œæ¢å¾©æ³¡æ³¡å‹•ç•« */
    .nav-btn#achievementBtn:not(:hover) .achievement-badge {
      animation: badgePulse 2s ease-in-out infinite;
    }

    /* å„ªåŒ–hoverå‹•ç•«ï¼Œé¿å…èˆ‡æ³¡æ³¡è¡çª */
    .nav-btn:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 0 24px #a259ff, 0 0 48px #ff6b6bcc, 0 8px 16px rgba(0, 0, 0, 0.4);
      background: linear-gradient(135deg, #a259ff 0%, #ff6b6b 50%, #ffd700 100%);
      z-index: 10; /* ç¢ºä¿hoveræ™‚åœ¨æœ€ä¸Šå±¤ */
    }

    /* ç¢ºä¿æ‰€æœ‰æŒ‰éˆ•å‹•ç•«éƒ½ä½¿ç”¨GPUåŠ é€Ÿ */
    .nav-btn, .btn {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      -moz-backface-visibility: hidden;
    }

    /* å„ªåŒ–å‹•ç•«æ€§èƒ½ */
    .nav-btn:hover, .btn:hover {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      -moz-backface-visibility: hidden;
    }



    /* è‡ªè¨‚è¨Šæ¯æ¨£å¼ */
    .custom-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      z-index: 10000;
      animation: messageSlideIn 0.3s ease-out;
      backdrop-filter: blur(5px);
      border: 2px solid;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .custom-message-success {
      background: rgba(46, 204, 113, 0.9);
      border-color: #2ecc71;
    }

    .custom-message-warning {
      background: rgba(241, 196, 15, 0.9);
      border-color: #f1c40f;
      color: #2c3e50;
    }

    .custom-message-info {
      background: rgba(52, 152, 219, 0.9);
      border-color: #3498db;
    }

    .custom-message-error {
      background: rgba(231, 76, 60, 0.9);
      border-color: #e74c3c;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @media (max-width: 600px) {
      .custom-message {
        top: 10px;
        left: 10px;
        right: 10px;
        transform: none;
        text-align: center;
      }
    }

    /* å½ˆçª—æ¨£å¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: modalFadeIn 0.3s ease-out;
    }

    .modal-overlay.show {
      display: flex;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.95) 0%, rgba(20, 40, 80, 0.95) 100%);
      border: 2px solid #00ffff;
      border-radius: 20px;
      padding: 0;
      max-width: 90%;
      width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 0 50px #00ffff44, 0 0 100px #a259ff22;
      backdrop-filter: blur(10px);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 2px solid rgba(0, 255, 255, 0.3);
      background: rgba(0, 255, 255, 0.1);
    }

    .modal-header h3 {
      margin: 0;
      color: #00ffff;
      font-size: 1.4rem;
      font-weight: 700;
      text-shadow: 0 0 10px #00ffff;
    }

    .modal-close {
      background: none;
      border: 2px solid #ff6b6b;
      color: #ff6b6b;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: #ff6b6b;
      color: #fff;
      box-shadow: 0 0 20px #ff6b6b;
      transform: scale(1.1);
    }

    .modal-body {
      padding: 25px;
      display: flex;
      gap: 25px;
      flex-wrap: wrap;
    }

    .modal-avatar-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      min-width: 200px;
    }

    .modal-avatar-preview {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 3px solid #00ffff;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      background: rgba(10, 20, 40, 0.6);
      box-shadow: 0 0 30px #00ffff44;
      transition: all 0.3s ease;
    }

    .modal-avatar-preview:hover {
      transform: scale(1.05);
      box-shadow: 0 0 40px #00ffff66;
    }

    .modal-avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .modal-upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 1rem;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-avatar-preview:hover .modal-upload-overlay {
      opacity: 1;
    }

    .modal-upload-overlay span {
      font-size: 2.5rem;
      margin-bottom: 8px;
    }

    .modal-upload-overlay p {
      margin: 0;
      font-size: 0.9rem;
    }

    .modal-avatar-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .modal-upload-btn, .modal-reset-btn {
      padding: 10px 18px;
      border: 2px solid #00ffff;
      background: rgba(10, 20, 40, 0.8);
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(2px);
    }

    .modal-upload-btn:hover, .modal-reset-btn:hover {
      background: rgba(0, 255, 255, 0.2);
      box-shadow: 0 0 20px #00ffff;
      transform: translateY(-2px);
    }

    .modal-info-section {
      flex: 1;
      min-width: 250px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .modal-input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-input-group label {
      font-size: 1rem;
      color: #a3b8ff;
      font-weight: 600;
    }

    .modal-input-group input,
    .modal-input-group textarea,
    .modal-input-group select {
      padding: 12px 15px;
      background: rgba(10, 20, 40, 0.6);
      border: 2px solid #00ffff;
      border-radius: 10px;
      color: #fff;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(2px);
    }

    .modal-input-group input:focus,
    .modal-input-group textarea:focus,
    .modal-input-group select:focus {
      outline: none;
      border-color: #ff6b6b;
      box-shadow: 0 0 20px #00ffff;
    }

    .modal-input-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      padding: 20px 25px;
      border-top: 2px solid rgba(0, 255, 255, 0.3);
      background: rgba(0, 255, 255, 0.05);
    }

    .modal-cancel-btn, .modal-save-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .modal-cancel-btn {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%);
      color: #fff;
      box-shadow: 0 0 20px #ff6b6b44;
    }

    .modal-cancel-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px #ff6b6b66;
    }

    .modal-save-btn {
      background: linear-gradient(135deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      box-shadow: 0 0 20px #00ffff44;
    }

    .modal-save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px #00ffff66;
      background: linear-gradient(135deg, #00ffff 0%, #a259ff 50%, #ff6b6b 100%);
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        max-height: 95vh;
      }

      .modal-body {
        flex-direction: column;
        align-items: center;
      }

      .modal-avatar-section {
        min-width: auto;
      }

      .modal-info-section {
        min-width: 100%;
      }

      .modal-footer {
        flex-direction: column;
      }

      .modal-cancel-btn, .modal-save-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- æ˜Ÿæ˜Ÿé¡¯ç¤º -->
  <div id="starsDisplay">
    â­<span id="totalStarsCount">0</span>
  </div>

  <!-- ä¸»å€åŸŸ -->
  <div id="container">
    <h1>ğŸŒŒ æ˜Ÿéš›è‹±æ‰“å†’éšª</h1>
    <p class="subtitle">é–‹å§‹ä½ çš„æ‰“å­—è‹±é›„ä¹‹æ—…ï¼</p>

    <!-- ä½¿ç”¨è€…åç¨±è¼¸å…¥ -->
    <div class="input-group">
      <input type="text" id="playerName" placeholder="è«‹è¼¸å…¥æ‚¨çš„åå­—" maxlength="10">
    </div>

    <!-- è§’è‰²é è¦½ -->
    <div id="characterPreview">
      <img id="characterImage" src="img/avatars/avatar_astro1.png" alt="è§’è‰²é è¦½">
    </div>

    <!-- è§’è‰²æ¨™èª -->
    <div id="characterSlogan" style="
      font-size: 1.2rem;
      color: #ffd700;
      margin: 10px 0;
      text-shadow: 0 0 12px #ffd700, 0 0 24px #ff6b6b;
      font-weight: 600;
      letter-spacing: 1px;
      min-height: 1.5rem;
      font-style: italic;
      transition: all 0.2s ease-out;
      opacity: 1;
      transform: translateY(0);
    ">ğŸŒŸ å‹‡æ•¢çš„æ˜Ÿéš›æˆ°å£«ï¼Œæº–å‚™å¥½è¿æ¥æŒ‘æˆ°äº†å—ï¼Ÿ</div>

    <!-- é ­åƒé¸æ“‡ -->
    <div class="avatar-grid">
      <div class="avatar-option selected" style="background-image: url('img/avatars/avatar_TL.png');" onclick="selectAvatar(this, 'img/avatars/avatar_TL.png', 'ğŸŒŸ å‹‡æ•¢çš„æ˜Ÿéš›æˆ°å£«ï¼Œæº–å‚™å¥½è¿æ¥æŒ‘æˆ°äº†å—ï¼Ÿ', {rate: 0.9, pitch: 1.0, volume: 0.9, characterType: 'warrior'})"></div>
      <div class="avatar-option" style="background-image: url('img/avatars/avatar_TR.png');" onclick="selectAvatar(this, 'img/avatars/avatar_TR.png', 'âš¡ é–ƒé›»èˆ¬çš„é€Ÿåº¦ï¼Œç„¡äººèƒ½æ•µï¼', {rate: 1.1, pitch: 1.2, volume: 0.9, characterType: 'speedster'})"></div>
      <div class="avatar-option" style="background-image: url('img/avatars/avatar_BL.png');" onclick="selectAvatar(this, 'img/avatars/avatar_BL.png', 'ğŸ›¡ï¸ å …ä¸å¯æ‘§çš„é˜²ç¦¦ï¼Œå®ˆè­·ä½ çš„å¤¢æƒ³ï¼', {rate: 0.8, pitch: 0.9, volume: 0.95, characterType: 'defender'})"></div>
      <div class="avatar-option" style="background-image: url('img/avatars/avatar_BR.png');" onclick="selectAvatar(this, 'img/avatars/avatar_BR.png', 'ğŸ¯ ç²¾æº–çš„ç„æº–ï¼Œç™¾ç™¼ç™¾ä¸­ï¼', {rate: 0.95, pitch: 1.1, volume: 0.9, characterType: 'sharpshooter'})"></div>
      <div class="avatar-option" style="background-image: url('img/avatars/avatar_spacekid.png');" onclick="selectAvatar(this, 'img/avatars/avatar_spacekid.png', 'ğŸŒˆ ç´”çœŸçš„å¿ƒéˆï¼Œå‰µé€ å¥‡è¹Ÿçš„åŠ›é‡ï¼', {rate: 1.0, pitch: 1.3, volume: 0.85, characterType: 'magician'})"></div>
      <div class="avatar-option" style="background-image: url('img/avatars/avatar_astro1.png');" onclick="selectAvatar(this, 'img/avatars/avatar_astro1.png', 'ğŸš€ æ¢ç´¢æœªçŸ¥çš„å®‡å®™ï¼Œç™¼ç¾ç„¡é™å¯èƒ½ï¼', {rate: 0.85, pitch: 1.05, volume: 0.9, characterType: 'explorer'})"></div>
      <div class="avatar-option" style="background-image: url('img/avatars/vDS8zQP9HdvxX0g (1).png');" onclick="selectAvatar(this, 'img/avatars/vDS8zQP9HdvxX0g (1).png', 'ğŸŒ¸ æº«æŸ”çš„æ«»èŠ±ç²¾éˆï¼Œæ•£æ’­ç¾å¥½èˆ‡å¸Œæœ›ï¼', {rate: 0.85, pitch: 1.05, volume: 0.9, characterType: 'fairy'})"></div>
      <div class="avatar-option custom-avatar-option" onclick="selectCustomAvatar(this)">
        <div class="custom-avatar-icon">ğŸ¨</div>
        <div class="custom-avatar-text">è‡ªè¨‚</div>
      </div>
    </div>



    <!-- è‡ªè¨‚è¨­å®šå½ˆçª— -->
    <div id="customModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3>ğŸ¨ è‡ªè¨‚è§’è‰²è¨­å®š</h3>
          <button class="modal-close" onclick="closeCustomModal()">âœ•</button>
        </div>
        
        <div class="modal-body">
          <div class="modal-avatar-section">
            <div class="modal-avatar-preview" id="modalAvatarPreview">
              <img id="modalAvatarImage" src="img/avatars/avatar_TL.png" alt="å½ˆçª—é ­åƒé è¦½">
              <div class="modal-upload-overlay">
                <span>ğŸ“·</span>
                <p>é»æ“Šä¸Šå‚³</p>
              </div>
            </div>
            <input type="file" id="modalAvatarUpload" accept="image/*" style="display: none;">
            <div class="modal-avatar-buttons">
              <button class="modal-upload-btn" onclick="document.getElementById('modalAvatarUpload').click()">
                ğŸ“ é¸æ“‡åœ–ç‰‡
              </button>
              <button class="modal-reset-btn" onclick="resetModalAvatar()">
                ğŸ”„ é‡ç½®
              </button>
            </div>
          </div>
          
          <div class="modal-info-section">
            <div class="modal-input-group">
              <label for="modalPlayerName">è§’è‰²åç¨±:</label>
              <input type="text" id="modalPlayerName" placeholder="è¼¸å…¥ä½ çš„è§’è‰²åç¨±" maxlength="15">
            </div>
            
            <div class="modal-input-group">
              <label for="modalSlogan">è§’è‰²æ¨™èª:</label>
              <textarea id="modalSlogan" placeholder="å¯«ä¸‹ä½ çš„è§’è‰²æ¨™èª..." maxlength="50" rows="2"></textarea>
            </div>
            
            <div class="modal-input-group">
              <label for="modalCharacterType">è§’è‰²é¡å‹:</label>
              <select id="modalCharacterType">
                <option value="warrior">æˆ°å£«</option>
                <option value="speedster">é€Ÿåº¦è€…</option>
                <option value="defender">é˜²ç¦¦è€…</option>
                <option value="sharpshooter">å°„æ‰‹</option>
                <option value="magician">é­”æ³•å¸«</option>
                <option value="explorer">æ¢éšªå®¶</option>
                <option value="fairy">ç²¾éˆ</option>
                <option value="custom">è‡ªè¨‚</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="modal-cancel-btn" onclick="closeCustomModal()">
            âŒ å–æ¶ˆ
          </button>
          <button class="modal-save-btn" onclick="saveModalCustomUser()">
            ğŸ’¾ å„²å­˜è¨­å®š
          </button>
        </div>
      </div>
    </div>

    <!-- ä¸»æŒ‰éˆ•å€åŸŸ -->
    <div class="main-buttons">
      <button class="btn" onclick="location.href='atlas.html'">ğŸš€ é–‹å§‹å†’éšª</button>
      <button class="btn" onclick="location.href='book.html'">ğŸ“š å–®å­—æœ¬</button>
      <button class="btn" onclick="location.href='grammar_tower_select.html'">ğŸ›ï¸ æ–‡æ³•å¡”</button>
      <button class="btn" onclick="location.href='shop.html'">ğŸ›’ å•†åŸ</button>
      <button class="btn" onclick="location.href='gacha.html'">ğŸ² æŠ½å¡</button>
    </div>

    <div class="nav-buttons">
      <button class="nav-btn" id="cardsBtn" onclick="location.href='cards.html'">ğŸ“ å¡ç‰‡æ”¶è—</button>
      <button class="nav-btn" id="achievementBtn" onclick="location.href='achievement.html'">ğŸ† æˆå°±å‹³ç« </button>
      <button class="nav-btn" onclick="location.href='autoSaveManager.html'">ğŸ”„ è‡ªå‹•å„²å­˜</button>
    </div>
  </div>

  <!-- éŸ³æ•ˆæ§åˆ¶ -->
  <div id="audioControls">
    <button id="toggleMusic" title="èƒŒæ™¯éŸ³æ¨‚">
      <span class="material-icons">music_note</span>
    </button>
    <button id="testMusic" title="æ¸¬è©¦éŸ³æ¨‚ç³»çµ±" onclick="diagnoseMusicSystem()" style="font-size: 0.8rem; padding: 2px 6px;">
      ğŸ”
    </button>
    <button id="fixScroll" title="ä¿®å¾©æ»¾å‹•" onclick="emergencyFixScroll()" style="font-size: 0.8rem; padding: 2px 6px; background: #ff6b6b;">
      ğŸ”„
    </button>
  </div>

  <!-- éŸ³æ•ˆå…ƒç´  -->
  <audio id="typingSound" preload="auto">
    <source src="sound/type.mp3" type="audio/mpeg">
  </audio>

  <audio id="backgroundMusic" loop>
    <source src="sound/åˆå¾Œæ”¾é¬†æ™‚å…‰ï¼ˆç´”éŸ³æ¨‚ï¼‰.mp3" type="audio/mpeg">
  </audio>

  <script src="js/userData.js"></script>
  <script src="js/sound.js"></script>
  <script src="js/achievementSystem.js"></script>
  <script src="js/characterDialogue.js"></script>
  <script src="cards.js"></script>
  <script>
    console.log('=== JavaScripté–‹å§‹åŸ·è¡Œ ===');
    
    // æˆå°±ç³»çµ±æ•¸æ“šï¼ˆèˆ‡achievement.htmlä¿æŒä¸€è‡´ï¼‰
    const achievements = [
      { id: 'bronze', name: 'éŠ…ç‰Œæ”¶é›†è€…', requirement: 10, reward: 5, icon: 'ğŸ¥‰', type: 'collection', description: 'æ”¶é›†10å¼µå¡ç‰‡ï¼Œé–‹å§‹ä½ çš„æ”¶é›†ä¹‹æ—…' },
      { id: 'silver', name: 'éŠ€ç‰Œæ”¶é›†è€…', requirement: 25, reward: 15, icon: 'ğŸ¥ˆ', type: 'collection', description: 'æ”¶é›†25å¼µå¡ç‰‡ï¼Œå±•ç¾ä½ çš„æ”¶é›†å¯¦åŠ›' },
      { id: 'gold', name: 'é‡‘ç‰Œæ”¶é›†è€…', requirement: 50, reward: 30, icon: 'ğŸ¥‡', type: 'collection', description: 'æ”¶é›†50å¼µå¡ç‰‡ï¼Œæˆç‚ºçœŸæ­£çš„æ”¶é›†è€…' },
      { id: 'platinum', name: 'ç™½é‡‘æ”¶é›†è€…', requirement: 100, reward: 60, icon: 'ğŸ’', type: 'collection', description: 'æ”¶é›†100å¼µå¡ç‰‡ï¼Œé”åˆ°ç™½é‡‘ç­‰ç´š' },
      { id: 'diamond', name: 'é‘½çŸ³æ”¶é›†è€…', requirement: 200, reward: 120, icon: 'ğŸ’ ', type: 'collection', description: 'æ”¶é›†200å¼µå¡ç‰‡ï¼Œç²å¾—é‘½çŸ³æ¦®è€€' },
      { id: 'master', name: 'æ”¶é›†å¤§å¸«', requirement: 500, reward: 300, icon: 'ğŸ‘‘', type: 'collection', description: 'æ”¶é›†500å¼µå¡ç‰‡ï¼Œæˆç‚ºæ”¶é›†å¤§å¸«' },
      { id: 'common_master', name: 'æ™®é€šå¡å¤§å¸«', requirement: 50, reward: 20, icon: 'ğŸ“š', type: 'rarity', rarity: 'æ™®é€š', description: 'æ”¶é›†50å¼µæ™®é€šå¡ç‰‡ï¼ŒæŒæ¡åŸºç¤è©å½™' },
      { id: 'rare_master', name: 'ç¨€æœ‰å¡å¤§å¸«', requirement: 30, reward: 40, icon: 'ğŸ”®', type: 'rarity', rarity: 'ç¨€æœ‰', description: 'æ”¶é›†30å¼µç¨€æœ‰å¡ç‰‡ï¼Œæ“´å±•è©å½™ç¯„åœ' },
      { id: 'epic_master', name: 'è¶…ç¨€æœ‰å¤§å¸«', requirement: 20, reward: 80, icon: 'ğŸŒŸ', type: 'rarity', rarity: 'è¶…ç¨€æœ‰', description: 'æ”¶é›†20å¼µè¶…ç¨€æœ‰å¡ç‰‡ï¼ŒæŒæ¡é«˜ç´šè©å½™' },
      { id: 'shard_collector', name: 'ç¢ç‰‡æ”¶é›†è€…', requirement: 100, reward: 25, icon: 'ğŸ’', type: 'shards', description: 'æ”¶é›†100å€‹ç¢ç‰‡ï¼Œé–‹å§‹ç¢ç‰‡æ”¶é›†ä¹‹è·¯' },
      { id: 'shard_hoarder', name: 'ç¢ç‰‡å›¤ç©è€…', requirement: 500, reward: 100, icon: 'ğŸ¦', type: 'shards', description: 'æ”¶é›†500å€‹ç¢ç‰‡ï¼Œæˆç‚ºç¢ç‰‡å›¤ç©è€…' },
      { id: 'shard_master', name: 'ç¢ç‰‡å¤§å¸«', requirement: 1000, reward: 200, icon: 'ğŸ’', type: 'shards', description: 'æ”¶é›†1000å€‹ç¢ç‰‡ï¼Œæˆç‚ºç¢ç‰‡å¤§å¸«' },
      { id: 'first_card', name: 'åˆå­¸è€…', requirement: 1, reward: 1, icon: 'ğŸ¯', type: 'special', description: 'ç²å¾—ç¬¬ä¸€å¼µå¡ç‰‡ï¼Œé–‹å§‹å­¸ç¿’ä¹‹æ—…' },
      { id: 'lucky_starter', name: 'å¹¸é‹æ–°æ‰‹', requirement: 5, reward: 5, icon: 'ğŸ€', type: 'special', description: 'ç²å¾—5å¼µå¡ç‰‡ï¼Œå±•ç¾ä½ çš„å¹¸é‹' },
      { id: 'dedicated', name: 'å°ˆæ³¨å­¸ç¿’è€…', requirement: 25, reward: 20, icon: 'ï¿½ï¿½', type: 'special', description: 'ç²å¾—25å¼µå¡ç‰‡ï¼Œå±•ç¾ä½ çš„å°ˆæ³¨' },
      { id: 'persistent', name: 'å …æŒä¸æ‡ˆ', requirement: 75, reward: 60, icon: 'ğŸ’ª', type: 'special', description: 'ç²å¾—75å¼µå¡ç‰‡ï¼Œå±•ç¾ä½ çš„å …æŒ' },
      { id: 'vocabulary_king', name: 'è©å½™ä¹‹ç‹', requirement: 150, reward: 150, icon: 'ğŸ‘‘', type: 'special', description: 'ç²å¾—150å¼µå¡ç‰‡ï¼Œæˆç‚ºè©å½™ä¹‹ç‹' },
      { id: 'language_legend', name: 'èªè¨€å‚³å¥‡', requirement: 300, reward: 300, icon: 'ğŸ†', type: 'special', description: 'ç²å¾—300å¼µå¡ç‰‡ï¼Œæˆç‚ºèªè¨€å‚³å¥‡' },
      { id: 'daily_1', name: 'æ¯æ—¥ç°½åˆ°1å¤©', requirement: 1, reward: 2, icon: 'ğŸ“…', type: 'daily', description: 'é€£çºŒç°½åˆ°1å¤©ï¼Œé¤Šæˆå¥½ç¿’æ…£' },
      { id: 'daily_7', name: 'æ¯æ—¥ç°½åˆ°7å¤©', requirement: 7, reward: 10, icon: 'ğŸ“†', type: 'daily', description: 'é€£çºŒç°½åˆ°7å¤©ï¼Œå …æŒä¸€é€±' },
      { id: 'daily_30', name: 'æ¯æ—¥ç°½åˆ°30å¤©', requirement: 30, reward: 50, icon: 'ğŸ—“ï¸', type: 'daily', description: 'é€£çºŒç°½åˆ°30å¤©ï¼Œå …æŒä¸€å€‹æœˆ' },
      { id: 'daily_100', name: 'æ¯æ—¥ç°½åˆ°100å¤©', requirement: 100, reward: 200, icon: 'ğŸ“Š', type: 'daily', description: 'é€£çºŒç°½åˆ°100å¤©ï¼Œæˆç‚ºå¿ å¯¦ç”¨æˆ¶' },
      { id: 'star_collector', name: 'æ˜Ÿæ˜Ÿæ”¶é›†è€…', requirement: 100, reward: 10, icon: 'â­', type: 'stars', description: 'æ”¶é›†100é¡†æ˜Ÿæ˜Ÿï¼Œé–‹å§‹æ˜Ÿæ˜Ÿæ”¶é›†' },
      { id: 'star_hoarder', name: 'æ˜Ÿæ˜Ÿå›¤ç©è€…', requirement: 500, reward: 50, icon: 'âœ¨', type: 'stars', description: 'æ”¶é›†500é¡†æ˜Ÿæ˜Ÿï¼Œæˆç‚ºæ˜Ÿæ˜Ÿå›¤ç©è€…' },
      { id: 'star_master', name: 'æ˜Ÿæ˜Ÿå¤§å¸«', requirement: 1000, reward: 100, icon: 'ğŸŒŸ', type: 'stars', description: 'æ”¶é›†1000é¡†æ˜Ÿæ˜Ÿï¼Œæˆç‚ºæ˜Ÿæ˜Ÿå¤§å¸«' },
      { id: 'star_legend', name: 'æ˜Ÿæ˜Ÿå‚³å¥‡', requirement: 5000, reward: 500, icon: 'ğŸ’«', type: 'stars', description: 'æ”¶é›†5000é¡†æ˜Ÿæ˜Ÿï¼Œæˆç‚ºæ˜Ÿæ˜Ÿå‚³å¥‡' },
      { id: 'speed_learner', name: 'å¿«é€Ÿå­¸ç¿’è€…', requirement: 10, reward: 15, icon: 'âš¡', type: 'performance', description: 'é€šé10å€‹é—œå¡ï¼Œå±•ç¾å¿«é€Ÿå­¸ç¿’èƒ½åŠ›' },
      { id: 'accuracy_master', name: 'æº–ç¢ºå¤§å¸«', requirement: 20, reward: 25, icon: 'ğŸ¯', type: 'performance', description: 'é€šé20å€‹é—œå¡ï¼Œå±•ç¾æº–ç¢ºçš„å­¸ç¿’èƒ½åŠ›' },
      { id: 'combo_king', name: 'é€£æ“Šä¹‹ç‹', requirement: 15, reward: 30, icon: 'ğŸ”¥', type: 'performance', description: 'é€šé15å€‹é—œå¡ï¼Œå±•ç¾é€£æ“Šèƒ½åŠ›' },
      { id: 'fill_beginner', name: 'å¡«ç©ºæ–°æ‰‹', requirement: 1, reward: 5, icon: 'ğŸ“', type: 'fill', description: 'å®Œæˆç¬¬ä¸€æ¬¡å¡«ç©ºæŒ‘æˆ°' },
      { id: 'fill_regular', name: 'å¡«ç©ºå¸¸å®¢', requirement: 10, reward: 20, icon: 'ğŸ“‹', type: 'fill', description: 'å®Œæˆ10æ¬¡å¡«ç©ºæŒ‘æˆ°' },
      { id: 'fill_expert', name: 'å¡«ç©ºå°ˆå®¶', requirement: 50, reward: 80, icon: 'ğŸ“Š', type: 'fill', description: 'å®Œæˆ50æ¬¡å¡«ç©ºæŒ‘æˆ°' },
      { id: 'fill_master', name: 'å¡«ç©ºå¤§å¸«', requirement: 100, reward: 150, icon: 'ğŸ†', type: 'fill', description: 'å®Œæˆ100æ¬¡å¡«ç©ºæŒ‘æˆ°' },
      { id: 'fill_perfect', name: 'å®Œç¾å¡«ç©º', requirement: 1, reward: 30, icon: 'ğŸ’¯', type: 'fill', description: 'åœ¨å¡«ç©ºæŒ‘æˆ°ä¸­ç²å¾—æ»¿åˆ†' },
      { id: 'fill_speed', name: 'å¿«é€Ÿå¡«ç©º', requirement: 5, reward: 25, icon: 'âš¡', type: 'fill', description: 'åœ¨5æ¬¡å¡«ç©ºæŒ‘æˆ°ä¸­å¹³å‡æ™‚é–“å°‘æ–¼15ç§’' },
      { id: 'fill_streak', name: 'é€£çºŒå¡«ç©º', requirement: 7, reward: 40, icon: 'ğŸ”¥', type: 'fill', description: 'é€£çºŒ7å¤©å®Œæˆå¡«ç©ºæŒ‘æˆ°' },
      { id: 'fill_vocab', name: 'è©å½™å¡«ç©º', requirement: 100, reward: 60, icon: 'ğŸ“š', type: 'fill', description: 'åœ¨å¡«ç©ºæŒ‘æˆ°ä¸­ç­”å°100å€‹å–®å­—' },
      { id: 'vocab_beginner', name: 'å–®å­—æ–°æ‰‹', requirement: 10, reward: 15, icon: 'ğŸ“–', type: 'vocabulary', description: 'ç­”å°10å€‹å–®å­—æœ¬çš„å–®å­—ï¼Œé–‹å§‹å–®å­—å­¸ç¿’ä¹‹æ—…' },
      { id: 'vocab_regular', name: 'å–®å­—å¸¸å®¢', requirement: 50, reward: 40, icon: 'ğŸ“š', type: 'vocabulary', description: 'ç­”å°50å€‹å–®å­—æœ¬çš„å–®å­—ï¼Œå±•ç¾å­¸ç¿’ç†±æƒ…' },
      { id: 'vocab_expert', name: 'å–®å­—å°ˆå®¶', requirement: 100, reward: 80, icon: 'ğŸ“', type: 'vocabulary', description: 'ç­”å°100å€‹å–®å­—æœ¬çš„å–®å­—ï¼Œæˆç‚ºå–®å­—å°ˆå®¶' },
      { id: 'vocab_master', name: 'å–®å­—å¤§å¸«', requirement: 200, reward: 150, icon: 'ğŸ‘‘', type: 'vocabulary', description: 'ç­”å°200å€‹å–®å­—æœ¬çš„å–®å­—ï¼Œæˆç‚ºå–®å­—å¤§å¸«' },
      { id: 'vocab_legend', name: 'å–®å­—å‚³å¥‡', requirement: 500, reward: 300, icon: 'ğŸ†', type: 'vocabulary', description: 'ç­”å°500å€‹å–®å­—æœ¬çš„å–®å­—ï¼Œæˆç‚ºå–®å­—å‚³å¥‡' },
      // æ˜Ÿåº§æˆå°±
      { id: 'pass_aries', name: 'é€šéç™½ç¾Šåº§', requirement: 1, reward: 5, icon: 'â™ˆ', type: 'zodiac', description: 'é€šéç™½ç¾Šåº§é—œå¡', rewardRange: [5,5] },
      { id: 'pass_taurus', name: 'é€šéé‡‘ç‰›åº§', requirement: 1, reward: 5, icon: 'â™‰', type: 'zodiac', description: 'é€šéé‡‘ç‰›åº§é—œå¡', rewardRange: [5,5] },
      { id: 'pass_gemini', name: 'é€šéé›™å­åº§', requirement: 1, reward: 5, icon: 'â™Š', type: 'zodiac', description: 'é€šéé›™å­åº§é—œå¡', rewardRange: [5,5] },
      { id: 'pass_cancer', name: 'é€šéå·¨èŸ¹åº§', requirement: 1, reward: 7, icon: 'â™‹', type: 'zodiac', description: 'é€šéå·¨èŸ¹åº§é—œå¡', rewardRange: [7,10] },
      { id: 'pass_leo', name: 'é€šéç…å­åº§', requirement: 1, reward: 8, icon: 'â™Œ', type: 'zodiac', description: 'é€šéç…å­åº§é—œå¡', rewardRange: [8,12] },
      { id: 'pass_virgo', name: 'é€šéè™•å¥³åº§', requirement: 1, reward: 9, icon: 'â™', type: 'zodiac', description: 'é€šéè™•å¥³åº§é—œå¡', rewardRange: [9,13] },
      { id: 'pass_libra', name: 'é€šéå¤©ç§¤åº§', requirement: 1, reward: 10, icon: 'â™', type: 'zodiac', description: 'é€šéå¤©ç§¤åº§é—œå¡', rewardRange: [10,14] },
      { id: 'pass_scorpio', name: 'é€šéå¤©è åº§', requirement: 1, reward: 11, icon: 'â™', type: 'zodiac', description: 'é€šéå¤©è åº§é—œå¡', rewardRange: [11,15] },
      { id: 'pass_sagittarius', name: 'é€šéå°„æ‰‹åº§', requirement: 1, reward: 12, icon: 'â™', type: 'zodiac', description: 'é€šéå°„æ‰‹åº§é—œå¡', rewardRange: [12,16] },
      { id: 'pass_capricorn', name: 'é€šéæ‘©ç¾¯åº§', requirement: 1, reward: 13, icon: 'â™‘', type: 'zodiac', description: 'é€šéæ‘©ç¾¯åº§é—œå¡', rewardRange: [13,17] },
      { id: 'pass_aquarius', name: 'é€šéæ°´ç“¶åº§', requirement: 1, reward: 14, icon: 'â™’', type: 'zodiac', description: 'é€šéæ°´ç“¶åº§é—œå¡', rewardRange: [14,18] },
      { id: 'pass_pisces', name: 'é€šéé›™é­šåº§', requirement: 1, reward: 15, icon: 'â™“', type: 'zodiac', description: 'é€šéé›™é­šåº§é—œå¡', rewardRange: [15,20] },
      { id: 'pass_andromeda', name: 'é€šéä»™å¥³åº§', requirement: 1, reward: 16, icon: 'ğŸ‘¸', type: 'zodiac', description: 'é€šéä»™å¥³åº§é—œå¡', rewardRange: [16,20] },
      { id: 'pass_cygnus', name: 'é€šéå¤©éµåº§', requirement: 1, reward: 17, icon: 'ğŸ¦¢', type: 'zodiac', description: 'é€šéå¤©éµåº§é—œå¡', rewardRange: [17,20] },
      { id: 'pass_orion', name: 'é€šéçµæˆ¶åº§', requirement: 1, reward: 17, icon: 'ğŸ¹', type: 'zodiac', description: 'é€šéçµæˆ¶åº§é—œå¡', rewardRange: [17,20] },
      { id: 'pass_pegasus', name: 'é€šéé£›é¦¬åº§', requirement: 1, reward: 17, icon: 'ğŸ¦„', type: 'zodiac', description: 'é€šéé£›é¦¬åº§é—œå¡', rewardRange: [17,20] },
      { id: 'pass_cassiopeia', name: 'é€šéä»™ååº§', requirement: 1, reward: 17, icon: 'ğŸ‘‘', type: 'zodiac', description: 'é€šéä»™ååº§é—œå¡', rewardRange: [17,20] },
      { id: 'pass_scorpius', name: 'é€šéå¤©è åº§', requirement: 1, reward: 17, icon: 'ğŸ¦‚', type: 'zodiac', description: 'é€šéå¤©è åº§é—œå¡', rewardRange: [17,20] },
      { id: 'pass_phoenix', name: 'é€šéé³³å‡°åº§', requirement: 1, reward: 17, icon: 'ğŸ”¥', type: 'zodiac', description: 'é€šéé³³å‡°åº§é—œå¡', rewardRange: [17,20] },
      { id: 'pass_vela', name: 'é€šéèˆ¹å¸†åº§', requirement: 1, reward: 17, icon: 'â›µ', type: 'zodiac', description: 'é€šéèˆ¹å¸†åº§é—œå¡', rewardRange: [17,20] },
    ];

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥æ¯æ—¥ç°½åˆ°çå‹µ
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ“„ é é¢è¼‰å…¥å®Œæˆï¼Œæª¢æŸ¥æ»¾å‹•ç‹€æ…‹...');
      
      // ç¢ºä¿æ»¾å‹•åŠŸèƒ½æ­£å¸¸
      document.body.style.overflow = 'auto';
      document.documentElement.style.overflow = 'auto';
      
      // å»¶é²ä¸€é»æ™‚é–“ç¢ºä¿æ‰€æœ‰ç³»çµ±éƒ½å·²è¼‰å…¥
      setTimeout(() => {
        checkDailyReward();
        // ç¢ºä¿cards.jsè¼‰å…¥å®Œæˆå¾Œå†æª¢æŸ¥æˆå°±
        if (window.allCards) {
          updateAchievementBadge();
        } else {
          // å¦‚æœcards.jsé‚„æ²’è¼‰å…¥ï¼Œå†ç­‰ä¸€ä¸‹
          setTimeout(updateAchievementBadge, 2000);
        }
      }, 1000);
    });

    // ç²å–ä¸¦é¡¯ç¤ºæ˜Ÿæ˜Ÿç¸½æ•¸
    function updateStarsDisplay() {
      LinkageSystem.stars.updateDisplay();
    }

    // é é¢è¼‰å…¥æ™‚æ›´æ–°æ˜Ÿæ˜Ÿé¡¯ç¤º
    updateStarsDisplay();

    // æˆå°±ç³»çµ±ç›¸é—œå‡½æ•¸
    function getClaimedAchievements() {
      return JSON.parse(localStorage.getItem('claimedAchievements') || '[]');
    }

    function checkAchievementUnlocked(ach) {
      const ownedCards = JSON.parse(localStorage.getItem('ownedCards') || '{}');
      const shards = JSON.parse(localStorage.getItem('cardShards') || '{}');
      
      switch (ach.type) {
        case 'collection':
        case 'special':
          return Object.keys(ownedCards).length >= ach.requirement;
        case 'rarity':
          // æª¢æŸ¥ç¨€æœ‰åº¦å¡ç‰‡æ•¸é‡
          if (window.allCards) {
            const cardsByRarity = window.allCards.filter(card => 
              card.rarity === ach.rarity && ownedCards[card.word]
            );
            return cardsByRarity.length >= ach.requirement;
          }
          return false; // å¦‚æœæ²’æœ‰allCardsæ•¸æ“šï¼Œè¿”å›false
        case 'shards':
          return Object.values(shards).reduce((sum, c) => sum + c, 0) >= ach.requirement;
        case 'daily':
          return parseInt(localStorage.getItem('loginDays') || '0') >= ach.requirement;
        case 'stars':
          return parseInt(localStorage.getItem('totalStars') || '0') >= ach.requirement;
        case 'performance':
          const fillGames = parseInt(localStorage.getItem('fillGamesCompleted') || '0');
          const cardGames = parseInt(localStorage.getItem('cardGamesCompleted') || '0');
          const quizGames = parseInt(localStorage.getItem('quizGamesCompleted') || '0');
          const spellingGames = parseInt(localStorage.getItem('spellingGamesCompleted') || '0');
          const matchingGames = parseInt(localStorage.getItem('matchingGamesCompleted') || '0');
          const timeChallengeGames = parseInt(localStorage.getItem('timeChallengeGamesCompleted') || '0');
          return (fillGames + cardGames + quizGames + spellingGames + matchingGames + timeChallengeGames) >= ach.requirement;
        case 'fill':
          switch (ach.id) {
            case 'fill_beginner':
            case 'fill_regular':
            case 'fill_expert':
            case 'fill_master':
              return parseInt(localStorage.getItem('fillGamesCompleted') || '0') >= ach.requirement;
            case 'fill_perfect':
              return parseInt(localStorage.getItem('fillPerfectScores') || '0') >= ach.requirement;
            case 'fill_speed':
              return parseInt(localStorage.getItem('fillSpeedGames') || '0') >= ach.requirement;
            case 'fill_streak':
              return parseInt(localStorage.getItem('fillStreakDays') || '0') >= ach.requirement;
            case 'fill_vocab':
              return parseInt(localStorage.getItem('fillCorrectWords') || '0') >= ach.requirement;
            default:
              return false;
          }
        case 'vocabulary':
          return parseInt(localStorage.getItem('vocabularyCorrectWords') || '0') >= ach.requirement;
        case 'zodiac':
          // æ˜Ÿåº§é—œå¡æˆå°±ï¼šæª¢æŸ¥è©²æ˜Ÿåº§æ˜¯å¦å·²é€šé
          const zodiacKey = ach.id.replace('pass_', '');
          const passedAtlas = JSON.parse(localStorage.getItem('passed_atlas') || '[]');
          return passedAtlas.includes(zodiacKey);
        default:
          return false;
      }
    }

    // è¨ˆç®—å¯é ˜å–æˆå°±æ•¸é‡
    function getUnclaimedAchievementsCount() {
      const claimed = getClaimedAchievements();
      return achievements.filter(ach => 
        checkAchievementUnlocked(ach) && !claimed.includes(ach.id)
      ).length;
    }

    // æ›´æ–°æˆå°±æŒ‰éˆ•çš„æ³¡æ³¡
    function updateAchievementBadge() {
      const achievementBtn = document.getElementById('achievementBtn');
      if (!achievementBtn) {
        console.log('æ‰¾ä¸åˆ°æˆå°±æŒ‰éˆ•');
        return;
      }

      const unclaimedCount = getUnclaimedAchievementsCount();
      console.log('å¯é ˜å–æˆå°±æ•¸é‡:', unclaimedCount);
      
      // ç§»é™¤ç¾æœ‰çš„æ³¡æ³¡
      const existingBadge = achievementBtn.querySelector('.achievement-badge');
      if (existingBadge) {
        existingBadge.remove();
      }

      // å¦‚æœæœ‰å¯é ˜å–çš„æˆå°±ï¼Œæ·»åŠ æ³¡æ³¡
      if (unclaimedCount > 0) {
        console.log('æ·»åŠ æˆå°±æ³¡æ³¡ï¼Œæ•¸é‡:', unclaimedCount);
        const badge = document.createElement('div');
        badge.className = 'achievement-badge';
        badge.textContent = unclaimedCount;
        achievementBtn.appendChild(badge);
      } else {
        console.log('æ²’æœ‰å¯é ˜å–çš„æˆå°±');
      }
    }

    // å®šæœŸæª¢æŸ¥æˆå°±ç‹€æ…‹ï¼ˆæ¯30ç§’æª¢æŸ¥ä¸€æ¬¡ï¼‰
    setInterval(updateAchievementBadge, 30000);

    // é é¢ç²å¾—ç„¦é»æ™‚ä¹Ÿæª¢æŸ¥ä¸€æ¬¡
    window.addEventListener('focus', updateAchievementBadge);
    
    // æ¸¬è©¦å‡½æ•¸ï¼šæ‰‹å‹•æª¢æŸ¥æˆå°±ç‹€æ…‹
    function testAchievementBadge() {
      console.log('=== æˆå°±æ³¡æ³¡æ¸¬è©¦ ===');
      console.log('allCardsè¼‰å…¥ç‹€æ…‹:', !!window.allCards);
      console.log('ownedCards:', JSON.parse(localStorage.getItem('ownedCards') || '{}'));
      console.log('claimedAchievements:', getClaimedAchievements());
      
      // æ¸¬è©¦å¹¾å€‹æˆå°±çš„ç‹€æ…‹
      const testAchievements = achievements.slice(0, 5);
      testAchievements.forEach(ach => {
        const unlocked = checkAchievementUnlocked(ach);
        console.log(`${ach.name}: ${unlocked ? 'å·²è§£é–' : 'æœªè§£é–'}`);
      });
      
      // æ¸¬è©¦ç¨‹å¼ç¢¼å·²ç§»é™¤
      
      // é‡æ–°æª¢æŸ¥æˆå°±
      const newUnclaimedCount = getUnclaimedAchievementsCount();
      console.log('æ¸¬è©¦å¾Œå¯é ˜å–æˆå°±æ•¸é‡:', newUnclaimedCount);
      
      updateAchievementBadge();
    }
    
    // é é¢å®Œå…¨è¼‰å…¥å¾Œæ¸¬è©¦
    window.addEventListener('load', function() {
      setTimeout(testAchievementBadge, 3000);
    });

    // é ­åƒé¸æ“‡
    function selectAvatar(element, imagePath, slogan, voiceSettings) {
      // ç§»é™¤å…¶ä»–é ­åƒçš„é¸ä¸­ç‹€æ…‹
      document.querySelectorAll('.avatar-option').forEach(avatar => {
        avatar.classList.remove('selected');
      });
      
      // æ·»åŠ é¸ä¸­ç‹€æ…‹
      element.classList.add('selected');
      
      // æ›´æ–°é ­åƒå’Œè§’è‰²é è¦½
      LinkageSystem.player.setAvatar(imagePath);
      
      // ä¿å­˜é¸æ“‡åˆ°æœ¬åœ°å­˜å„²
      localStorage.setItem('selectedAvatar', imagePath);
      localStorage.setItem('selectedSlogan', slogan);
      localStorage.setItem('selectedVoiceSettings', JSON.stringify(voiceSettings));
      
      // æ›´æ–°è§’è‰²é è¦½åœ–ç‰‡
      document.getElementById('characterImage').src = imagePath;
      
      // æ›´æ–°è§’è‰²æ¨™èªï¼ˆå¸¶å‹•ç•«æ•ˆæœï¼‰
      const sloganElement = document.getElementById('characterSlogan');
      sloganElement.style.opacity = '0';
      sloganElement.style.transform = 'translateY(20px)';
      
      setTimeout(() => {
        sloganElement.textContent = slogan;
        sloganElement.style.opacity = '1';
        sloganElement.style.transform = 'translateY(0)';
        
        // èªéŸ³æœ—è®€åŠŸèƒ½å·²ç§»é™¤
        
        // è§¸ç™¼è§’è‰²å°è©±ç³»çµ±
        if (window.CharacterDialogue) {
          // æ›´æ–°ç•¶å‰è§’è‰²è¨­å®š
          window.CharacterDialogue.currentCharacter = voiceSettings.characterType || 'warrior';
          // é¡¯ç¤ºè§’è‰²æ­¡è¿å°è©±
          setTimeout(() => {
            window.CharacterDialogue.showWelcomeDialogue();
          }, 1000);
        }
      }, 200);
    }

    // è‡ªè¨‚é ­åƒé¸æ“‡
    function selectCustomAvatar(element) {
      // ç§»é™¤å…¶ä»–é ­åƒçš„é¸ä¸­ç‹€æ…‹
      document.querySelectorAll('.avatar-option').forEach(avatar => {
        avatar.classList.remove('selected');
      });
      
      // æ·»åŠ é¸ä¸­ç‹€æ…‹
      element.classList.add('selected');
      
      // é¡¯ç¤ºå½ˆçª—
      showCustomModal();
      
      // æ’­æ”¾éŸ³æ•ˆ
      playTypingSound();
    }

    // é¡¯ç¤ºè‡ªè¨‚è¨­å®šå½ˆçª—
    function showCustomModal() {
      const modal = document.getElementById('customModal');
      
      if (!modal) {
        console.error('âŒ æ‰¾ä¸åˆ°è‡ªè¨‚å½ˆçª—å…ƒç´ ');
        showCustomMessage('âŒ å½ˆçª—è¼‰å…¥å¤±æ•—', 'error');
        return;
      }
      
      console.log('ğŸ¨ é¡¯ç¤ºè‡ªè¨‚è§’è‰²å½ˆçª—');
      
      // è¼‰å…¥ç¾æœ‰çš„è‡ªè¨‚è³‡æ–™åˆ°å½ˆçª—
      loadModalData();
      
      // é¡¯ç¤ºå½ˆçª—
      modal.classList.add('show');
      
      // ç¦æ­¢èƒŒæ™¯æ»¾å‹•
      document.body.style.overflow = 'hidden';
      
      console.log('âœ… è‡ªè¨‚è§’è‰²å½ˆçª—å·²é¡¯ç¤º');
    }

    // é—œé–‰è‡ªè¨‚è¨­å®šå½ˆçª—
    function closeCustomModal() {
      console.log('ğŸ”’ é—œé–‰è‡ªè¨‚è§’è‰²å½ˆçª—...');
      
      const modal = document.getElementById('customModal');
      if (modal) {
        modal.classList.remove('show');
        console.log('âœ… å½ˆçª—å·²éš±è—');
      } else {
        console.error('âŒ æ‰¾ä¸åˆ°å½ˆçª—å…ƒç´ ');
      }
      
      // æ¢å¾©èƒŒæ™¯æ»¾å‹•
      document.body.style.overflow = 'auto';
      console.log('âœ… èƒŒæ™¯æ»¾å‹•å·²æ¢å¾©');
      
      // å¼·åˆ¶é‡æ–°å•Ÿç”¨æ»¾å‹•
      setTimeout(() => {
        document.body.style.overflow = 'auto';
        document.documentElement.style.overflow = 'auto';
        console.log('ğŸ”„ å¼·åˆ¶æ¢å¾©æ»¾å‹•å®Œæˆ');
      }, 100);
    }

    // è¼‰å…¥è³‡æ–™åˆ°å½ˆçª—
    function loadModalData() {
      console.log('ğŸ“‚ è¼‰å…¥å½ˆçª—è³‡æ–™...');
      
      const customUserData = localStorage.getItem('customUserData');
      if (customUserData) {
        try {
          const customData = JSON.parse(customUserData);
          console.log('ğŸ“‚ æ‰¾åˆ°è‡ªè¨‚è³‡æ–™:', customData);
          
          // æ›´æ–°å½ˆçª—ä¸­çš„è³‡æ–™
          const nameInput = document.getElementById('modalPlayerName');
          const sloganInput = document.getElementById('modalSlogan');
          const typeSelect = document.getElementById('modalCharacterType');
          const avatarImg = document.getElementById('modalAvatarImage');
          
          if (nameInput) nameInput.value = customData.name || '';
          if (sloganInput) sloganInput.value = customData.slogan || '';
          if (typeSelect) typeSelect.value = customData.characterType || 'warrior';
          
          if (customData.avatarDataUrl && avatarImg) {
            avatarImg.src = customData.avatarDataUrl;
          }
          
          console.log('âœ… å½ˆçª—è³‡æ–™è¼‰å…¥å®Œæˆ');
        } catch (e) {
          console.error('âŒ è¼‰å…¥å½ˆçª—è³‡æ–™å¤±æ•—:', e);
        }
      } else {
        console.log('ğŸ“‚ æ²’æœ‰æ‰¾åˆ°è‡ªè¨‚è³‡æ–™ï¼Œä½¿ç”¨é è¨­å€¼');
      }
    }

    // é‡ç½®å½ˆçª—é ­åƒ
    function resetModalAvatar() {
      document.getElementById('modalAvatarImage').src = 'img/avatars/avatar_TL.png';
      document.getElementById('modalPlayerName').value = '';
      document.getElementById('modalSlogan').value = '';
      document.getElementById('modalCharacterType').value = 'warrior';
      document.getElementById('modalAvatarUpload').value = '';
      
      showCustomMessage('ğŸ”„ å·²é‡ç½®å½ˆçª—è¨­å®š', 'info');
    }

    // å„²å­˜å½ˆçª—è‡ªè¨‚ä½¿ç”¨è€…
    function saveModalCustomUser() {
      console.log('ğŸ’¾ å„²å­˜è‡ªè¨‚è§’è‰²...');
      
      const modalName = document.getElementById('modalPlayerName')?.value?.trim() || '';
      const modalSlogan = document.getElementById('modalSlogan')?.value?.trim() || '';
      const modalType = document.getElementById('modalCharacterType')?.value || 'warrior';
      const modalAvatarSrc = document.getElementById('modalAvatarImage')?.src || '';
      
      console.log('ğŸ“ è§’è‰²è³‡æ–™:', { modalName, modalSlogan, modalType, modalAvatarSrc });
      
      if (!modalName) {
        showCustomMessage('âš ï¸ è«‹è¼¸å…¥è§’è‰²åç¨±', 'warning');
        return;
      }
      
      if (!modalSlogan) {
        showCustomMessage('âš ï¸ è«‹è¼¸å…¥è§’è‰²æ¨™èª', 'warning');
        return;
      }
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºé è¨­é ­åƒï¼ˆå…è¨±ä½¿ç”¨é è¨­é ­åƒï¼Œä½†è¦æ±‚è‡³å°‘è¼¸å…¥åç¨±å’Œæ¨™èªï¼‰
      if (modalAvatarSrc.includes('avatar_TL.png') && !modalName && !modalSlogan) {
        showCustomMessage('âš ï¸ è«‹è‡³å°‘è¼¸å…¥è§’è‰²åç¨±å’Œæ¨™èª', 'warning');
        return;
      }
      
      // å„²å­˜è‡ªè¨‚ä½¿ç”¨è€…è³‡æ–™
      const customUserData = {
        name: modalName,
        slogan: modalSlogan,
        characterType: modalType,
        avatarDataUrl: modalAvatarSrc,
        createdAt: new Date().toISOString()
      };
      
      localStorage.setItem('customUserData', JSON.stringify(customUserData));
      console.log('ğŸ’¾ è‡ªè¨‚è§’è‰²è³‡æ–™å·²å„²å­˜:', customUserData);
      
      // æ›´æ–°ä¸»ä»‹é¢çš„è§’è‰²è³‡è¨Š
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem.player) {
        LinkageSystem.player.setName(modalName);
      }
      
      const characterImage = document.getElementById('characterImage');
      const characterSlogan = document.getElementById('characterSlogan');
      
      if (characterImage) characterImage.src = modalAvatarSrc;
      if (characterSlogan) characterSlogan.textContent = modalSlogan;
      
      // æ›´æ–°è§’è‰²å°è©±ç³»çµ±
      if (window.CharacterDialogue) {
        window.CharacterDialogue.currentCharacter = modalType;
      }
      
      // é—œé–‰å½ˆçª—
      closeCustomModal();
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      showCustomMessage('ğŸ’¾ è‡ªè¨‚è§’è‰²å„²å­˜æˆåŠŸï¼', 'success');
      
      // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
      playTypingSound();
      
      console.log('âœ… è‡ªè¨‚è§’è‰²å„²å­˜å®Œæˆ');
    }

    // èªéŸ³æœ—è®€æ¨™èªåŠŸèƒ½å·²ç§»é™¤

    // éŸ³æ•ˆæ§åˆ¶
    let isSoundEnabled = true;
    const typingSound = document.getElementById('typingSound');

    function toggleAudio() {
      const button = document.querySelector('#audioControls button');
      isSoundEnabled = !isSoundEnabled;
      if (isSoundEnabled) {
        button.textContent = 'ğŸ”Š';
      } else {
        button.textContent = 'ğŸ”‡';
      }
    }

    // æ’­æ”¾æ‰“å­—éŸ³æ•ˆ
    function playTypingSound() {
      if (isSoundEnabled) {
        typingSound.currentTime = 0;
        typingSound.play().catch(error => {
          console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
        });
      }
    }

    // è‡ªè¨‚ä½¿ç”¨è€…åŠŸèƒ½ - å·²æ•´åˆåˆ°å½ˆçª—ç³»çµ±ä¸­
    // èˆŠçš„ç¨ç«‹å‡½æ•¸å·²ç§»é™¤ï¼Œç¾åœ¨çµ±ä¸€ä½¿ç”¨å½ˆçª—ç³»çµ±

    // é¡¯ç¤ºè‡ªè¨‚è¨Šæ¯
    function showCustomMessage(message, type = 'info') {
      // ç§»é™¤ç¾æœ‰çš„è¨Šæ¯
      const existingMessage = document.querySelector('.custom-message');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      // å‰µå»ºæ–°è¨Šæ¯
      const messageDiv = document.createElement('div');
      messageDiv.className = `custom-message custom-message-${type}`;
      messageDiv.textContent = message;
      
      // æ·»åŠ åˆ°body
      document.body.appendChild(messageDiv);
      
      // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 3000);
    }

    // ç·Šæ€¥ä¿®å¾©æ»¾å‹•åŠŸèƒ½
    function emergencyFixScroll() {
      console.log('ğŸš¨ åŸ·è¡Œç·Šæ€¥æ»¾å‹•ä¿®å¾©...');
      
      // é—œé–‰æ‰€æœ‰å½ˆçª—
      const modals = document.querySelectorAll('.modal-overlay');
      modals.forEach(modal => {
        modal.classList.remove('show');
      });
      
      // æ¢å¾©æ‰€æœ‰æ»¾å‹•
      document.body.style.overflow = 'auto';
      document.documentElement.style.overflow = 'auto';
      
      // ç§»é™¤æ‰€æœ‰å¯èƒ½é˜»æ­¢æ»¾å‹•çš„æ¨£å¼
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.left = '';
      document.body.style.right = '';
      document.body.style.bottom = '';
      
      console.log('âœ… ç·Šæ€¥ä¿®å¾©å®Œæˆ');
      showCustomMessage('ğŸ”„ æ»¾å‹•åŠŸèƒ½å·²ä¿®å¾©', 'success');
    }



    // é»æ“Šå½ˆçª—é ­åƒé è¦½è§¸ç™¼æª”æ¡ˆé¸æ“‡
    document.addEventListener('DOMContentLoaded', function() {
      const modalAvatarPreview = document.getElementById('modalAvatarPreview');
      if (modalAvatarPreview) {
        modalAvatarPreview.addEventListener('click', function() {
          console.log('ğŸ–±ï¸ é»æ“Šé ­åƒé è¦½å€åŸŸ');
          const modalAvatarUpload = document.getElementById('modalAvatarUpload');
          if (modalAvatarUpload) {
            modalAvatarUpload.click();
          } else {
            console.error('âŒ æ‰¾ä¸åˆ°é ­åƒä¸Šå‚³å…ƒç´ ');
            showCustomMessage('âŒ ä¸Šå‚³åŠŸèƒ½è¼‰å…¥å¤±æ•—', 'error');
          }
        });
        console.log('âœ… é ­åƒé è¦½é»æ“Šäº‹ä»¶å·²ç¶å®š');
      } else {
        console.error('âŒ æ‰¾ä¸åˆ°é ­åƒé è¦½å…ƒç´ ');
      }
    });

    // ä½¿ç”¨è€…åç¨±è™•ç†
    document.getElementById('playerName').addEventListener('input', function(e) {
      const name = e.target.value.trim();
      if (name) {
        LinkageSystem.player.setName(name);
        playTypingSound();
      }
    });

    // é é¢è¼‰å…¥æ™‚è¼‰å…¥å·²å„²å­˜çš„è³‡æ–™
    window.addEventListener('load', function() {
      // è¼‰å…¥ä½¿ç”¨è€…åç¨±å’Œé ­åƒ
      LinkageSystem.player.updateDisplay();
      
      // æª¢æŸ¥æ˜¯å¦æœ‰è‡ªè¨‚ä½¿ç”¨è€…è³‡æ–™
      const customUserData = localStorage.getItem('customUserData');
      if (customUserData) {
        try {
          const customData = JSON.parse(customUserData);
          // å¦‚æœæœ‰è‡ªè¨‚è³‡æ–™ï¼Œå„ªå…ˆä½¿ç”¨è‡ªè¨‚è³‡æ–™
          LinkageSystem.player.setName(customData.name);
          document.getElementById('characterImage').src = customData.avatarDataUrl;
          document.getElementById('characterSlogan').textContent = customData.slogan;
          
          if (window.CharacterDialogue) {
            window.CharacterDialogue.currentCharacter = customData.characterType;
          }
          
          // é¸ä¸­è‡ªè¨‚é ­åƒé¸é …
          const customAvatarOption = document.querySelector('.custom-avatar-option');
          if (customAvatarOption) {
            document.querySelectorAll('.avatar-option').forEach(avatar => {
              avatar.classList.remove('selected');
            });
            customAvatarOption.classList.add('selected');
          }
          
          console.log('ä½¿ç”¨è‡ªè¨‚ä½¿ç”¨è€…è³‡æ–™');
          return; // å¦‚æœæœ‰è‡ªè¨‚è³‡æ–™ï¼Œå°±ä¸è¼‰å…¥é è¨­é ­åƒ
        } catch (e) {
          console.log('è‡ªè¨‚ä½¿ç”¨è€…è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­è¨­å®š:', e);
        }
      }
      
      // è¼‰å…¥ä¿å­˜çš„é ­åƒé¸æ“‡ç‹€æ…‹
      const savedAvatar = localStorage.getItem('selectedAvatar');
      const savedSlogan = localStorage.getItem('selectedSlogan');
      const savedVoiceSettings = localStorage.getItem('selectedVoiceSettings');
      
      if (savedAvatar) {
        // æ‰¾åˆ°å°æ‡‰çš„é ­åƒé¸é …ä¸¦é¸ä¸­
        const avatarOptions = document.querySelectorAll('.avatar-option');
        let foundAvatar = false;
        
        avatarOptions.forEach(option => {
          const backgroundImage = option.style.backgroundImage;
          // æå–èƒŒæ™¯åœ–ç‰‡ä¸­çš„æª”æ¡ˆå
          const urlMatch = backgroundImage.match(/url\(['"]?([^'"]+)['"]?\)/);
          if (urlMatch) {
            const imageUrl = urlMatch[1];
            // æ¯”è¼ƒå®Œæ•´çš„URLè·¯å¾‘
            if (imageUrl === savedAvatar || imageUrl.endsWith(savedAvatar.split('/').pop())) {
              // ç§»é™¤å…¶ä»–é ­åƒçš„é¸ä¸­ç‹€æ…‹
              document.querySelectorAll('.avatar-option').forEach(avatar => {
                avatar.classList.remove('selected');
              });
              
              // æ·»åŠ é¸ä¸­ç‹€æ…‹
              option.classList.add('selected');
              foundAvatar = true;
              
              // æ¢å¾©ä¿å­˜çš„æ¨™èª
              if (savedSlogan) {
                document.getElementById('characterSlogan').textContent = savedSlogan;
              }
              
              // æ›´æ–°è§’è‰²é è¦½åœ–ç‰‡
              document.getElementById('characterImage').src = savedAvatar;
              
              // æ¢å¾©ä¿å­˜çš„èªéŸ³è¨­å®š
              if (savedVoiceSettings) {
                try {
                  const voiceSettings = JSON.parse(savedVoiceSettings);
                  // å¯ä»¥é¸æ“‡æ˜¯å¦åœ¨è¼‰å…¥æ™‚æ’­æ”¾èªéŸ³
                  // speakSlogan(savedSlogan, voiceSettings);
                  
                  // æ›´æ–°è§’è‰²å°è©±ç³»çµ±çš„ç•¶å‰è§’è‰²
                  if (window.CharacterDialogue) {
                    window.CharacterDialogue.currentCharacter = voiceSettings.characterType || 'warrior';
                  }
                } catch (e) {
                  console.log('èªéŸ³è¨­å®šæ¢å¾©å¤±æ•—:', e);
                }
              }
            }
          }
        });
        
        // å¦‚æœæ²’æœ‰æ‰¾åˆ°ä¿å­˜çš„é ­åƒï¼Œä½¿ç”¨é è¨­é ­åƒ
        if (!foundAvatar) {
          console.log('æœªæ‰¾åˆ°ä¿å­˜çš„é ­åƒï¼Œä½¿ç”¨é è¨­é ­åƒ');
          // æ¸…é™¤å¯èƒ½æå£çš„ä¿å­˜æ•¸æ“š
          localStorage.removeItem('selectedAvatar');
          localStorage.removeItem('selectedSlogan');
          localStorage.removeItem('selectedVoiceSettings');
        }
      }
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºé¦–æ¬¡è¨ªå•ï¼Œå¦‚æœæ˜¯å‰‡é¡¯ç¤ºè§’è‰²å°è©±
      const hasShownWelcome = localStorage.getItem('hasShownWelcomeDialogue');
      if (!hasShownWelcome && window.CharacterDialogue) {
        setTimeout(() => {
          window.CharacterDialogue.showWelcomeDialogue();
          localStorage.setItem('hasShownWelcomeDialogue', 'true');
        }, 2000);
      }
    });

    // èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶ç³»çµ±
    let backgroundMusic = null;
    let toggleMusicBtn = null;
    let isMusicPlaying = false;

    // åˆå§‹åŒ–èƒŒæ™¯éŸ³æ¨‚ç³»çµ±
    function initBackgroundMusic() {
      console.log('ğŸµ åˆå§‹åŒ–èƒŒæ™¯éŸ³æ¨‚ç³»çµ±...');
      
      backgroundMusic = document.getElementById('backgroundMusic');
      toggleMusicBtn = document.getElementById('toggleMusic');
      
      if (!backgroundMusic) {
        console.error('âŒ æ‰¾ä¸åˆ°èƒŒæ™¯éŸ³æ¨‚å…ƒç´ ');
        return;
      }
      
      if (!toggleMusicBtn) {
        console.error('âŒ æ‰¾ä¸åˆ°éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ•');
        return;
      }
      
      // è¨­å®šéŸ³æ¨‚å±¬æ€§
      backgroundMusic.volume = 0.3;
      backgroundMusic.loop = true;
      
      // é è¼‰å…¥éŸ³æ¨‚æª”æ¡ˆ
      backgroundMusic.load();
      
      // å„ªå…ˆä½¿ç”¨ SoundSystemï¼ˆå¦‚æœå¯ç”¨ï¼‰
      if (typeof SoundSystem !== 'undefined' && SoundSystem.bgm) {
        console.log('ğŸµ ä½¿ç”¨ SoundSystem ç®¡ç†èƒŒæ™¯éŸ³æ¨‚');
        // åˆå§‹åŒ– SoundSystem çš„èƒŒæ™¯éŸ³æ¨‚
        SoundSystem.bgm.initGlobalAudio();
        
        // å¾ SoundSystem ç²å–ç‹€æ…‹
        isMusicPlaying = SoundSystem.bgm.getPlayingState();
        console.log('ğŸ”— SoundSystem éŸ³æ¨‚ç‹€æ…‹:', isMusicPlaying);
      }
      // å…¶æ¬¡ä½¿ç”¨ LinkageSystem
      else if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
        isMusicPlaying = LinkageSystem.music.isPlaying();
        console.log('ğŸ”— LinkageSystem éŸ³æ¨‚ç‹€æ…‹:', isMusicPlaying);
      } 
      // æœ€å¾Œä½¿ç”¨ localStorage
      else {
        const musicState = localStorage.getItem('bgMusicState');
        isMusicPlaying = musicState === 'playing';
        console.log('ğŸ“¦ localStorage éŸ³æ¨‚ç‹€æ…‹:', isMusicPlaying);
      }
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      updateMusicButtonState();
      
      // å¦‚æœéŸ³æ¨‚æ‡‰è©²æ’­æ”¾ï¼Œå˜—è©¦æ’­æ”¾
      if (isMusicPlaying) {
        playBackgroundMusic();
      }
      
      console.log('âœ… èƒŒæ™¯éŸ³æ¨‚ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
    }

    // æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
    function playBackgroundMusic() {
      if (!backgroundMusic) return;
      
      // å„ªå…ˆä½¿ç”¨ SoundSystem
      if (typeof SoundSystem !== 'undefined' && SoundSystem.bgm) {
        SoundSystem.bgm.play();
        isMusicPlaying = true;
        updateMusicButtonState();
        console.log('ğŸµ é€é SoundSystem æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚');
        return;
      }
      
      // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ’­æ”¾æœ¬åœ°éŸ³æ¨‚å…ƒç´ 
      backgroundMusic.play().then(() => {
        isMusicPlaying = true;
        updateMusicButtonState();
        
        // åŒæ­¥åˆ° LinkageSystem
        if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
          LinkageSystem.music.setPlaying(true);
        } else {
          localStorage.setItem('bgMusicState', 'playing');
        }
        
        console.log('ğŸµ èƒŒæ™¯éŸ³æ¨‚é–‹å§‹æ’­æ”¾');
      }).catch(err => {
        console.error('âŒ èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å¤±æ•—:', err);
        isMusicPlaying = false;
        updateMusicButtonState();
      });
    }

    // æš«åœèƒŒæ™¯éŸ³æ¨‚
    function pauseBackgroundMusic() {
      if (!backgroundMusic) return;
      
      // å„ªå…ˆä½¿ç”¨ SoundSystem
      if (typeof SoundSystem !== 'undefined' && SoundSystem.bgm) {
        SoundSystem.bgm.pause();
        isMusicPlaying = false;
        updateMusicButtonState();
        console.log('ğŸ”‡ é€é SoundSystem æš«åœèƒŒæ™¯éŸ³æ¨‚');
        return;
      }
      
      // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥æš«åœæœ¬åœ°éŸ³æ¨‚å…ƒç´ 
      backgroundMusic.pause();
      isMusicPlaying = false;
      updateMusicButtonState();
      
      // åŒæ­¥åˆ° LinkageSystem
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
        LinkageSystem.music.setPlaying(false);
      } else {
        localStorage.setItem('bgMusicState', 'paused');
      }
      
      console.log('ğŸ”‡ èƒŒæ™¯éŸ³æ¨‚å·²æš«åœ');
    }

    // åˆ‡æ›èƒŒæ™¯éŸ³æ¨‚
    function toggleBackgroundMusic() {
      if (isMusicPlaying) {
        pauseBackgroundMusic();
      } else {
        playBackgroundMusic();
      }
    }

    // æ›´æ–°éŸ³æ¨‚æŒ‰éˆ•ç‹€æ…‹
    function updateMusicButtonState() {
      if (!toggleMusicBtn) return;
      
      if (isMusicPlaying) {
        toggleMusicBtn.style.background = 'rgba(0, 255, 255, 0.2)';
        toggleMusicBtn.innerHTML = '<span class="material-icons">ğŸ”Š</span>';
      } else {
        toggleMusicBtn.style.background = 'rgba(10, 20, 40, 0.85)';
        toggleMusicBtn.innerHTML = '<span class="material-icons">ğŸ”‡</span>';
      }
    }

    // ç›£è½éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ•é»æ“Š
    document.addEventListener('DOMContentLoaded', function() {
      // å»¶é²åˆå§‹åŒ–ï¼Œç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å·²è¼‰å…¥
      setTimeout(() => {
        initBackgroundMusic();
        
        // ç¶å®šæŒ‰éˆ•äº‹ä»¶
        const musicBtn = document.getElementById('toggleMusic');
        if (musicBtn) {
          musicBtn.addEventListener('click', toggleBackgroundMusic);
          console.log('ğŸµ éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
        }
        
        // æ·»åŠ ç”¨æˆ¶äº’å‹•è§¸ç™¼éŸ³æ¨‚æ’­æ”¾
        let hasUserInteracted = false;
        
        function handleUserInteraction() {
          if (!hasUserInteracted) {
            hasUserInteracted = true;
            console.log('ğŸ‘† ç”¨æˆ¶é¦–æ¬¡äº’å‹•ï¼Œå˜—è©¦æ’­æ”¾éŸ³æ¨‚');
            
            // å¦‚æœéŸ³æ¨‚æ‡‰è©²æ’­æ”¾ä½†é‚„æ²’é–‹å§‹ï¼Œç¾åœ¨å˜—è©¦æ’­æ”¾
            if (isMusicPlaying && backgroundMusic && backgroundMusic.paused) {
              playBackgroundMusic();
            }
            
            // ç§»é™¤äº‹ä»¶ç›£è½å™¨
            document.removeEventListener('click', handleUserInteraction);
            document.removeEventListener('keydown', handleUserInteraction);
            document.removeEventListener('touchstart', handleUserInteraction);
          }
        }
        
        // ç›£è½ç”¨æˆ¶äº’å‹•äº‹ä»¶
        document.addEventListener('click', handleUserInteraction);
        document.addEventListener('keydown', handleUserInteraction);
        document.addEventListener('touchstart', handleUserInteraction);
        
      }, 500);
    });

    // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼Œè™•ç†éŸ³æ¨‚æš«åœ/æ¢å¾©
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        // é é¢éš±è—æ™‚æš«åœéŸ³æ¨‚
        if (isMusicPlaying && backgroundMusic) {
          backgroundMusic.pause();
        }
      } else {
        // é é¢é¡¯ç¤ºæ™‚æ¢å¾©éŸ³æ¨‚
        if (isMusicPlaying && backgroundMusic && backgroundMusic.paused) {
          backgroundMusic.play().catch(err => {
            console.log('é é¢æ¢å¾©æ™‚éŸ³æ¨‚æ’­æ”¾å¤±æ•—:', err);
          });
        }
      }
    });

    // éŸ³æ¨‚ç³»çµ±è¨ºæ–·å‡½æ•¸
    function diagnoseMusicSystem() {
      console.log('ğŸ” === éŸ³æ¨‚ç³»çµ±è¨ºæ–· ===');
      console.log('èƒŒæ™¯éŸ³æ¨‚å…ƒç´ :', backgroundMusic);
      console.log('éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ•:', toggleMusicBtn);
      console.log('ç•¶å‰æ’­æ”¾ç‹€æ…‹:', isMusicPlaying);
      console.log('LinkageSystem å¯ç”¨:', typeof LinkageSystem !== 'undefined');
      console.log('SoundSystem å¯ç”¨:', typeof SoundSystem !== 'undefined');
      
      if (backgroundMusic) {
        console.log('éŸ³æ¨‚æª”æ¡ˆè·¯å¾‘:', backgroundMusic.src);
        console.log('éŸ³æ¨‚éŸ³é‡:', backgroundMusic.volume);
        console.log('éŸ³æ¨‚æ˜¯å¦å¾ªç’°:', backgroundMusic.loop);
        console.log('éŸ³æ¨‚æ˜¯å¦æš«åœ:', backgroundMusic.paused);
        console.log('éŸ³æ¨‚ç•¶å‰æ™‚é–“:', backgroundMusic.currentTime);
      }
      
      if (typeof LinkageSystem !== 'undefined' && LinkageSystem.music) {
        console.log('LinkageSystem éŸ³æ¨‚ç‹€æ…‹:', LinkageSystem.music.isPlaying());
        console.log('LinkageSystem éŸ³æ¨‚éŸ³é‡:', LinkageSystem.music.getVolume());
      }
      
      if (typeof SoundSystem !== 'undefined' && SoundSystem.bgm) {
        console.log('SoundSystem éŸ³æ¨‚ç‹€æ…‹:', SoundSystem.bgm.getPlayingState());
        console.log('SoundSystem éŸ³æ¨‚éŸ³é‡:', SoundSystem.bgm.getVolume());
      }
      
      const musicState = localStorage.getItem('bgMusicState');
      console.log('localStorage éŸ³æ¨‚ç‹€æ…‹:', musicState);
      
      console.log('ğŸ” === è¨ºæ–·å®Œæˆ ===');
    }

    // å¼·åˆ¶é‡æ–°åˆå§‹åŒ–éŸ³æ¨‚ç³»çµ±
    function reinitMusicSystem() {
      console.log('ğŸ”„ å¼·åˆ¶é‡æ–°åˆå§‹åŒ–éŸ³æ¨‚ç³»çµ±...');
      
      // é‡ç½®ç‹€æ…‹
      isMusicPlaying = false;
      backgroundMusic = null;
      toggleMusicBtn = null;
      
      // é‡æ–°åˆå§‹åŒ–
      setTimeout(() => {
        initBackgroundMusic();
        console.log('âœ… éŸ³æ¨‚ç³»çµ±é‡æ–°åˆå§‹åŒ–å®Œæˆ');
      }, 100);
    }

    // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œè¨ºæ–·
    window.addEventListener('load', function() {
      setTimeout(diagnoseMusicSystem, 2000);
    });

    // è™•ç†å½ˆçª—é ­åƒä¸Šå‚³
    document.addEventListener('DOMContentLoaded', function() {
      const modalAvatarUpload = document.getElementById('modalAvatarUpload');
      if (modalAvatarUpload) {
        modalAvatarUpload.addEventListener('change', function(e) {
          console.log('ğŸ“ è™•ç†é ­åƒä¸Šå‚³...');
          const file = e.target.files[0];
          if (file) {
            console.log('ğŸ“ é¸æ“‡çš„æª”æ¡ˆ:', file.name, file.size, 'bytes');
            const reader = new FileReader();
            reader.onload = function(event) {
              const modalAvatarImage = document.getElementById('modalAvatarImage');
              if (modalAvatarImage) {
                modalAvatarImage.src = event.target.result;
                console.log('âœ… é ­åƒä¸Šå‚³æˆåŠŸ');
                showCustomMessage('âœ… é ­åƒä¸Šå‚³æˆåŠŸï¼', 'success');
              } else {
                console.error('âŒ æ‰¾ä¸åˆ°é ­åƒé è¦½å…ƒç´ ');
                showCustomMessage('âŒ é ­åƒé è¦½è¼‰å…¥å¤±æ•—', 'error');
              }
            };
            reader.onerror = function() {
              console.error('âŒ æª”æ¡ˆè®€å–å¤±æ•—');
              showCustomMessage('âŒ æª”æ¡ˆè®€å–å¤±æ•—', 'error');
            };
            reader.readAsDataURL(file);
          } else {
            console.log('ğŸ“ æ²’æœ‰é¸æ“‡æª”æ¡ˆ');
          }
        });
        console.log('âœ… é ­åƒä¸Šå‚³äº‹ä»¶ç›£è½å™¨å·²ç¶å®š');
      } else {
        console.error('âŒ æ‰¾ä¸åˆ°é ­åƒä¸Šå‚³å…ƒç´ ');
      }
    });
  </script>
</body>
</html>
