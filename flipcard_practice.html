<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>翻牌單字練習</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="responsive_enhanced.css">
    <style>
        /* 防止水平滾動 */
        html {
            overflow-x: hidden;
        }
        
        /* 確保所有元素都在視窗範圍內 */
        * {
            box-sizing: border-box;
            max-width: 100%;
        }
        
        body { 
            font-family: 'Orbitron', sans-serif; 
            background: #f0f0f0; 
            text-align: center;
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
        }
        .container {
            font-family: 'Orbitron', sans-serif;
            max-width: 1200px;
            width: 95%;
            margin: 40px auto;
            padding: 30px;
            background: rgba(10, 20, 40, 0.7);
            border-radius: 20px;
            box-shadow: 0 0 32px #00ffff44, 0 0 80px #a259ff22 inset;
            border: 2px solid #00ffff;
            backdrop-filter: blur(8px);
            text-align: center;
        }
        .flip-card {
            background-color: transparent;
            width: 300px;
            height: 180px;
            perspective: 1000px;
            margin: 30px auto;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        .flip-card-back {
            transform: rotateY(180deg);
            color: #333;
        }
        button {
            padding: 10px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            background: #4a90e2;
            color: #fff;
            cursor: pointer;
            margin-top: 20px;
        }
        button:active { background: #357ab8; }
        #levelSelectArea {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        .level-card {
            width: 120px;
            height: 180px;
            background: #181a22;
            border-radius: 20px;
            box-shadow: 0 0 28px #00ffffcc, 0 0 60px #a259ff44 inset;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
            position: relative;
            color: #00ffff;
            margin: 0;
            border: 2px solid #00ffff;
            overflow: hidden;
            padding: 0 6px;
        }
        .level-card .level-en {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            color: #00ffff;
            font-weight: bold;
            text-shadow: 0 0 10px #00ffff, 0 0 18px #00ffff99;
            letter-spacing: 1px;
            margin-top: 18px;
            margin-bottom: 0.3em;
            text-align: center;
            text-transform: uppercase;
        }
        .level-card .level-desc {
            font-size: 0.85em;
            color: #b6aaff;
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', 'PingFang TC', 'Heiti TC', sans-serif;
            font-weight: 500;
            margin: 0.3em 0 0.3em 0;
            letter-spacing: 1px;
            text-align: center;
            line-height: 1.4;
            min-height: 2.2em;
        }
        .level-card .level-status {
            font-size: 0.9em;
            color: #ffd700;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            margin-top: 0.7em;
            margin-bottom: 0.2em;
            letter-spacing: 1px;
            text-align: center;
            text-shadow: 0 0 6px #ffd700, 0 0 12px #fff2;
        }
        .level-card.completed {
            background: linear-gradient(135deg, #181a22 60%, #e0e7ef 100%);
            box-shadow: 0 0 36px #00ffff, 0 0 80px #a259ff99 inset, 0 0 24px #fff8;
            border: 2px solid #a259ff;
            animation: cardGlow 1.2s infinite alternate;
        }
        .level-card.completed::after {
            content: '\2714';
            position: absolute;
            top: 10px;
            right: 12px;
            font-size: 1.5em;
            color: #a259ff;
            text-shadow: 0 0 8px #fff, 0 0 16px #a259ff99;
            z-index: 2;
        }
        .level-card .level-progress-bar, .level-card .level-progress-label, .level-card .level-progress-zh {
            display: none !important;
        }
        @keyframes cardGlow {
            0% { box-shadow: 0 0 36px #00ffff, 0 0 80px #a259ff99 inset, 0 0 24px #fff8; }
            100% { box-shadow: 0 0 48px #00ffffcc, 0 0 120px #a259ffcc inset, 0 0 36px #fff; }
        }
        .level-card:hover {
            transform: scale(1.07);
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            background: #e6f0fa;
        }
        .match-card-front {
            background: url('https://th.bing.com/th/id/OIP.aQ__NwCVOOJiBqSM_FonkAHaKC?r=0&rs=1&pid=ImgDetMain&cb=idpwebpc2') center/cover no-repeat, rgba(10, 20, 40, 0.9);
            color: #00ffff;
            border: 2px solid #00ffff;
            box-shadow: 0 0 16px #00ffff44, 0 0 32px #a259ff22 inset;
            font-size: 2.2em;
            font-weight: bold;
            text-shadow: 0 0 8px #000, 0 0 16px #00ffff;
        }
        .back-home-btn {
            font-family: 'Orbitron', sans-serif;
            position: absolute;
            top: 24px;
            right: 32px;
            background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
            color: #000;
            border: none;
            border-radius: 12px;
            padding: 10px 22px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 0 16px #00ffff, 0 0 24px #a259ff99;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 100;
        }
        .back-home-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
        }

        /* 響應式設計 */
        /* 大螢幕優化 */
        @media (min-width: 1200px) {
            .container {
                max-width: 1400px;
                padding: 40px;
            }
            
            #levelSelectArea {
                gap: 30px;
            }
            
            .level-card {
                width: 140px;
                height: 200px;
            }
        }

        /* 平板適配 */
        @media (max-width: 1024px) {
            .container {
                width: 98%;
                padding: 25px;
                margin: 30px auto;
            }
            
            #levelSelectArea {
                gap: 18px;
            }
            
            .level-card {
                width: 110px;
                height: 170px;
                padding: 10px;
            }
            
            .level-card .level-en {
                font-size: 1.1rem;
            }
            
            .level-card .level-desc {
                font-size: 0.8rem;
            }
            
            .back-home-btn {
                top: 20px;
                right: 25px;
                padding: 8px 18px;
                font-size: 1rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                width: 100%;
                padding: 20px;
                margin: 20px auto;
            }
            
            h1 {
                font-size: 1.8rem;
                margin-bottom: 20px;
            }
            
            #levelSelectArea {
                gap: 15px;
                margin: 25px 0;
            }
            
            .level-card {
                width: 100px;
                height: 150px;
                padding: 8px;
            }
            
            .level-card .level-en {
                font-size: 1rem;
                margin-top: 12px;
            }
            
            .level-card .level-desc {
                font-size: 0.75rem;
                line-height: 1.3;
            }
            
            .level-card .level-status {
                font-size: 0.8rem;
                margin-top: 0.5em;
            }
            
            .flip-card {
                width: 250px;
                height: 150px;
                margin: 25px auto;
            }
            
            .flip-card-front, .flip-card-back {
                font-size: 1.6em;
            }
            
            button {
                padding: 8px 24px;
                font-size: 1.1em;
            }
            
            .back-home-btn {
                top: 15px;
                right: 20px;
                padding: 6px 15px;
                font-size: 0.9rem;
            }
        }

        /* 手機適配 */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
                margin: 15px auto;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            #levelSelectArea {
                gap: 12px;
                margin: 20px 0;
            }
            
            .level-card {
                width: 90px;
                height: 135px;
                padding: 6px;
            }
            
            .level-card .level-en {
                font-size: 0.9rem;
                margin-top: 10px;
            }
            
            .level-card .level-desc {
                font-size: 0.7rem;
                line-height: 1.2;
                min-height: 2em;
            }
            
            .level-card .level-status {
                font-size: 0.75rem;
            }
            
            .flip-card {
                width: 200px;
                height: 120px;
                margin: 20px auto;
            }
            
            .flip-card-front, .flip-card-back {
                font-size: 1.3em;
            }
            
            button {
                padding: 6px 20px;
                font-size: 1rem;
            }
            
            .back-home-btn {
                top: 12px;
                right: 15px;
                padding: 5px 12px;
                font-size: 0.8rem;
            }
        }

        /* 小螢幕手機 */
        @media (max-width: 480px) {
            .container {
                padding: 12px;
                margin: 10px auto;
            }
            
            h1 {
                font-size: 1.4rem;
            }
            
            #levelSelectArea {
                gap: 10px;
                margin: 18px 0;
            }
            
            .level-card {
                width: 80px;
                height: 120px;
                padding: 5px;
            }
            
            .level-card .level-en {
                font-size: 0.8rem;
                margin-top: 8px;
            }
            
            .level-card .level-desc {
                font-size: 0.65rem;
                line-height: 1.1;
                min-height: 1.8em;
            }
            
            .level-card .level-status {
                font-size: 0.7rem;
                margin-top: 0.3em;
            }
            
            .flip-card {
                width: 180px;
                height: 110px;
                margin: 15px auto;
            }
            
            .flip-card-front, .flip-card-back {
                font-size: 1.1em;
            }
            
            button {
                padding: 5px 16px;
                font-size: 0.9rem;
            }
            
            .back-home-btn {
                top: 10px;
                right: 12px;
                padding: 4px 10px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-home-btn" onclick="location.href='atlas.html'">← 返回首頁</button>
        <h1>🌌 單字配對記憶遊戲</h1>
        <div id="levelSelectArea"></div>
        <div id="reviewArea" style="display:none;">
            <h2>本關單字複習</h2>
            <div id="reviewWordList" style="display:flex;flex-wrap:wrap;justify-content:center;gap:16px 32px;margin:24px 0 18px 0;" class="review-word-list"></div>
            <button class="btn" id="startGameBtn">開始遊戲</button>
            <button class="btn" id="skipLevelBtn1">我已經會了，跳到下一關</button>
        </div>
        <div id="matchGameArea" style="display:none;">
            <div class="grid" id="matchGridWrap">
                <div id="matchGrid"></div>
            </div>
            <button class="btn" id="backToMenuBtn" style="display:none;">返回選單</button>
            <button class="btn" id="skipLevelBtn2">我已經會了，跳到下一關</button>
        </div>
    </div>
    <audio id="successSound" src="sound/correct.mp3" preload="auto"></audio>
    <audio id="failSound" src="sound/wrong.mp3" preload="auto"></audio>
    <script src="js/sound.js"></script>
    <script src="js/vocabData.js"></script>
    <script>
    let vocabList = [];
    let currentGroup = '';
    let completedGroups = JSON.parse(localStorage.getItem('flipcard_completedGroups') || '{}');
    let currentLevel = 0; // 關卡編號 0~3
    let levelWordSets = [];
    const LEVELS_PER_GROUP = 4;
    const WORDS_PER_LEVEL = 5;
    let allLevelWords = [];
    let matchPairs = [];
    let matchCards = [];
    let firstCard = null;
    let lockBoard = false;
    let matchedCount = 0;
    // 頁面載入時預先載入語音
    let voicesLoaded = false;
    let enVoice = null;
    // 新增：支援從網址參數 book=書名 直接載入單字本
    const urlBookName = new URLSearchParams(location.search).get('book');
    let customBookVocab = null;
    if (urlBookName) {
      // 讀取 localStorage 的 book_書名
      try {
        const arr = JSON.parse(localStorage.getItem('book_' + urlBookName) || '[]');
        // 轉換成 {en, zh} 格式
        if (Array.isArray(arr) && arr.length > 0) {
          customBookVocab = arr.map(v => ({ en: v.word, zh: v.meaning }));
        }
      } catch {}
    }

    // 新增：更穩定可靠的語音初始化函數
    function initializeSpeechSynthesis() {
      // 確保 SoundSystem 初始化，並選擇最佳語音
      if (typeof SoundSystem !== 'undefined' && !SoundSystem.speech.isInitialized) {
        SoundSystem.speech.init();
      }
      
      // 如果語音已經載入，就直接使用
      if (speechSynthesis.getVoices().length > 0) {
        if (typeof SoundSystem !== 'undefined') {
            SoundSystem.speech.selectBestVoice();
        }
        voicesLoaded = true;
      } else {
        // 否則，設定事件監聽器，並在1秒後再次檢查以防萬一
        speechSynthesis.onvoiceschanged = () => {
          if (typeof SoundSystem !== 'undefined') {
            SoundSystem.speech.selectBestVoice();
          }
          voicesLoaded = true;
        };
        setTimeout(() => {
            if (speechSynthesis.getVoices().length > 0 && !voicesLoaded) {
                speechSynthesis.onvoiceschanged();
            }
        }, 1000);
      }
    }

    function getGroupNames() {
        return Object.keys(vocabData);
    }

    // 星座英文對應中文
    const groupNameMap = {
      aries: '牡羊座',
      taurus: '金牛座',
      gemini: '雙子座',
      cancer: '巨蟹座',
      leo: '獅子座',
      virgo: '處女座',
      libra: '天秤座',
      scorpio: '天蠍座',
      sagittarius: '射手座',
      capricorn: '摩羯座',
      aquarius: '水瓶座',
      pisces: '雙魚座',
      phoenix: '鳳凰座',
      draco: '天龍座',
      orion: '獵戶座',
      cygnus: '天鵝座',
      pegasus: '飛馬座',
      cassiopeia: '仙后座',
      scorpius: '天蠍座',
      vela: '船帆座',
      cassiopeia: '仙后座'
    };

    // 星座描述
    const groupDescMap = {
      aries: '牡羊座，象徵勇氣與冒險。',
      taurus: '金牛座，代表堅毅與穩重。',
      gemini: '雙子座，靈活多變、善於溝通。',
      cancer: '巨蟹座，溫柔體貼、重視家庭。',
      leo: '獅子座，熱情自信、領導力強。',
      virgo: '處女座，細心謹慎、追求完美。',
      libra: '天秤座，公平和諧、重視美感。',
      scorpio: '天蠍座，神秘深沉、意志堅定。',
      sagittarius: '射手座，樂觀開朗、熱愛自由。',
      capricorn: '摩羯座，務實努力、目標明確。',
      aquarius: '水瓶座，創新獨立、思想前衛。',
      pisces: '雙魚座，感性浪漫、富有同情心。',
      phoenix: '鳳凰座，重生與希望的象徵。',
      draco: '天龍座，神秘與守護的力量。',
      orion: '獵戶座，勇敢的獵人傳說。',
      cygnus: '天鵝座，純潔與優雅的象徵。',
      pegasus: '飛馬座，夢想與自由的化身。',
      cassiopeia: '仙后座，優雅與自信的女王。',
      scorpius: '天蠍座，神秘深沉、意志堅定。',
      vela: '船帆座，啟航與冒險的開始。'
    };

    function showLevelSelect() {
        // 如果有自訂單字本，直接進入練習，不顯示群組選單
        if (customBookVocab) {
            // 直接分 4 關，每關 5 個單字
            let allWords = customBookVocab.slice();
            shuffleArray(allWords);
            allLevelWords = allWords.slice(0, Math.min(LEVELS_PER_GROUP * WORDS_PER_LEVEL, allWords.length));
            levelWordSets = [];
            for (let i = 0; i < LEVELS_PER_GROUP; i++) {
                levelWordSets.push(allLevelWords.slice(i*WORDS_PER_LEVEL, (i+1)*WORDS_PER_LEVEL));
            }
            currentLevel = 0;
            showReviewArea();
            // 隱藏群組選單
            document.getElementById('levelSelectArea').style.display = 'none';
            return;
        }
        // 否則顯示原本的群組選單
        const area = document.getElementById('levelSelectArea');
        area.innerHTML = '';
        getGroupNames().forEach(group => {
            let key = group + '_ALL';
            let completed = completedGroups[key];
            if (completed) {
              let passed = JSON.parse(localStorage.getItem('passed_flipcard')||'[]');
              if (!passed.includes(group)) {
                passed.push(group);
                localStorage.setItem('passed_flipcard', JSON.stringify(passed));
              }
            }
            const card = document.createElement('div');
            card.className = 'level-card' + (completed ? ' completed' : '');
            const en = group.toUpperCase();
            const desc = groupDescMap[group] || '';
            let status = completed ? '已解鎖' : '';
            card.innerHTML = `
                <div class="level-en">${en}</div>
                <div class="level-desc">${desc}</div>
                <div class="level-status">${status}</div>
            `;
            card.onclick = function() {
                currentGroup = group;
                // 取出全部單字，隨機分4關
                let allWords = (vocabData[group] || []).slice();
                shuffleArray(allWords);
                allLevelWords = allWords.slice(0, Math.min(LEVELS_PER_GROUP * WORDS_PER_LEVEL, allWords.length));
                levelWordSets = [];
                for (let i = 0; i < LEVELS_PER_GROUP; i++) {
                    levelWordSets.push(allLevelWords.slice(i*WORDS_PER_LEVEL, (i+1)*WORDS_PER_LEVEL));
                }
                currentLevel = 0;
                showReviewArea(); // 先顯示複習區
            };
            area.appendChild(card);
        });
        area.style.display = '';
        document.getElementById('matchGameArea').style.display = 'none';
        document.getElementById('reviewArea').style.display = 'none';
    }

    function showReviewArea() {
        // 取得本關單字
        let pairs = (levelWordSets && levelWordSets[currentLevel]) ? levelWordSets[currentLevel].slice() : [];
        const reviewArea = document.getElementById('reviewArea');
        const list = document.getElementById('reviewWordList');
        list.innerHTML = '';
        pairs.forEach(pair => {
            const item = document.createElement('div');
            item.style.display = 'flex';
            item.style.flexDirection = 'column';
            item.style.alignItems = 'center';
            item.style.justifyContent = 'center';
            item.style.background = 'rgba(255,255,255,0.92)';
            item.style.color = '#222';
            item.style.borderRadius = '10px';
            item.style.padding = '12px 18px';
            item.style.fontSize = '1.2em';
            item.style.boxShadow = '0 2px 8px #00ffff44';
            item.style.cursor = 'pointer';
            item.style.minWidth = '90px';
            item.innerHTML = `<div style='font-weight:bold;font-size:1.1em;'>${pair.zh}</div><div style='color:#00aaff;margin-top:4px;'>${pair.en}</div>`;
            item.title = '點擊發音';
            item.onclick = function() { speakWord(pair.en); };
            list.appendChild(item);
        });
        document.getElementById('levelSelectArea').style.display = 'none';
        document.getElementById('matchGameArea').style.display = 'none';
        reviewArea.style.display = '';
    }

    function startMatchGame() {
        // 取本關單字
        let pairs = (levelWordSets && levelWordSets[currentLevel]) ? levelWordSets[currentLevel].slice() : [];
        matchPairs = pairs;
        setupMatchGrid();
        document.getElementById('levelSelectArea').style.display = 'none';
        document.getElementById('matchGameArea').style.display = '';
        document.getElementById('backToMenuBtn').style.display = 'none';
        showLevelProgress();
        // 進入時全部翻開10秒，並顯示倒數
        let previewSec = 10;
        showPreviewCountdown(previewSec);
        setTimeout(() => {
            document.querySelectorAll('.match-card').forEach(card => card.classList.add('flipped'));
            lockBoard = true;
            let left = previewSec;
            let timer = setInterval(() => {
                left--;
                showPreviewCountdown(left);
                if (left <= 0) {
                    clearInterval(timer);
                    document.querySelectorAll('.match-card').forEach(card => card.classList.remove('flipped'));
                    lockBoard = false;
                    showPreviewCountdown(0, true);
                }
            }, 1000);
        }, 100);
    }

    function setupMatchGrid() {
        const grid = document.getElementById('matchGrid');
        grid.innerHTML = '';
        firstCard = null;
        lockBoard = false;
        matchedCount = 0;
        // 產生英文卡片與中文卡片
        let cards = [];
        matchPairs.forEach((pair, idx) => {
            cards.push({ type: 'en', value: pair.en, pairId: idx });
            cards.push({ type: 'zh', value: pair.zh, pairId: idx });
        });
        shuffleArray(cards);
        matchCards = cards;
        // 建立卡片元素
        cards.forEach((card, i) => {
            const div = document.createElement('div');
            div.className = 'match-card';
            div.dataset.type = card.type;
            div.dataset.value = card.value;
            div.dataset.pairId = card.pairId;
            // 3D翻牌結構
            const inner = document.createElement('div');
            inner.className = 'match-card-inner';
            const front = document.createElement('div');
            front.className = 'match-card-front';
            front.innerHTML = '<span>?</span>';
            const back = document.createElement('div');
            back.className = 'match-card-back';
            const len = (card.value || '').length;
            back.innerHTML = `<span style=\"--len:${len}\">${card.value}</span>`;
            inner.appendChild(front);
            inner.appendChild(back);
            div.appendChild(inner);
            div.onclick = function() { onCardClick(div, card); };
            grid.appendChild(div);
        });
        // 動態調整字體大小，確保內容不超出卡片
        setTimeout(() => {
            grid.querySelectorAll('.match-card-back span').forEach(span => {
                fitTextToCardOneLine(span, span.parentElement);
            });
        }, 0);
    }

    function onCardClick(div, card) {
        if (lockBoard || div.classList.contains('matched')) return;
        // 點擊英文卡牌時發音（不論是否已翻開）
        if (card.type === 'en') {
            speakWord(card.value);
        }
        if (div.classList.contains('flipped')) return;
        div.classList.add('flipped');
        if (!firstCard) {
            firstCard = { div, card };
        } else {
            lockBoard = true;
            setTimeout(() => {
                if (firstCard.card.pairId === card.pairId && firstCard.card.type !== card.type) {
                    // 配對成功
                    document.getElementById('successSound').currentTime = 0;
                    document.getElementById('successSound').play();
                    div.classList.add('matched');
                    firstCard.div.classList.add('matched');
                    matchedCount++;
                    if (matchedCount === matchPairs.length) {
                        // 進入下一關或全部完成
                        if (currentLevel < LEVELS_PER_GROUP - 1) {
                            currentLevel++;
                            matchedCount = 0;
                            setTimeout(() => {
                                showReviewArea();
                            }, 600);
                        } else {
                            // 標記本組全部完成
                            let key = currentGroup + '_ALL';
                            completedGroups[key] = true;
                            localStorage.setItem('flipcard_completedGroups', JSON.stringify(completedGroups));
                            showCompleteModal();
                        }
                    }
                } else {
                    // 配對失敗
                    document.getElementById('failSound').currentTime = 0;
                    document.getElementById('failSound').play();
                    div.classList.remove('flipped');
                    firstCard.div.classList.remove('flipped');
                }
                firstCard = null;
                lockBoard = false;
            }, 800);
        }
    }

    // 自動發音函式
    function speakWord(word) {
        if (!window.speechSynthesis) return;
        // 使用新的發音系統
        if (typeof SoundSystem !== 'undefined' && SoundSystem.speech) {
            SoundSystem.speech.speakWord(word);
        } else {
            // 備用方案：如果 SoundSystem 不存在，直接使用瀏覽器 API
            const utter = new SpeechSynthesisUtterance(word);
            utter.lang = 'en-US';
            window.speechSynthesis.speak(utter);
        }
    }

    document.getElementById('startGameBtn').onclick = function() {
        document.getElementById('reviewArea').style.display = 'none';
        startMatchGame();
    };

    document.getElementById('backToMenuBtn').onclick = function() {
        showLevelSelect();
    };

    // 新增：跳關邏輯
    function skipLevel() {
        if (currentLevel < LEVELS_PER_GROUP - 1) {
            currentLevel++;
            matchedCount = 0;
            showReviewArea();
        } else {
            // 標記本組全部完成
            let key = currentGroup + '_ALL';
            completedGroups[key] = true;
            localStorage.setItem('flipcard_completedGroups', JSON.stringify(completedGroups));
            showCompleteModal();
        }
    }
    // 綁定按鈕事件（需等 DOM 載入）
    setTimeout(() => {
        let btn1 = document.getElementById('skipLevelBtn1');
        if (btn1) btn1.onclick = skipLevel;
        let btn2 = document.getElementById('skipLevelBtn2');
        if (btn2) btn2.onclick = skipLevel;
    }, 0);

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // 顯示看牌倒數
    function showPreviewCountdown(sec, hide) {
        let el = document.getElementById('previewCountdown');
        if (!el && !hide) {
            el = document.createElement('div');
            el.id = 'previewCountdown';
            el.style.position = 'fixed';
            el.style.top = '30px';
            el.style.left = '50%';
            el.style.transform = 'translateX(-50%)';
            el.style.background = 'rgba(10,20,40,0.92)';
            el.style.color = '#ffd700';
            el.style.fontSize = '2.2em';
            el.style.fontWeight = 'bold';
            el.style.padding = '18px 38px';
            el.style.borderRadius = '18px';
            el.style.boxShadow = '0 0 32px #00ffff, 0 0 48px #a259ff99';
            el.style.zIndex = 9999;
            document.body.appendChild(el);
        }
        if (el) {
            if (hide || sec <= 0) {
                el.remove();
            } else {
                el.innerHTML = '記憶時間 <span style="color:#00ffff">' + sec + '</span> 秒';
            }
        }
    }

    // 顯示宇宙風格進度條
    function showLevelProgress() {
        let el = document.getElementById('levelProgressBar');
        if (!el) {
            el = document.createElement('div');
            el.id = 'levelProgressBar';
            el.style.margin = '0 auto 18px auto';
            el.style.maxWidth = '400px';
            el.style.display = 'flex';
            el.style.justifyContent = 'center';
            el.style.alignItems = 'center';
            el.style.gap = '12px';
            el.style.fontFamily = "Orbitron, 'Roboto Mono', Arial, sans-serif";
            el.style.fontWeight = 'bold';
            el.style.fontSize = '1.3em';
            el.style.letterSpacing = '2px';
            el.style.color = '#ffd700';
            el.style.textShadow = '0 0 8px #00ffff, 0 0 16px #a259ff';
            document.querySelector('.container').insertBefore(el, document.getElementById('matchGameArea'));
        }
        el.innerHTML = `<span style="color:#00ffff;">第 ${currentLevel+1} 關</span> / 共4關`;
    }

    // 動態調整字體大小直到內容不超出卡片
    function fitTextToCard(span, cardDiv) {
        let maxFont = 2.2;
        let minFont = 0.7;
        let font = maxFont;
        span.style.fontSize = font + 'em';
        const maxHeight = cardDiv.clientHeight - 16;
        const maxWidth = cardDiv.clientWidth - 16;
        while ((span.scrollHeight > maxHeight || span.scrollWidth > maxWidth) && font > minFont) {
            font -= 0.08;
            span.style.fontSize = font + 'em';
        }
    }

    // 英文單字：動態縮小字體直到單行內不超出卡片寬度
    function fitTextToCardOneLine(span, cardDiv) {
        let maxFont = 1.1;
        let minFont = 0.5;
        let font = maxFont;
        span.style.fontSize = font + 'em';
        span.style.whiteSpace = 'nowrap';
        const maxWidth = cardDiv.clientWidth - 16;
        while ((span.scrollWidth > maxWidth) && font > minFont) {
            font -= 0.04;
            span.style.fontSize = font + 'em';
        }
    }

    // 完成全部關卡時的美觀提示
    function showCompleteModal() {
        // 若已存在則移除
        let old = document.getElementById('completeModal');
        if (old) old.remove();
        const modal = document.createElement('div');
        modal.id = 'completeModal';
        modal.innerHTML = `
            <div class="complete-modal-content">
                <div class="complete-icon">🎉</div>
                <div class="complete-title">恭喜完成全部關卡！</div>
                <div class="complete-desc">你已完成本組所有單字配對！</div>
                <button class="btn" id="backToMenuBtn2">返回選單</button>
            </div>
        `;
        Object.assign(modal.style, {
            position: 'fixed', left: 0, top: 0, width: '100vw', height: '100vh', zIndex: 9999,
            background: 'rgba(10,20,40,0.92)', display: 'flex', alignItems: 'center', justifyContent: 'center',
            animation: 'fadeIn 0.5s'
        });
        document.body.appendChild(modal);
        document.getElementById('backToMenuBtn2').onclick = function() {
            modal.remove();
            showLevelSelect();
        };
        // 移除進度條
        let el = document.getElementById('levelProgressBar');
        if (el) el.remove();
        // 動畫樣式
        const style = document.createElement('style');
        style.textContent = `
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #completeModal .complete-modal-content {
            background: linear-gradient(135deg,#00ffff 0%,#a259ff 100%);
            border-radius: 24px;
            box-shadow: 0 0 48px #00ffff99, 0 0 80px #a259ff44 inset;
            padding: 48px 36px 36px 36px;
            text-align: center;
            color: #fff;
            min-width: 320px;
            max-width: 90vw;
            animation: popIn 0.7s cubic-bezier(.4,2,.6,1);
        }
        #completeModal .complete-icon {
            font-size: 3.5em;
            margin-bottom: 18px;
            animation: tada 1.2s;
        }
        #completeModal .complete-title {
            font-size: 2.1em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 16px #fff, 0 0 32px #a259ff;
        }
        #completeModal .complete-desc {
            font-size: 1.2em;
            margin-bottom: 28px;
        }
        @keyframes popIn { 0% { transform: scale(0.7); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }
        `;
        document.head.appendChild(style);
    }

    // 樣式 for 關卡卡片與配對卡片
    const style = document.createElement('style');
    style.textContent = `
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(to bottom, #020111 0%, #000010 100%);
      color: #fff;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      width: 95%;
      margin: 40px auto;
      padding: 30px;
      background: rgba(10, 20, 40, 0.7);
      border-radius: 20px;
      box-shadow: 0 0 32px #00ffff44, 0 0 80px #a259ff22 inset;
      border: 2px solid #00ffff;
      backdrop-filter: blur(8px);
      text-align: center;
    }
    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      color: #00ffff;
      text-shadow: 0 0 12px #00ffff, 0 0 32px #a259ff, 0 0 40px #fff2;
      margin: 40px 0 20px;
      text-align: center;
      letter-spacing: 2px;
    }
    #levelSelectArea {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 18px;
      justify-items: center;
      margin: 30px 0 20px 0;
    }
    .grid#matchGridWrap {
      background: rgba(10, 20, 40, 0.85);
      border-radius: 24px;
      border: 2.5px solid #00ffff;
      box-shadow: 0 0 32px #00ffff44, 0 0 80px #a259ff22 inset, 0 0 80px #fff2;
      padding: 32px 18px 24px 18px;
      margin: 0 auto 32px auto;
      max-width: 900px;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #matchGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 32px;
      justify-items: center;
      margin: 30px 0 20px 0;
    }
    .level-card {
      width: 120px;
      height: 180px;
      background: #181a22;
      border-radius: 20px;
      box-shadow: 0 0 28px #00ffffcc, 0 0 60px #a259ff44 inset;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      position: relative;
      color: #00ffff;
      margin: 0;
      border: 2px solid #00ffff;
      overflow: hidden;
      padding: 0 6px;
    }
    .level-card:hover {
      transform: scale(1.07);
      box-shadow: 0 4px 16px rgba(0,0,0,0.18);
      background: #e6f0fa;
    }
    .match-card {
      width: 120px;
      height: 170px;
      background: rgba(10, 20, 40, 0.9);
      border: 2px solid #00ffff;
      border-radius: 16px;
      box-shadow: 0 4px 16px #00ffff44, 0 0 32px #a259ff22 inset, 0 8px 24px #0008;
      color: #00ffff;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(.25,.8,.25,1), box-shadow 0.3s, background 0.2s;
      user-select: none;
      position: relative;
      perspective: 600px;
      margin: 0;
    }
    .match-card:hover {
      transform: translateY(-8px) scale(1.04) rotateZ(-2deg);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ff99, 0 8px 32px #000b;
    }
    .match-card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.5s cubic-bezier(0.4,0.2,0.2,1);
    }
    .match-card.flipped .match-card-inner {
      transform: rotateY(180deg);
    }
    .match-card-front, .match-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      backface-visibility: hidden;
      font-size: 1.2em;
      font-family: 'Orbitron', sans-serif;
      padding: 8px;
      word-break: normal;
      white-space: nowrap;
      text-align: center;
      overflow-wrap: normal;
      overflow: hidden;
      line-height: 1.2;
      max-width: 100%;
      max-height: 100%;
    }
    .match-card-front span, .match-card-back span {
      display: block;
      width: 100%;
      word-break: normal;
      white-space: nowrap;
      text-align: center;
      overflow-wrap: normal;
      overflow: hidden;
      font-size: 1em;
      line-height: 1.2;
      hyphens: none;
      letter-spacing: 0.02em;
    }
    .match-card-front {
      background: url('https://th.bing.com/th/id/OIP.aQ__NwCVOOJiBqSM_FonkAHaKC?r=0&rs=1&pid=ImgDetMain&cb=idpwebpc2') center/cover no-repeat, rgba(10, 20, 40, 0.9);
      color: #00ffff;
      border: 2px solid #00ffff;
      box-shadow: 0 0 16px #00ffff44, 0 0 32px #a259ff22 inset;
      font-size: 2.2em;
      font-weight: bold;
      text-shadow: 0 0 8px #000, 0 0 16px #00ffff;
    }
    .match-card-back {
      background: #00ffff;
      color: #222;
      border: 2px solid #a259ff;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ff99;
      transform: rotateY(180deg);
      font-weight: bold;
    }
    .match-card.matched {
      opacity: 0.3;
      pointer-events: none;
    }
    .btn {
      font-family: 'Orbitron', sans-serif;
      display: inline-block;
      padding: 12px 24px;
      margin: 10px;
      font-size: 1.1rem;
      color: #000;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-weight: bold;
      box-shadow: 0 0 16px #00ffff, 0 0 24px #a259ff99;
    }
    .btn:hover {
      transform: scale(1.08);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    /* 平板尺寸 */
    @media (max-width: 768px) {
      .container { 
        padding: 20px; 
        margin: 20px auto;
      }
      h1 { font-size: 2rem; }
      #levelSelectArea { 
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
        gap: 15px; 
      }
      .level-card { 
        width: 100px; 
        height: 150px; 
        font-size: 0.95em; 
      }
      .grid#matchGridWrap { 
        padding: 20px 10px 15px 10px; 
        border-radius: 16px; 
      }
      .match-card { 
        width: 90px; 
        height: 130px; 
        font-size: 1em; 
        border-radius: 12px; 
      }
      #matchGrid { 
        gap: 15px; 
        grid-template-columns: repeat(4, 1fr); 
        grid-template-rows: repeat(3, 1fr); 
      }
    }
    
    /* 手機尺寸 */
    @media (max-width: 480px) {
      .container { 
        padding: 15px; 
        margin: 10px auto;
        width: 98%;
      }
      h1 { font-size: 1.6rem; }
      #levelSelectArea { 
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
        gap: 10px; 
      }
      .level-card { 
        width: 80px; 
        height: 120px; 
        font-size: 0.85em; 
      }
      .grid#matchGridWrap { 
        padding: 15px 5px 10px 5px; 
        border-radius: 12px; 
      }
      .match-card { 
        width: 70px; 
        height: 100px; 
        font-size: 0.9em; 
        border-radius: 10px; 
      }
      .back-home-btn {
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        font-size: 0.9em;
      }
    }
    
    /* 小手機尺寸 */
    @media (max-width: 360px) {
      .container { 
        padding: 10px; 
        margin: 5px auto;
      }
      h1 { font-size: 1.4rem; }
      #levelSelectArea { 
        grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); 
        gap: 8px; 
      }
      .level-card { 
        width: 70px; 
        height: 105px; 
        font-size: 0.8em; 
      }
      .grid#matchGridWrap { 
        padding: 10px 3px 8px 3px; 
        border-radius: 10px; 
      }
      .match-card { 
        width: 60px; 
        height: 85px; 
        font-size: 0.8em; 
        border-radius: 8px; 
      }
      #matchGrid { 
        gap: 6px; 
        grid-template-columns: repeat(4, 1fr); 
        grid-template-rows: repeat(3, 1fr); 
      }
      .back-home-btn {
        top: 8px;
        right: 8px;
        padding: 6px 12px;
        font-size: 0.8em;
      }
      .btn {
        padding: 10px 18px;
        font-size: 0.95rem;
      }
      .review-word-list {
        gap: 8px 16px !important;
      }
    }
    
    /* 複習區域響應式設計 */
    .review-word-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px 32px;
      margin: 24px 0 18px 0;
    }
    
    @media (max-width: 768px) {
      .review-word-list {
        gap: 12px 24px !important;
      }
    }
    
    @media (max-width: 480px) {
      .review-word-list {
        gap: 10px 16px !important;
      }
    }
    .level-progress-bar {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg,#181818,#0a0a0a);
      border-radius: 16px;
      box-shadow: 0 0 16px #00ffff44, 0 0 32px #a259ff22 inset;
      border: 2px solid #00ffff;
      position: relative;
    }
    .level-progress-bg {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 16px;
      background: radial-gradient(circle at 60% 30%, #00ffff33 0%, #000 100%);
      z-index: 0;
    }
    .level-progress-label {
      position: relative;
      z-index: 1;
      color: #00ffff;
      font-size: 1.2em;
      font-weight: bold;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      letter-spacing: 2px;
      margin-top: 12px;
    }
    .level-progress-zh {
      position: relative;
      z-index: 1;
      color: #ffd700;
      font-size: 1.1em;
      font-family: 'Microsoft JhengHei', 'Noto Sans TC', 'PingFang TC', 'Heiti TC', sans-serif;
      font-weight: bold;
      margin-top: 2px;
      letter-spacing: 1px;
      text-shadow: 0 0 8px #ffd700, 0 0 16px #fff2;
    }
    `;
    document.head.appendChild(style);

    showLevelSelect();
    // 延遲一點時間再初始化語音，確保 SoundSystem 已載入
    setTimeout(initializeSpeechSynthesis, 100);
    </script>
</body>
</html> 