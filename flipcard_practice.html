<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>ç¿»ç‰Œå–®å­—ç·´ç¿’</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="responsive_enhanced.css">
    <style>
        /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
        html {
            overflow-x: hidden;
        }
        
        /* ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½åœ¨è¦–çª—ç¯„åœå…§ */
        * {
            box-sizing: border-box;
            max-width: 100%;
        }
        
        body { 
            font-family: 'Orbitron', sans-serif; 
            background: #f0f0f0; 
            text-align: center;
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
        }
        .container {
            font-family: 'Orbitron', sans-serif;
            max-width: 1200px;
            width: 95%;
            margin: 40px auto;
            padding: 30px;
            background: rgba(10, 20, 40, 0.7);
            border-radius: 20px;
            box-shadow: 0 0 32px #00ffff44, 0 0 80px #a259ff22 inset;
            border: 2px solid #00ffff;
            backdrop-filter: blur(8px);
            text-align: center;
        }
        .flip-card {
            background-color: transparent;
            width: 300px;
            height: 180px;
            perspective: 1000px;
            margin: 30px auto;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        .flip-card-back {
            transform: rotateY(180deg);
            color: #333;
        }
        button {
            padding: 10px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            background: #4a90e2;
            color: #fff;
            cursor: pointer;
            margin-top: 20px;
        }
        button:active { background: #357ab8; }
        #levelSelectArea {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        .level-card {
            width: 120px;
            height: 180px;
            background: #181a22;
            border-radius: 20px;
            box-shadow: 0 0 28px #00ffffcc, 0 0 60px #a259ff44 inset;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
            position: relative;
            color: #00ffff;
            margin: 0;
            border: 2px solid #00ffff;
            overflow: hidden;
            padding: 0 6px;
        }
        .level-card .level-en {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            color: #00ffff;
            font-weight: bold;
            text-shadow: 0 0 10px #00ffff, 0 0 18px #00ffff99;
            letter-spacing: 1px;
            margin-top: 18px;
            margin-bottom: 0.3em;
            text-align: center;
            text-transform: uppercase;
        }
        .level-card .level-desc {
            font-size: 0.85em;
            color: #b6aaff;
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', 'PingFang TC', 'Heiti TC', sans-serif;
            font-weight: 500;
            margin: 0.3em 0 0.3em 0;
            letter-spacing: 1px;
            text-align: center;
            line-height: 1.4;
            min-height: 2.2em;
        }
        .level-card .level-status {
            font-size: 0.9em;
            color: #ffd700;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            margin-top: 0.7em;
            margin-bottom: 0.2em;
            letter-spacing: 1px;
            text-align: center;
            text-shadow: 0 0 6px #ffd700, 0 0 12px #fff2;
        }
        .level-card.completed {
            background: linear-gradient(135deg, #181a22 60%, #e0e7ef 100%);
            box-shadow: 0 0 36px #00ffff, 0 0 80px #a259ff99 inset, 0 0 24px #fff8;
            border: 2px solid #a259ff;
            animation: cardGlow 1.2s infinite alternate;
        }
        .level-card.completed::after {
            content: '\2714';
            position: absolute;
            top: 10px;
            right: 12px;
            font-size: 1.5em;
            color: #a259ff;
            text-shadow: 0 0 8px #fff, 0 0 16px #a259ff99;
            z-index: 2;
        }
        .level-card .level-progress-bar, .level-card .level-progress-label, .level-card .level-progress-zh {
            display: none !important;
        }
        @keyframes cardGlow {
            0% { box-shadow: 0 0 36px #00ffff, 0 0 80px #a259ff99 inset, 0 0 24px #fff8; }
            100% { box-shadow: 0 0 48px #00ffffcc, 0 0 120px #a259ffcc inset, 0 0 36px #fff; }
        }
        .level-card:hover {
            transform: scale(1.07);
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            background: #e6f0fa;
        }
        .match-card-front {
            background: url('https://th.bing.com/th/id/OIP.aQ__NwCVOOJiBqSM_FonkAHaKC?r=0&rs=1&pid=ImgDetMain&cb=idpwebpc2') center/cover no-repeat, rgba(10, 20, 40, 0.9);
            color: #00ffff;
            border: 2px solid #00ffff;
            box-shadow: 0 0 16px #00ffff44, 0 0 32px #a259ff22 inset;
            font-size: 2.2em;
            font-weight: bold;
            text-shadow: 0 0 8px #000, 0 0 16px #00ffff;
        }
        .back-home-btn {
            font-family: 'Orbitron', sans-serif;
            position: absolute;
            top: 24px;
            right: 32px;
            background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
            color: #000;
            border: none;
            border-radius: 12px;
            padding: 10px 22px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 0 16px #00ffff, 0 0 24px #a259ff99;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 100;
        }
        .back-home-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        /* å¤§è¢å¹•å„ªåŒ– */
        @media (min-width: 1200px) {
            .container {
                max-width: 1400px;
                padding: 40px;
            }
            
            #levelSelectArea {
                gap: 30px;
            }
            
            .level-card {
                width: 140px;
                height: 200px;
            }
        }

        /* å¹³æ¿é©é… */
        @media (max-width: 1024px) {
            .container {
                width: 98%;
                padding: 25px;
                margin: 30px auto;
            }
            
            #levelSelectArea {
                gap: 18px;
            }
            
            .level-card {
                width: 110px;
                height: 170px;
                padding: 10px;
            }
            
            .level-card .level-en {
                font-size: 1.1rem;
            }
            
            .level-card .level-desc {
                font-size: 0.8rem;
            }
            
            .back-home-btn {
                top: 20px;
                right: 25px;
                padding: 8px 18px;
                font-size: 1rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                width: 100%;
                padding: 20px;
                margin: 20px auto;
            }
            
            h1 {
                font-size: 1.8rem;
                margin-bottom: 20px;
            }
            
            #levelSelectArea {
                gap: 15px;
                margin: 25px 0;
            }
            
            .level-card {
                width: 100px;
                height: 150px;
                padding: 8px;
            }
            
            .level-card .level-en {
                font-size: 1rem;
                margin-top: 12px;
            }
            
            .level-card .level-desc {
                font-size: 0.75rem;
                line-height: 1.3;
            }
            
            .level-card .level-status {
                font-size: 0.8rem;
                margin-top: 0.5em;
            }
            
            .flip-card {
                width: 250px;
                height: 150px;
                margin: 25px auto;
            }
            
            .flip-card-front, .flip-card-back {
                font-size: 1.6em;
            }
            
            button {
                padding: 8px 24px;
                font-size: 1.1em;
            }
            
            .back-home-btn {
                top: 15px;
                right: 20px;
                padding: 6px 15px;
                font-size: 0.9rem;
            }
        }

        /* æ‰‹æ©Ÿé©é… */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
                margin: 15px auto;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            #levelSelectArea {
                gap: 12px;
                margin: 20px 0;
            }
            
            .level-card {
                width: 90px;
                height: 135px;
                padding: 6px;
            }
            
            .level-card .level-en {
                font-size: 0.9rem;
                margin-top: 10px;
            }
            
            .level-card .level-desc {
                font-size: 0.7rem;
                line-height: 1.2;
                min-height: 2em;
            }
            
            .level-card .level-status {
                font-size: 0.75rem;
            }
            
            .flip-card {
                width: 200px;
                height: 120px;
                margin: 20px auto;
            }
            
            .flip-card-front, .flip-card-back {
                font-size: 1.3em;
            }
            
            button {
                padding: 6px 20px;
                font-size: 1rem;
            }
            
            .back-home-btn {
                top: 12px;
                right: 15px;
                padding: 5px 12px;
                font-size: 0.8rem;
            }
        }

        /* å°è¢å¹•æ‰‹æ©Ÿ */
        @media (max-width: 480px) {
            .container {
                padding: 12px;
                margin: 10px auto;
            }
            
            h1 {
                font-size: 1.4rem;
            }
            
            #levelSelectArea {
                gap: 10px;
                margin: 18px 0;
            }
            
            .level-card {
                width: 80px;
                height: 120px;
                padding: 5px;
            }
            
            .level-card .level-en {
                font-size: 0.8rem;
                margin-top: 8px;
            }
            
            .level-card .level-desc {
                font-size: 0.65rem;
                line-height: 1.1;
                min-height: 1.8em;
            }
            
            .level-card .level-status {
                font-size: 0.7rem;
                margin-top: 0.3em;
            }
            
            .flip-card {
                width: 180px;
                height: 110px;
                margin: 15px auto;
            }
            
            .flip-card-front, .flip-card-back {
                font-size: 1.1em;
            }
            
            button {
                padding: 5px 16px;
                font-size: 0.9rem;
            }
            
            .back-home-btn {
                top: 10px;
                right: 12px;
                padding: 4px 10px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-home-btn" onclick="location.href='atlas.html'">â† è¿”å›é¦–é </button>
        <h1>ğŸŒŒ å–®å­—é…å°è¨˜æ†¶éŠæˆ²</h1>
        <div id="levelSelectArea"></div>
        <div id="reviewArea" style="display:none;">
            <h2>æœ¬é—œå–®å­—è¤‡ç¿’</h2>
            <div id="reviewWordList" style="display:flex;flex-wrap:wrap;justify-content:center;gap:16px 32px;margin:24px 0 18px 0;" class="review-word-list"></div>
            <button class="btn" id="startGameBtn">é–‹å§‹éŠæˆ²</button>
            <button class="btn" id="skipLevelBtn1">æˆ‘å·²ç¶“æœƒäº†ï¼Œè·³åˆ°ä¸‹ä¸€é—œ</button>
        </div>
        <div id="matchGameArea" style="display:none;">
            <div class="grid" id="matchGridWrap">
                <div id="matchGrid"></div>
            </div>
            <button class="btn" id="backToMenuBtn" style="display:none;">è¿”å›é¸å–®</button>
            <button class="btn" id="skipLevelBtn2">æˆ‘å·²ç¶“æœƒäº†ï¼Œè·³åˆ°ä¸‹ä¸€é—œ</button>
        </div>
    </div>
    <audio id="successSound" src="sound/correct.mp3" preload="auto"></audio>
    <audio id="failSound" src="sound/wrong.mp3" preload="auto"></audio>
    <script src="js/sound.js"></script>
    <script src="js/vocabData.js"></script>
    <script>
    let vocabList = [];
    let currentGroup = '';
    let completedGroups = JSON.parse(localStorage.getItem('flipcard_completedGroups') || '{}');
    let currentLevel = 0; // é—œå¡ç·¨è™Ÿ 0~3
    let levelWordSets = [];
    const LEVELS_PER_GROUP = 4;
    const WORDS_PER_LEVEL = 5;
    let allLevelWords = [];
    let matchPairs = [];
    let matchCards = [];
    let firstCard = null;
    let lockBoard = false;
    let matchedCount = 0;
    // é é¢è¼‰å…¥æ™‚é å…ˆè¼‰å…¥èªéŸ³
    let voicesLoaded = false;
    let enVoice = null;
    // æ–°å¢ï¼šæ”¯æ´å¾ç¶²å€åƒæ•¸ book=æ›¸å ç›´æ¥è¼‰å…¥å–®å­—æœ¬
    const urlBookName = new URLSearchParams(location.search).get('book');
    let customBookVocab = null;
    if (urlBookName) {
      // è®€å– localStorage çš„ book_æ›¸å
      try {
        const arr = JSON.parse(localStorage.getItem('book_' + urlBookName) || '[]');
        // è½‰æ›æˆ {en, zh} æ ¼å¼
        if (Array.isArray(arr) && arr.length > 0) {
          customBookVocab = arr.map(v => ({ en: v.word, zh: v.meaning }));
        }
      } catch {}
    }

    // æ–°å¢ï¼šæ›´ç©©å®šå¯é çš„èªéŸ³åˆå§‹åŒ–å‡½æ•¸
    function initializeSpeechSynthesis() {
      // ç¢ºä¿ SoundSystem åˆå§‹åŒ–ï¼Œä¸¦é¸æ“‡æœ€ä½³èªéŸ³
      if (typeof SoundSystem !== 'undefined' && !SoundSystem.speech.isInitialized) {
        SoundSystem.speech.init();
      }
      
      // å¦‚æœèªéŸ³å·²ç¶“è¼‰å…¥ï¼Œå°±ç›´æ¥ä½¿ç”¨
      if (speechSynthesis.getVoices().length > 0) {
        if (typeof SoundSystem !== 'undefined') {
            SoundSystem.speech.selectBestVoice();
        }
        voicesLoaded = true;
      } else {
        // å¦å‰‡ï¼Œè¨­å®šäº‹ä»¶ç›£è½å™¨ï¼Œä¸¦åœ¨1ç§’å¾Œå†æ¬¡æª¢æŸ¥ä»¥é˜²è¬ä¸€
        speechSynthesis.onvoiceschanged = () => {
          if (typeof SoundSystem !== 'undefined') {
            SoundSystem.speech.selectBestVoice();
          }
          voicesLoaded = true;
        };
        setTimeout(() => {
            if (speechSynthesis.getVoices().length > 0 && !voicesLoaded) {
                speechSynthesis.onvoiceschanged();
            }
        }, 1000);
      }
    }

    function getGroupNames() {
        return Object.keys(vocabData);
    }

    // æ˜Ÿåº§è‹±æ–‡å°æ‡‰ä¸­æ–‡
    const groupNameMap = {
      aries: 'ç‰¡ç¾Šåº§',
      taurus: 'é‡‘ç‰›åº§',
      gemini: 'é›™å­åº§',
      cancer: 'å·¨èŸ¹åº§',
      leo: 'ç…å­åº§',
      virgo: 'è™•å¥³åº§',
      libra: 'å¤©ç§¤åº§',
      scorpio: 'å¤©è åº§',
      sagittarius: 'å°„æ‰‹åº§',
      capricorn: 'æ‘©ç¾¯åº§',
      aquarius: 'æ°´ç“¶åº§',
      pisces: 'é›™é­šåº§',
      phoenix: 'é³³å‡°åº§',
      draco: 'å¤©é¾åº§',
      orion: 'çµæˆ¶åº§',
      cygnus: 'å¤©éµåº§',
      pegasus: 'é£›é¦¬åº§',
      cassiopeia: 'ä»™ååº§',
      scorpius: 'å¤©è åº§',
      vela: 'èˆ¹å¸†åº§',
      cassiopeia: 'ä»™ååº§'
    };

    // æ˜Ÿåº§æè¿°
    const groupDescMap = {
      aries: 'ç‰¡ç¾Šåº§ï¼Œè±¡å¾µå‹‡æ°£èˆ‡å†’éšªã€‚',
      taurus: 'é‡‘ç‰›åº§ï¼Œä»£è¡¨å …æ¯…èˆ‡ç©©é‡ã€‚',
      gemini: 'é›™å­åº§ï¼Œéˆæ´»å¤šè®Šã€å–„æ–¼æºé€šã€‚',
      cancer: 'å·¨èŸ¹åº§ï¼Œæº«æŸ”é«”è²¼ã€é‡è¦–å®¶åº­ã€‚',
      leo: 'ç…å­åº§ï¼Œç†±æƒ…è‡ªä¿¡ã€é ˜å°åŠ›å¼·ã€‚',
      virgo: 'è™•å¥³åº§ï¼Œç´°å¿ƒè¬¹æ…ã€è¿½æ±‚å®Œç¾ã€‚',
      libra: 'å¤©ç§¤åº§ï¼Œå…¬å¹³å’Œè«§ã€é‡è¦–ç¾æ„Ÿã€‚',
      scorpio: 'å¤©è åº§ï¼Œç¥ç§˜æ·±æ²‰ã€æ„å¿—å …å®šã€‚',
      sagittarius: 'å°„æ‰‹åº§ï¼Œæ¨‚è§€é–‹æœ—ã€ç†±æ„›è‡ªç”±ã€‚',
      capricorn: 'æ‘©ç¾¯åº§ï¼Œå‹™å¯¦åŠªåŠ›ã€ç›®æ¨™æ˜ç¢ºã€‚',
      aquarius: 'æ°´ç“¶åº§ï¼Œå‰µæ–°ç¨ç«‹ã€æ€æƒ³å‰è¡›ã€‚',
      pisces: 'é›™é­šåº§ï¼Œæ„Ÿæ€§æµªæ¼«ã€å¯Œæœ‰åŒæƒ…å¿ƒã€‚',
      phoenix: 'é³³å‡°åº§ï¼Œé‡ç”Ÿèˆ‡å¸Œæœ›çš„è±¡å¾µã€‚',
      draco: 'å¤©é¾åº§ï¼Œç¥ç§˜èˆ‡å®ˆè­·çš„åŠ›é‡ã€‚',
      orion: 'çµæˆ¶åº§ï¼Œå‹‡æ•¢çš„çµäººå‚³èªªã€‚',
      cygnus: 'å¤©éµåº§ï¼Œç´”æ½”èˆ‡å„ªé›…çš„è±¡å¾µã€‚',
      pegasus: 'é£›é¦¬åº§ï¼Œå¤¢æƒ³èˆ‡è‡ªç”±çš„åŒ–èº«ã€‚',
      cassiopeia: 'ä»™ååº§ï¼Œå„ªé›…èˆ‡è‡ªä¿¡çš„å¥³ç‹ã€‚',
      scorpius: 'å¤©è åº§ï¼Œç¥ç§˜æ·±æ²‰ã€æ„å¿—å …å®šã€‚',
      vela: 'èˆ¹å¸†åº§ï¼Œå•Ÿèˆªèˆ‡å†’éšªçš„é–‹å§‹ã€‚'
    };

    function showLevelSelect() {
        // å¦‚æœæœ‰è‡ªè¨‚å–®å­—æœ¬ï¼Œç›´æ¥é€²å…¥ç·´ç¿’ï¼Œä¸é¡¯ç¤ºç¾¤çµ„é¸å–®
        if (customBookVocab) {
            // ç›´æ¥åˆ† 4 é—œï¼Œæ¯é—œ 5 å€‹å–®å­—
            let allWords = customBookVocab.slice();
            shuffleArray(allWords);
            allLevelWords = allWords.slice(0, Math.min(LEVELS_PER_GROUP * WORDS_PER_LEVEL, allWords.length));
            levelWordSets = [];
            for (let i = 0; i < LEVELS_PER_GROUP; i++) {
                levelWordSets.push(allLevelWords.slice(i*WORDS_PER_LEVEL, (i+1)*WORDS_PER_LEVEL));
            }
            currentLevel = 0;
            showReviewArea();
            // éš±è—ç¾¤çµ„é¸å–®
            document.getElementById('levelSelectArea').style.display = 'none';
            return;
        }
        // å¦å‰‡é¡¯ç¤ºåŸæœ¬çš„ç¾¤çµ„é¸å–®
        const area = document.getElementById('levelSelectArea');
        area.innerHTML = '';
        getGroupNames().forEach(group => {
            let key = group + '_ALL';
            let completed = completedGroups[key];
            if (completed) {
              let passed = JSON.parse(localStorage.getItem('passed_flipcard')||'[]');
              if (!passed.includes(group)) {
                passed.push(group);
                localStorage.setItem('passed_flipcard', JSON.stringify(passed));
              }
            }
            const card = document.createElement('div');
            card.className = 'level-card' + (completed ? ' completed' : '');
            const en = group.toUpperCase();
            const desc = groupDescMap[group] || '';
            let status = completed ? 'å·²è§£é–' : '';
            card.innerHTML = `
                <div class="level-en">${en}</div>
                <div class="level-desc">${desc}</div>
                <div class="level-status">${status}</div>
            `;
            card.onclick = function() {
                currentGroup = group;
                // å–å‡ºå…¨éƒ¨å–®å­—ï¼Œéš¨æ©Ÿåˆ†4é—œ
                let allWords = (vocabData[group] || []).slice();
                shuffleArray(allWords);
                allLevelWords = allWords.slice(0, Math.min(LEVELS_PER_GROUP * WORDS_PER_LEVEL, allWords.length));
                levelWordSets = [];
                for (let i = 0; i < LEVELS_PER_GROUP; i++) {
                    levelWordSets.push(allLevelWords.slice(i*WORDS_PER_LEVEL, (i+1)*WORDS_PER_LEVEL));
                }
                currentLevel = 0;
                showReviewArea(); // å…ˆé¡¯ç¤ºè¤‡ç¿’å€
            };
            area.appendChild(card);
        });
        area.style.display = '';
        document.getElementById('matchGameArea').style.display = 'none';
        document.getElementById('reviewArea').style.display = 'none';
    }

    function showReviewArea() {
        // å–å¾—æœ¬é—œå–®å­—
        let pairs = (levelWordSets && levelWordSets[currentLevel]) ? levelWordSets[currentLevel].slice() : [];
        const reviewArea = document.getElementById('reviewArea');
        const list = document.getElementById('reviewWordList');
        list.innerHTML = '';
        pairs.forEach(pair => {
            const item = document.createElement('div');
            item.style.display = 'flex';
            item.style.flexDirection = 'column';
            item.style.alignItems = 'center';
            item.style.justifyContent = 'center';
            item.style.background = 'rgba(255,255,255,0.92)';
            item.style.color = '#222';
            item.style.borderRadius = '10px';
            item.style.padding = '12px 18px';
            item.style.fontSize = '1.2em';
            item.style.boxShadow = '0 2px 8px #00ffff44';
            item.style.cursor = 'pointer';
            item.style.minWidth = '90px';
            item.innerHTML = `<div style='font-weight:bold;font-size:1.1em;'>${pair.zh}</div><div style='color:#00aaff;margin-top:4px;'>${pair.en}</div>`;
            item.title = 'é»æ“Šç™¼éŸ³';
            item.onclick = function() { speakWord(pair.en); };
            list.appendChild(item);
        });
        document.getElementById('levelSelectArea').style.display = 'none';
        document.getElementById('matchGameArea').style.display = 'none';
        reviewArea.style.display = '';
    }

    function startMatchGame() {
        // å–æœ¬é—œå–®å­—
        let pairs = (levelWordSets && levelWordSets[currentLevel]) ? levelWordSets[currentLevel].slice() : [];
        matchPairs = pairs;
        setupMatchGrid();
        document.getElementById('levelSelectArea').style.display = 'none';
        document.getElementById('matchGameArea').style.display = '';
        document.getElementById('backToMenuBtn').style.display = 'none';
        showLevelProgress();
        // é€²å…¥æ™‚å…¨éƒ¨ç¿»é–‹10ç§’ï¼Œä¸¦é¡¯ç¤ºå€’æ•¸
        let previewSec = 10;
        showPreviewCountdown(previewSec);
        setTimeout(() => {
            document.querySelectorAll('.match-card').forEach(card => card.classList.add('flipped'));
            lockBoard = true;
            let left = previewSec;
            let timer = setInterval(() => {
                left--;
                showPreviewCountdown(left);
                if (left <= 0) {
                    clearInterval(timer);
                    document.querySelectorAll('.match-card').forEach(card => card.classList.remove('flipped'));
                    lockBoard = false;
                    showPreviewCountdown(0, true);
                }
            }, 1000);
        }, 100);
    }

    function setupMatchGrid() {
        const grid = document.getElementById('matchGrid');
        grid.innerHTML = '';
        firstCard = null;
        lockBoard = false;
        matchedCount = 0;
        // ç”¢ç”Ÿè‹±æ–‡å¡ç‰‡èˆ‡ä¸­æ–‡å¡ç‰‡
        let cards = [];
        matchPairs.forEach((pair, idx) => {
            cards.push({ type: 'en', value: pair.en, pairId: idx });
            cards.push({ type: 'zh', value: pair.zh, pairId: idx });
        });
        shuffleArray(cards);
        matchCards = cards;
        // å»ºç«‹å¡ç‰‡å…ƒç´ 
        cards.forEach((card, i) => {
            const div = document.createElement('div');
            div.className = 'match-card';
            div.dataset.type = card.type;
            div.dataset.value = card.value;
            div.dataset.pairId = card.pairId;
            // 3Dç¿»ç‰Œçµæ§‹
            const inner = document.createElement('div');
            inner.className = 'match-card-inner';
            const front = document.createElement('div');
            front.className = 'match-card-front';
            front.innerHTML = '<span>?</span>';
            const back = document.createElement('div');
            back.className = 'match-card-back';
            const len = (card.value || '').length;
            back.innerHTML = `<span style=\"--len:${len}\">${card.value}</span>`;
            inner.appendChild(front);
            inner.appendChild(back);
            div.appendChild(inner);
            div.onclick = function() { onCardClick(div, card); };
            grid.appendChild(div);
        });
        // å‹•æ…‹èª¿æ•´å­—é«”å¤§å°ï¼Œç¢ºä¿å…§å®¹ä¸è¶…å‡ºå¡ç‰‡
        setTimeout(() => {
            grid.querySelectorAll('.match-card-back span').forEach(span => {
                fitTextToCardOneLine(span, span.parentElement);
            });
        }, 0);
    }

    function onCardClick(div, card) {
        if (lockBoard || div.classList.contains('matched')) return;
        // é»æ“Šè‹±æ–‡å¡ç‰Œæ™‚ç™¼éŸ³ï¼ˆä¸è«–æ˜¯å¦å·²ç¿»é–‹ï¼‰
        if (card.type === 'en') {
            speakWord(card.value);
        }
        if (div.classList.contains('flipped')) return;
        div.classList.add('flipped');
        if (!firstCard) {
            firstCard = { div, card };
        } else {
            lockBoard = true;
            setTimeout(() => {
                if (firstCard.card.pairId === card.pairId && firstCard.card.type !== card.type) {
                    // é…å°æˆåŠŸ
                    document.getElementById('successSound').currentTime = 0;
                    document.getElementById('successSound').play();
                    div.classList.add('matched');
                    firstCard.div.classList.add('matched');
                    matchedCount++;
                    if (matchedCount === matchPairs.length) {
                        // é€²å…¥ä¸‹ä¸€é—œæˆ–å…¨éƒ¨å®Œæˆ
                        if (currentLevel < LEVELS_PER_GROUP - 1) {
                            currentLevel++;
                            matchedCount = 0;
                            setTimeout(() => {
                                showReviewArea();
                            }, 600);
                        } else {
                            // æ¨™è¨˜æœ¬çµ„å…¨éƒ¨å®Œæˆ
                            let key = currentGroup + '_ALL';
                            completedGroups[key] = true;
                            localStorage.setItem('flipcard_completedGroups', JSON.stringify(completedGroups));
                            showCompleteModal();
                        }
                    }
                } else {
                    // é…å°å¤±æ•—
                    document.getElementById('failSound').currentTime = 0;
                    document.getElementById('failSound').play();
                    div.classList.remove('flipped');
                    firstCard.div.classList.remove('flipped');
                }
                firstCard = null;
                lockBoard = false;
            }, 800);
        }
    }

    // è‡ªå‹•ç™¼éŸ³å‡½å¼
    function speakWord(word) {
        if (!window.speechSynthesis) return;
        // ä½¿ç”¨æ–°çš„ç™¼éŸ³ç³»çµ±
        if (typeof SoundSystem !== 'undefined' && SoundSystem.speech) {
            SoundSystem.speech.speakWord(word);
        } else {
            // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœ SoundSystem ä¸å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ç€è¦½å™¨ API
            const utter = new SpeechSynthesisUtterance(word);
            utter.lang = 'en-US';
            window.speechSynthesis.speak(utter);
        }
    }

    document.getElementById('startGameBtn').onclick = function() {
        document.getElementById('reviewArea').style.display = 'none';
        startMatchGame();
    };

    document.getElementById('backToMenuBtn').onclick = function() {
        showLevelSelect();
    };

    // æ–°å¢ï¼šè·³é—œé‚è¼¯
    function skipLevel() {
        if (currentLevel < LEVELS_PER_GROUP - 1) {
            currentLevel++;
            matchedCount = 0;
            showReviewArea();
        } else {
            // æ¨™è¨˜æœ¬çµ„å…¨éƒ¨å®Œæˆ
            let key = currentGroup + '_ALL';
            completedGroups[key] = true;
            localStorage.setItem('flipcard_completedGroups', JSON.stringify(completedGroups));
            showCompleteModal();
        }
    }
    // ç¶å®šæŒ‰éˆ•äº‹ä»¶ï¼ˆéœ€ç­‰ DOM è¼‰å…¥ï¼‰
    setTimeout(() => {
        let btn1 = document.getElementById('skipLevelBtn1');
        if (btn1) btn1.onclick = skipLevel;
        let btn2 = document.getElementById('skipLevelBtn2');
        if (btn2) btn2.onclick = skipLevel;
    }, 0);

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // é¡¯ç¤ºçœ‹ç‰Œå€’æ•¸
    function showPreviewCountdown(sec, hide) {
        let el = document.getElementById('previewCountdown');
        if (!el && !hide) {
            el = document.createElement('div');
            el.id = 'previewCountdown';
            el.style.position = 'fixed';
            el.style.top = '30px';
            el.style.left = '50%';
            el.style.transform = 'translateX(-50%)';
            el.style.background = 'rgba(10,20,40,0.92)';
            el.style.color = '#ffd700';
            el.style.fontSize = '2.2em';
            el.style.fontWeight = 'bold';
            el.style.padding = '18px 38px';
            el.style.borderRadius = '18px';
            el.style.boxShadow = '0 0 32px #00ffff, 0 0 48px #a259ff99';
            el.style.zIndex = 9999;
            document.body.appendChild(el);
        }
        if (el) {
            if (hide || sec <= 0) {
                el.remove();
            } else {
                el.innerHTML = 'è¨˜æ†¶æ™‚é–“ <span style="color:#00ffff">' + sec + '</span> ç§’';
            }
        }
    }

    // é¡¯ç¤ºå®‡å®™é¢¨æ ¼é€²åº¦æ¢
    function showLevelProgress() {
        let el = document.getElementById('levelProgressBar');
        if (!el) {
            el = document.createElement('div');
            el.id = 'levelProgressBar';
            el.style.margin = '0 auto 18px auto';
            el.style.maxWidth = '400px';
            el.style.display = 'flex';
            el.style.justifyContent = 'center';
            el.style.alignItems = 'center';
            el.style.gap = '12px';
            el.style.fontFamily = "Orbitron, 'Roboto Mono', Arial, sans-serif";
            el.style.fontWeight = 'bold';
            el.style.fontSize = '1.3em';
            el.style.letterSpacing = '2px';
            el.style.color = '#ffd700';
            el.style.textShadow = '0 0 8px #00ffff, 0 0 16px #a259ff';
            document.querySelector('.container').insertBefore(el, document.getElementById('matchGameArea'));
        }
        el.innerHTML = `<span style="color:#00ffff;">ç¬¬ ${currentLevel+1} é—œ</span> / å…±4é—œ`;
    }

    // å‹•æ…‹èª¿æ•´å­—é«”å¤§å°ç›´åˆ°å…§å®¹ä¸è¶…å‡ºå¡ç‰‡
    function fitTextToCard(span, cardDiv) {
        let maxFont = 2.2;
        let minFont = 0.7;
        let font = maxFont;
        span.style.fontSize = font + 'em';
        const maxHeight = cardDiv.clientHeight - 16;
        const maxWidth = cardDiv.clientWidth - 16;
        while ((span.scrollHeight > maxHeight || span.scrollWidth > maxWidth) && font > minFont) {
            font -= 0.08;
            span.style.fontSize = font + 'em';
        }
    }

    // è‹±æ–‡å–®å­—ï¼šå‹•æ…‹ç¸®å°å­—é«”ç›´åˆ°å–®è¡Œå…§ä¸è¶…å‡ºå¡ç‰‡å¯¬åº¦
    function fitTextToCardOneLine(span, cardDiv) {
        let maxFont = 1.1;
        let minFont = 0.5;
        let font = maxFont;
        span.style.fontSize = font + 'em';
        span.style.whiteSpace = 'nowrap';
        const maxWidth = cardDiv.clientWidth - 16;
        while ((span.scrollWidth > maxWidth) && font > minFont) {
            font -= 0.04;
            span.style.fontSize = font + 'em';
        }
    }

    // å®Œæˆå…¨éƒ¨é—œå¡æ™‚çš„ç¾è§€æç¤º
    function showCompleteModal() {
        // è‹¥å·²å­˜åœ¨å‰‡ç§»é™¤
        let old = document.getElementById('completeModal');
        if (old) old.remove();
        const modal = document.createElement('div');
        modal.id = 'completeModal';
        modal.innerHTML = `
            <div class="complete-modal-content">
                <div class="complete-icon">ğŸ‰</div>
                <div class="complete-title">æ­å–œå®Œæˆå…¨éƒ¨é—œå¡ï¼</div>
                <div class="complete-desc">ä½ å·²å®Œæˆæœ¬çµ„æ‰€æœ‰å–®å­—é…å°ï¼</div>
                <button class="btn" id="backToMenuBtn2">è¿”å›é¸å–®</button>
            </div>
        `;
        Object.assign(modal.style, {
            position: 'fixed', left: 0, top: 0, width: '100vw', height: '100vh', zIndex: 9999,
            background: 'rgba(10,20,40,0.92)', display: 'flex', alignItems: 'center', justifyContent: 'center',
            animation: 'fadeIn 0.5s'
        });
        document.body.appendChild(modal);
        document.getElementById('backToMenuBtn2').onclick = function() {
            modal.remove();
            showLevelSelect();
        };
        // ç§»é™¤é€²åº¦æ¢
        let el = document.getElementById('levelProgressBar');
        if (el) el.remove();
        // å‹•ç•«æ¨£å¼
        const style = document.createElement('style');
        style.textContent = `
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #completeModal .complete-modal-content {
            background: linear-gradient(135deg,#00ffff 0%,#a259ff 100%);
            border-radius: 24px;
            box-shadow: 0 0 48px #00ffff99, 0 0 80px #a259ff44 inset;
            padding: 48px 36px 36px 36px;
            text-align: center;
            color: #fff;
            min-width: 320px;
            max-width: 90vw;
            animation: popIn 0.7s cubic-bezier(.4,2,.6,1);
        }
        #completeModal .complete-icon {
            font-size: 3.5em;
            margin-bottom: 18px;
            animation: tada 1.2s;
        }
        #completeModal .complete-title {
            font-size: 2.1em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 16px #fff, 0 0 32px #a259ff;
        }
        #completeModal .complete-desc {
            font-size: 1.2em;
            margin-bottom: 28px;
        }
        @keyframes popIn { 0% { transform: scale(0.7); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }
        `;
        document.head.appendChild(style);
    }

    // æ¨£å¼ for é—œå¡å¡ç‰‡èˆ‡é…å°å¡ç‰‡
    const style = document.createElement('style');
    style.textContent = `
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(to bottom, #020111 0%, #000010 100%);
      color: #fff;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      width: 95%;
      margin: 40px auto;
      padding: 30px;
      background: rgba(10, 20, 40, 0.7);
      border-radius: 20px;
      box-shadow: 0 0 32px #00ffff44, 0 0 80px #a259ff22 inset;
      border: 2px solid #00ffff;
      backdrop-filter: blur(8px);
      text-align: center;
    }
    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      color: #00ffff;
      text-shadow: 0 0 12px #00ffff, 0 0 32px #a259ff, 0 0 40px #fff2;
      margin: 40px 0 20px;
      text-align: center;
      letter-spacing: 2px;
    }
    #levelSelectArea {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 18px;
      justify-items: center;
      margin: 30px 0 20px 0;
    }
    .grid#matchGridWrap {
      background: rgba(10, 20, 40, 0.85);
      border-radius: 24px;
      border: 2.5px solid #00ffff;
      box-shadow: 0 0 32px #00ffff44, 0 0 80px #a259ff22 inset, 0 0 80px #fff2;
      padding: 32px 18px 24px 18px;
      margin: 0 auto 32px auto;
      max-width: 900px;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #matchGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 32px;
      justify-items: center;
      margin: 30px 0 20px 0;
    }
    .level-card {
      width: 120px;
      height: 180px;
      background: #181a22;
      border-radius: 20px;
      box-shadow: 0 0 28px #00ffffcc, 0 0 60px #a259ff44 inset;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      position: relative;
      color: #00ffff;
      margin: 0;
      border: 2px solid #00ffff;
      overflow: hidden;
      padding: 0 6px;
    }
    .level-card:hover {
      transform: scale(1.07);
      box-shadow: 0 4px 16px rgba(0,0,0,0.18);
      background: #e6f0fa;
    }
    .match-card {
      width: 120px;
      height: 170px;
      background: rgba(10, 20, 40, 0.9);
      border: 2px solid #00ffff;
      border-radius: 16px;
      box-shadow: 0 4px 16px #00ffff44, 0 0 32px #a259ff22 inset, 0 8px 24px #0008;
      color: #00ffff;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(.25,.8,.25,1), box-shadow 0.3s, background 0.2s;
      user-select: none;
      position: relative;
      perspective: 600px;
      margin: 0;
    }
    .match-card:hover {
      transform: translateY(-8px) scale(1.04) rotateZ(-2deg);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ff99, 0 8px 32px #000b;
    }
    .match-card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.5s cubic-bezier(0.4,0.2,0.2,1);
    }
    .match-card.flipped .match-card-inner {
      transform: rotateY(180deg);
    }
    .match-card-front, .match-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      backface-visibility: hidden;
      font-size: 1.2em;
      font-family: 'Orbitron', sans-serif;
      padding: 8px;
      word-break: normal;
      white-space: nowrap;
      text-align: center;
      overflow-wrap: normal;
      overflow: hidden;
      line-height: 1.2;
      max-width: 100%;
      max-height: 100%;
    }
    .match-card-front span, .match-card-back span {
      display: block;
      width: 100%;
      word-break: normal;
      white-space: nowrap;
      text-align: center;
      overflow-wrap: normal;
      overflow: hidden;
      font-size: 1em;
      line-height: 1.2;
      hyphens: none;
      letter-spacing: 0.02em;
    }
    .match-card-front {
      background: url('https://th.bing.com/th/id/OIP.aQ__NwCVOOJiBqSM_FonkAHaKC?r=0&rs=1&pid=ImgDetMain&cb=idpwebpc2') center/cover no-repeat, rgba(10, 20, 40, 0.9);
      color: #00ffff;
      border: 2px solid #00ffff;
      box-shadow: 0 0 16px #00ffff44, 0 0 32px #a259ff22 inset;
      font-size: 2.2em;
      font-weight: bold;
      text-shadow: 0 0 8px #000, 0 0 16px #00ffff;
    }
    .match-card-back {
      background: #00ffff;
      color: #222;
      border: 2px solid #a259ff;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ff99;
      transform: rotateY(180deg);
      font-weight: bold;
    }
    .match-card.matched {
      opacity: 0.3;
      pointer-events: none;
    }
    .btn {
      font-family: 'Orbitron', sans-serif;
      display: inline-block;
      padding: 12px 24px;
      margin: 10px;
      font-size: 1.1rem;
      color: #000;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-weight: bold;
      box-shadow: 0 0 16px #00ffff, 0 0 24px #a259ff99;
    }
    .btn:hover {
      transform: scale(1.08);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    /* å¹³æ¿å°ºå¯¸ */
    @media (max-width: 768px) {
      .container { 
        padding: 20px; 
        margin: 20px auto;
      }
      h1 { font-size: 2rem; }
      #levelSelectArea { 
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
        gap: 15px; 
      }
      .level-card { 
        width: 100px; 
        height: 150px; 
        font-size: 0.95em; 
      }
      .grid#matchGridWrap { 
        padding: 20px 10px 15px 10px; 
        border-radius: 16px; 
      }
      .match-card { 
        width: 90px; 
        height: 130px; 
        font-size: 1em; 
        border-radius: 12px; 
      }
      #matchGrid { 
        gap: 15px; 
        grid-template-columns: repeat(4, 1fr); 
        grid-template-rows: repeat(3, 1fr); 
      }
    }
    
    /* æ‰‹æ©Ÿå°ºå¯¸ */
    @media (max-width: 480px) {
      .container { 
        padding: 15px; 
        margin: 10px auto;
        width: 98%;
      }
      h1 { font-size: 1.6rem; }
      #levelSelectArea { 
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
        gap: 10px; 
      }
      .level-card { 
        width: 80px; 
        height: 120px; 
        font-size: 0.85em; 
      }
      .grid#matchGridWrap { 
        padding: 15px 5px 10px 5px; 
        border-radius: 12px; 
      }
      .match-card { 
        width: 70px; 
        height: 100px; 
        font-size: 0.9em; 
        border-radius: 10px; 
      }
      .back-home-btn {
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        font-size: 0.9em;
      }
    }
    
    /* å°æ‰‹æ©Ÿå°ºå¯¸ */
    @media (max-width: 360px) {
      .container { 
        padding: 10px; 
        margin: 5px auto;
      }
      h1 { font-size: 1.4rem; }
      #levelSelectArea { 
        grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); 
        gap: 8px; 
      }
      .level-card { 
        width: 70px; 
        height: 105px; 
        font-size: 0.8em; 
      }
      .grid#matchGridWrap { 
        padding: 10px 3px 8px 3px; 
        border-radius: 10px; 
      }
      .match-card { 
        width: 60px; 
        height: 85px; 
        font-size: 0.8em; 
        border-radius: 8px; 
      }
      #matchGrid { 
        gap: 6px; 
        grid-template-columns: repeat(4, 1fr); 
        grid-template-rows: repeat(3, 1fr); 
      }
      .back-home-btn {
        top: 8px;
        right: 8px;
        padding: 6px 12px;
        font-size: 0.8em;
      }
      .btn {
        padding: 10px 18px;
        font-size: 0.95rem;
      }
      .review-word-list {
        gap: 8px 16px !important;
      }
    }
    
    /* è¤‡ç¿’å€åŸŸéŸ¿æ‡‰å¼è¨­è¨ˆ */
    .review-word-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px 32px;
      margin: 24px 0 18px 0;
    }
    
    @media (max-width: 768px) {
      .review-word-list {
        gap: 12px 24px !important;
      }
    }
    
    @media (max-width: 480px) {
      .review-word-list {
        gap: 10px 16px !important;
      }
    }
    .level-progress-bar {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg,#181818,#0a0a0a);
      border-radius: 16px;
      box-shadow: 0 0 16px #00ffff44, 0 0 32px #a259ff22 inset;
      border: 2px solid #00ffff;
      position: relative;
    }
    .level-progress-bg {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 16px;
      background: radial-gradient(circle at 60% 30%, #00ffff33 0%, #000 100%);
      z-index: 0;
    }
    .level-progress-label {
      position: relative;
      z-index: 1;
      color: #00ffff;
      font-size: 1.2em;
      font-weight: bold;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      letter-spacing: 2px;
      margin-top: 12px;
    }
    .level-progress-zh {
      position: relative;
      z-index: 1;
      color: #ffd700;
      font-size: 1.1em;
      font-family: 'Microsoft JhengHei', 'Noto Sans TC', 'PingFang TC', 'Heiti TC', sans-serif;
      font-weight: bold;
      margin-top: 2px;
      letter-spacing: 1px;
      text-shadow: 0 0 8px #ffd700, 0 0 16px #fff2;
    }
    `;
    document.head.appendChild(style);

    showLevelSelect();
    // å»¶é²ä¸€é»æ™‚é–“å†åˆå§‹åŒ–èªéŸ³ï¼Œç¢ºä¿ SoundSystem å·²è¼‰å…¥
    setTimeout(initializeSpeechSynthesis, 100);
    </script>
</body>
</html> 